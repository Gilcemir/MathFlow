---
status: pending
parallelizable: true
blocked_by: ["1.0"]
---

<task_context>
<domain>infra/docker</domain>
<type>implementation</type>
<scope>containerization</scope>
<complexity>high</complexity>
<dependencies>docker,nodejs</dependencies>
<unblocks>5.0</unblocks>
</task_context>

# Tarefa 3.0: Criar Dockerfile da Aplicação

## Visão Geral

Criar Dockerfile multi-stage otimizado para a aplicação ASP.NET Core 9.0 com suporte a Node.js para execução dos scripts de conversão OMML → MathML. O desafio principal é garantir que Node.js e node_modules estejam disponíveis em runtime.

## Contexto da Tech Spec

**Referência:** Seção 4.1 da Tech Spec - Dockerfile da Aplicação

**Desafios:**
1. Node.js necessário em runtime (não apenas build)
2. `node_modules` deve ser copiado para imagem final
3. Scripts JavaScript devem estar disponíveis
4. Imagem final deve ser < 500MB

**Estratégia:** Multi-stage build (SDK → Runtime) com Node.js em ambos os stages

## Requisitos

- [ ] Dockerfile multi-stage (build + runtime)
- [ ] Node.js 18+ instalado em ambos os stages
- [ ] `node_modules` copiado corretamente
- [ ] Scripts JavaScript acessíveis
- [ ] Imagem final < 500MB
- [ ] `.dockerignore` configurado
- [ ] Build bem-sucedido
- [ ] Container executa aplicação corretamente

## Subtarefas

### 5.1: Criar Dockerfile

**Ação:** Criar Dockerfile multi-stage

**Arquivo:** `docker/app/Dockerfile`

**Conteúdo:**
```dockerfile
# ============================================
# Stage 1: Build
# ============================================
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /src

# Instalar Node.js no build stage
RUN apt-get update && apt-get install -y curl && \
    curl -fsSL https://deb.nodesource.com/setup_18.x | bash - && \
    apt-get install -y nodejs && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Copiar .csproj e restaurar dependências
COPY ["src/MathFlow/MathFlow.csproj", "MathFlow/"]
RUN dotnet restore "MathFlow/MathFlow.csproj"

# Copiar código-fonte
COPY src/MathFlow/ MathFlow/

# Instalar dependências Node.js
WORKDIR /src/MathFlow/Infrastructure/Converters/Scripts
RUN npm install

# Build da aplicação
WORKDIR /src/MathFlow
RUN dotnet build "MathFlow.csproj" -c Release -o /app/build

# Publish
RUN dotnet publish "MathFlow.csproj" -c Release -o /app/publish /p:UseAppHost=false

# ============================================
# Stage 2: Runtime
# ============================================
FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS runtime
WORKDIR /app

# Instalar Node.js no runtime stage
RUN apt-get update && apt-get install -y curl && \
    curl -fsSL https://deb.nodesource.com/setup_18.x | bash - && \
    apt-get install -y nodejs && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Copiar aplicação publicada
COPY --from=build /app/publish .

# Expor porta
EXPOSE 5124

# Variáveis de ambiente padrão
ENV ASPNETCORE_URLS=http://+:5124
ENV ASPNETCORE_ENVIRONMENT=Production

# Entry point
ENTRYPOINT ["dotnet", "MathFlow.dll"]
```

**Validação:**
- [ ] Arquivo criado em `docker/app/Dockerfile`
- [ ] Sintaxe correta

### 5.2: Criar .dockerignore

**Ação:** Criar `.dockerignore` para otimizar build

**Arquivo:** `docker/app/.dockerignore`

**Conteúdo:**
```
# Build artifacts
**/bin/
**/obj/
**/out/

# Node
**/node_modules/
**/package-lock.json

# IDE
**/.vs/
**/.vscode/
**/.idea/
**/*.user
**/*.suo

# Git
**/.git/
**/.gitignore
**/.gitattributes

# Logs
**/logs/
**/*.log

# OS
**/.DS_Store
**/Thumbs.db

# Docker
**/Dockerfile
**/docker-compose*.yml

# Docs
**/README.md
**/docs/

# Tests
**/tests/
```

**Validação:**
- [ ] Arquivo criado em `docker/app/.dockerignore`
- [ ] Padrões corretos

### 5.3: Testar Build da Imagem

**Ação:** Construir imagem Docker

**Comandos:**
```bash
cd /Users/educbank/Documents/personal_workspace/MathFlow

# Build da imagem
docker build -f docker/app/Dockerfile -t mathflow:latest .

# Verificar tamanho
docker images mathflow:latest
```

**Validação:**
- [ ] Build completa sem erros
- [ ] Imagem criada
- [ ] Tamanho < 500MB (ideal < 400MB)

### 5.4: Testar Execução do Container

**Ação:** Executar container e verificar funcionamento

**Comandos:**
```bash
# Executar container
docker run -d \
  --name mathflow-test \
  -p 5124:5124 \
  -e ASPNETCORE_ENVIRONMENT=Development \
  mathflow:latest

# Verificar logs
docker logs mathflow-test

# Testar endpoint
curl http://localhost:5124

# Parar e remover
docker stop mathflow-test
docker rm mathflow-test
```

**Validação:**
- [ ] Container inicia sem erros
- [ ] Aplicação responde na porta 5124
- [ ] Logs não mostram erros críticos
- [ ] Node.js acessível dentro do container

### 5.5: Testar Scripts Node.js no Container

**Ação:** Verificar que scripts de conversão funcionam

**Comandos:**
```bash
# Executar container
docker run -d \
  --name mathflow-test \
  -p 5124:5124 \
  mathflow:latest

# Entrar no container
docker exec -it mathflow-test bash

# Dentro do container
node --version
ls -la Infrastructure/Converters/Scripts/
ls -la Infrastructure/Converters/Scripts/node_modules/

# Sair
exit

# Limpar
docker stop mathflow-test
docker rm mathflow-test
```

**Validação:**
- [ ] Node.js instalado e funcional
- [ ] Scripts JavaScript presentes
- [ ] `node_modules` presente
- [ ] Conversão funciona (teste manual via UI)

### 5.6: Otimizar Imagem (Opcional)

**Ação:** Se imagem > 500MB, otimizar

**Estratégias:**
- Usar `alpine` base images (se compatível)
- Remover arquivos desnecessários
- Usar `--no-cache` em apt-get
- Combinar comandos RUN

**Validação:**
- [ ] Imagem < 500MB
- [ ] Funcionalidade preservada

## Sequenciamento

- **Bloqueado por:** 1.0 (Reestruturação)
- **Desbloqueia:** 5.0 (docker-compose completo)
- **Paralelizável:** Sim (com tarefas 2.0, 4.0)

## Critérios de Aceitação

✅ **Dockerfile criado:**
- Multi-stage build funcional
- Node.js em ambos os stages
- Cópia correta de arquivos

✅ **Build bem-sucedido:**
- `docker build` sem erros
- Imagem < 500MB

✅ **Container funcional:**
- Aplicação inicia corretamente
- Porta 5124 acessível
- Scripts Node.js funcionam
- Conversão de documentos funciona

✅ **Otimização:**
- `.dockerignore` configurado
- Layers otimizados

## Riscos e Mitigações

| Risco | Probabilidade | Impacto | Mitigação |
|-------|---------------|---------|-----------|
| node_modules não copiado | Média | Alto | Verificar COPY no Dockerfile |
| Imagem muito grande | Média | Médio | Usar alpine, limpar cache apt |
| Scripts não encontrados | Média | Alto | Testar caminhos dentro do container |
| Permissões de arquivo | Baixa | Médio | Usar WORKDIR correto |

## Notas de Implementação

- **Tempo estimado:** 3-4 horas
- **Complexidade:** Alta
- **Dependências:** Docker instalado
- **Teste crítico:** Conversão de documentos deve funcionar no container

## Referências

- [.NET Docker Best Practices](https://docs.microsoft.com/en-us/dotnet/core/docker/build-container)
- [Multi-stage Builds](https://docs.docker.com/build/building/multi-stage/)
- Tech Spec Seção 4.1

## Checklist Final

- [ ] Dockerfile criado e testado
- [ ] .dockerignore configurado
- [ ] Build bem-sucedido
- [ ] Imagem < 500MB
- [ ] Container executa aplicação
- [ ] Node.js funcional no container
- [ ] Scripts de conversão funcionam
- [ ] Tarefa marcada como completa no `tasks.md`
