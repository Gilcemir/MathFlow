---
status: completed
parallelizable: true
blocked_by: ["1.0"]
completed_date: 2025-10-26
---

<task_context>
<domain>infra/observability</domain>
<type>implementation</type>
<scope>configuration</scope>
<complexity>medium-high</complexity>
<dependencies>docker</dependencies>
<unblocks>5.0</unblocks>
</task_context>

# Tarefa 2.0: Configurações de Observabilidade + docker-compose.infra

## Visão Geral

Criar todos os arquivos de configuração necessários para a stack de observabilidade: OTEL Collector, Loki, Prometheus e Grafana. Inclui Dockerfiles, arquivos de configuração YAML e o docker-compose.infra.yml para orquestrar a infraestrutura isoladamente.

## Contexto da Tech Spec

**Referência:** Seções 4.2, 4.3, 4.4, 4.5 da Tech Spec

**Componentes:**
1. **OTEL Collector:** Recebe telemetria via OTLP, roteia para Loki/Prometheus
2. **Loki:** Armazena logs
3. **Prometheus:** Coleta métricas
4. **Grafana:** Visualização com datasources pré-configurados

## Requisitos

- [ ] Configuração OTEL Collector (receivers, processors, exporters)
- [ ] Configuração Loki (storage, retention)
- [ ] Configuração Prometheus (scrape configs)
- [ ] Configuração Grafana (datasources)
- [ ] Dockerfiles para Loki, Prometheus, Grafana
- [ ] Todos os arquivos validados sintaticamente

## Subtarefas

### 3.1: Configurar OTEL Collector

**Ação:** Criar configuração do OpenTelemetry Collector

**Arquivo:** `docker/infra/otel/otel-collector-config.yaml`

**Conteúdo:**
```yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  batch:
    timeout: 10s
    send_batch_size: 1024

exporters:
  # Logs para Loki
  loki:
    endpoint: http://loki:3100/loki/api/v1/push
    labels:
      resource:
        service.name: "service_name"
      attributes:
        level: "level"
  
  # Métricas para Prometheus (via scraping)
  prometheus:
    endpoint: 0.0.0.0:8889
    namespace: mathflow
  
  # Debug (console)
  logging:
    loglevel: info

service:
  pipelines:
    logs:
      receivers: [otlp]
      processors: [batch]
      exporters: [loki, logging]
    
    traces:
      receivers: [otlp]
      processors: [batch]
      exporters: [logging]
    
    metrics:
      receivers: [otlp]
      processors: [batch]
      exporters: [prometheus, logging]
```

**Validação:**
- [ ] Arquivo criado
- [ ] YAML válido
- [ ] Receivers, processors, exporters configurados

### 3.2: Configurar Loki

**Ação:** Criar configuração e Dockerfile do Loki

**Arquivo 1:** `docker/infra/loki/loki-local-config.yml`

**Conteúdo:**
```yaml
auth_enabled: false

server:
  http_listen_port: 3100

ingester:
  lifecycler:
    address: 127.0.0.1
    ring:
      kvstore:
        store: inmemory
      replication_factor: 1
  chunk_idle_period: 5m
  chunk_retain_period: 30s

schema_config:
  configs:
    - from: 2020-10-24
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h

storage_config:
  boltdb_shipper:
    active_index_directory: /loki/boltdb-shipper-active
    cache_location: /loki/boltdb-shipper-cache
    cache_ttl: 24h
    shared_store: filesystem
  filesystem:
    directory: /loki/chunks

limits_config:
  enforce_metric_name: false
  reject_old_samples: true
  reject_old_samples_max_age: 168h

chunk_store_config:
  max_look_back_period: 0s

table_manager:
  retention_deletes_enabled: true
  retention_period: 168h
```

**Arquivo 2:** `docker/infra/loki/Dockerfile`

**Conteúdo:**
```dockerfile
FROM grafana/loki:latest
COPY loki-local-config.yml /etc/loki/local-config.yaml
```

**Validação:**
- [ ] Arquivos criados
- [ ] YAML válido
- [ ] Dockerfile correto

### 3.3: Configurar Prometheus

**Ação:** Criar configuração e Dockerfile do Prometheus

**Arquivo 1:** `docker/infra/prometheus/prometheus.yml`

**Conteúdo:**
```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # Métricas do OTEL Collector
  - job_name: 'otel-collector'
    scrape_interval: 5s
    static_configs:
      - targets: ['otel-collector:8889']
      - targets: ['otel-collector:8888']
  
  # Métricas do Prometheus (self-monitoring)
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
```

**Arquivo 2:** `docker/infra/prometheus/Dockerfile`

**Conteúdo:**
```dockerfile
FROM prom/prometheus:latest
COPY prometheus.yml /etc/prometheus/prometheus.yml
```

**Validação:**
- [ ] Arquivos criados
- [ ] YAML válido
- [ ] Scrape configs corretos

### 3.4: Configurar Grafana

**Ação:** Criar configuração de datasources e Dockerfile

**Arquivo 1:** `docker/infra/grafana/provisioning/datasources/datasources.yml`

**Conteúdo:**
```yaml
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: true
  
  - name: Loki
    type: loki
    access: proxy
    url: http://loki:3100
    editable: true
```

**Arquivo 2:** `docker/infra/grafana/Dockerfile`

**Conteúdo:**
```dockerfile
FROM grafana/grafana:latest
COPY provisioning /etc/grafana/provisioning
```

**Validação:**
- [ ] Arquivos criados
- [ ] YAML válido
- [ ] Datasources configurados

### 3.5: Validar Sintaxe YAML

**Ação:** Validar todos os arquivos YAML

**Comandos:**
```bash
# Instalar yamllint (se não tiver)
# brew install yamllint  # macOS
# pip install yamllint   # Python

# Validar arquivos
yamllint docker/infra/otel/otel-collector-config.yaml
yamllint docker/infra/loki/loki-local-config.yml
yamllint docker/infra/prometheus/prometheus.yml
yamllint docker/infra/grafana/provisioning/datasources/datasources.yml
```

**Validação:**
- [ ] Todos os YAMLs válidos
- [ ] Nenhum erro de sintaxe

### 3.6: Criar docker-compose.infra.yml

**Ação:** Criar docker-compose para orquestrar apenas a infraestrutura

**Arquivo:** `docker-compose.infra.yml`

**Conteúdo:**
```yaml
version: '3.8'

services:
  otel-collector:
    image: otel/opentelemetry-collector:0.89.0
    container_name: mathflow-otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./docker/infra/otel/otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "8888:8888"   # Prometheus metrics (collector)
      - "8889:8889"   # Prometheus exporter
    networks:
      - mathflow-network

  loki:
    build:
      context: ./docker/infra/loki
      dockerfile: Dockerfile
    container_name: mathflow-loki
    ports:
      - "3100:3100"
    volumes:
      - loki-data:/loki
    networks:
      - mathflow-network

  prometheus:
    build:
      context: ./docker/infra/prometheus
      dockerfile: Dockerfile
    container_name: mathflow-prometheus
    ports:
      - "9090:9090"
    volumes:
      - prometheus-data:/prometheus
    networks:
      - mathflow-network

  grafana:
    build:
      context: ./docker/infra/grafana
      dockerfile: Dockerfile
    container_name: mathflow-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
    volumes:
      - grafana-data:/var/lib/grafana
    networks:
      - mathflow-network
    depends_on:
      - prometheus
      - loki

networks:
  mathflow-network:
    driver: bridge

volumes:
  loki-data:
  prometheus-data:
  grafana-data:
```

**Validação:**
- [ ] Arquivo criado
- [ ] YAML válido
- [ ] Serviços configurados

### 3.7: Testar Stack de Infraestrutura

**Ação:** Subir e testar stack isoladamente

**Comandos:**
```bash
# Subir infraestrutura
docker compose -f docker-compose.infra.yml up -d

# Verificar status
docker ps

# Verificar logs
docker compose -f docker-compose.infra.yml logs

# Acessar serviços
curl http://localhost:3100/ready  # Loki
curl http://localhost:9090/-/ready  # Prometheus
curl http://localhost:3000  # Grafana

# Parar
docker compose -f docker-compose.infra.yml down
```

**Validação:**
- [ ] Todos os containers sobem sem erros
- [ ] Serviços acessíveis nas portas corretas
- [ ] Grafana exibe datasources configurados
- [ ] Prometheus scraping OTEL Collector

## Sequenciamento

- **Bloqueado por:** 1.0 (Reestruturação)
- **Desbloqueia:** 5.0 (docker-compose completo)
- **Paralelizável:** Sim (com tarefas 3.0, 4.0)

## Critérios de Aceitação

✅ **OTEL Collector:**
- `otel-collector-config.yaml` criado
- Receivers, processors, exporters configurados

✅ **Loki:**
- `loki-local-config.yml` criado
- `Dockerfile` criado
- Retenção de 7 dias configurada

✅ **Prometheus:**
- `prometheus.yml` criado
- `Dockerfile` criado
- Scrape do OTEL Collector configurado

✅ **Grafana:**
- `datasources.yml` criado
- `Dockerfile` criado
- Datasources Prometheus e Loki configurados

✅ **docker-compose.infra.yml:**
- Arquivo criado
- Todos os serviços configurados
- Stack sobe sem erros
- Serviços acessíveis

✅ **Qualidade:**
- Todos os YAMLs válidos
- Dockerfiles corretos

## Riscos e Mitigações

| Risco | Probabilidade | Impacto | Mitigação |
|-------|---------------|---------|-----------|
| YAML inválido | Média | Alto | Validar com yamllint |
| Endpoints incorretos | Média | Alto | Usar nomes de serviço Docker |
| Portas conflitantes | Baixa | Médio | Documentar portas usadas |

## Notas de Implementação

- **Tempo estimado:** 4-5 horas
- **Complexidade:** Média-Alta
- **Dependências:** Conhecimento de YAML, Docker, Docker Compose
- **Teste crítico:** Stack de infra deve subir sem erros

## Referências

- [OTEL Collector Config](https://opentelemetry.io/docs/collector/configuration/)
- [Loki Config](https://grafana.com/docs/loki/latest/configuration/)
- [Prometheus Config](https://prometheus.io/docs/prometheus/latest/configuration/configuration/)
- [Grafana Provisioning](https://grafana.com/docs/grafana/latest/administration/provisioning/)

## Checklist Final

- [ ] OTEL Collector configurado
- [ ] Loki configurado
- [ ] Prometheus configurado
- [ ] Grafana configurado
- [ ] Todos os Dockerfiles criados
- [ ] docker-compose.infra.yml criado
- [ ] YAMLs validados
- [ ] Stack de infra testada e funcional
- [ ] Tarefa marcada como completa no `tasks.md`
