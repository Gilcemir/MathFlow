---
status: pending
parallelizable: false
blocked_by: ["2.0", "3.0", "4.0"]
---

<task_context>
<domain>infra/orchestration</domain>
<type>implementation</type>
<scope>docker_compose</scope>
<complexity>medium-high</complexity>
<dependencies>docker,postgresql</dependencies>
<unblocks>6.0</unblocks>
</task_context>

# Tarefa 5.0: Docker-compose Completo + PostgreSQL + Configs

## Visão Geral

Criar `docker-compose.yml` completo que orquestra aplicação + infraestrutura, adicionar serviço PostgreSQL, e criar arquivos de configuração (`.env.example`, `appsettings.json`). Esta é a tarefa de convergência que integra tudo.

## Contexto da Tech Spec

**Referência:** Seções 5 e 6 da Tech Spec

**Componentes:**
1. **docker-compose.yml:** Orquestra app + OTEL + Loki + Prometheus + Grafana + PostgreSQL
2. **PostgreSQL:** Banco de dados (preparação futura)
3. **.env.example:** Template de variáveis de ambiente
4. **appsettings.json:** Configurações da aplicação

## Requisitos

- [ ] Criar `docker-compose.yml` completo
- [ ] Adicionar serviço PostgreSQL
- [ ] Configurar dependências entre serviços
- [ ] Configurar volumes persistentes
- [ ] Criar `.env.example`
- [ ] Atualizar `appsettings.json`
- [ ] Atualizar `appsettings.Development.json`
- [ ] Testar build completo
- [ ] Testar startup de toda a stack

## Subtarefas

### 5.1: Criar docker-compose.yml

**Ação:** Criar docker-compose completo

**Arquivo:** `docker-compose.yml`

**Conteúdo:**
```yaml
version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: docker/app/Dockerfile
    container_name: mathflow-app
    ports:
      - "5124:5124"
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - Otlp__Endpoint=http://otel-collector:4317
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=${POSTGRES_DB};Username=${POSTGRES_USER};Password=${POSTGRES_PASSWORD}
    depends_on:
      - postgres
      - otel-collector
    networks:
      - mathflow-network

  otel-collector:
    image: otel/opentelemetry-collector:0.89.0
    container_name: mathflow-otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./docker/infra/otel/otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "8888:8888"   # Prometheus metrics (collector)
      - "8889:8889"   # Prometheus exporter
    networks:
      - mathflow-network

  loki:
    build:
      context: ./docker/infra/loki
      dockerfile: Dockerfile
    container_name: mathflow-loki
    ports:
      - "3100:3100"
    volumes:
      - loki-data:/loki
    networks:
      - mathflow-network

  prometheus:
    build:
      context: ./docker/infra/prometheus
      dockerfile: Dockerfile
    container_name: mathflow-prometheus
    ports:
      - "9090:9090"
    volumes:
      - prometheus-data:/prometheus
    networks:
      - mathflow-network

  grafana:
    build:
      context: ./docker/infra/grafana
      dockerfile: Dockerfile
    container_name: mathflow-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
    volumes:
      - grafana-data:/var/lib/grafana
    networks:
      - mathflow-network
    depends_on:
      - prometheus
      - loki

  postgres:
    image: postgres:16
    container_name: mathflow-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-mathflow}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-mathflow_password_change_me}
      - POSTGRES_DB=${POSTGRES_DB:-mathflow_db}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - mathflow-network

networks:
  mathflow-network:
    driver: bridge

volumes:
  loki-data:
  prometheus-data:
  grafana-data:
  postgres-data:
```

**Validação:**
- [ ] Arquivo criado
- [ ] YAML válido
- [ ] Todos os serviços configurados

### 5.2: Criar .env.example

**Ação:** Criar template de variáveis de ambiente

**Arquivo:** `.env.example`

**Conteúdo:**
```env
# Application
ASPNETCORE_ENVIRONMENT=Development

# PostgreSQL
POSTGRES_USER=mathflow
POSTGRES_PASSWORD=mathflow_password_change_me
POSTGRES_DB=mathflow_db

# Grafana
GRAFANA_USER=admin
GRAFANA_PASSWORD=admin
```

**Validação:**
- [ ] Arquivo criado
- [ ] Todas as variáveis documentadas

### 5.3: Atualizar appsettings.json

**Ação:** Adicionar configurações de OTLP e PostgreSQL

**Arquivo:** `src/MathFlow/appsettings.json`

**Conteúdo:**
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "Otlp": {
    "Endpoint": "http://localhost:4317"
  },
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=mathflow_db;Username=mathflow;Password=mathflow_password_change_me"
  }
}
```

**Validação:**
- [ ] Arquivo atualizado
- [ ] JSON válido
- [ ] Endpoint OTLP configurado
- [ ] Connection string configurada

### 5.4: Atualizar appsettings.Development.json

**Ação:** Configurar settings para desenvolvimento

**Arquivo:** `src/MathFlow/appsettings.Development.json`

**Conteúdo:**
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "Microsoft.AspNetCore": "Information"
    }
  },
  "Otlp": {
    "Endpoint": "http://localhost:4317"
  }
}
```

**Validação:**
- [ ] Arquivo atualizado
- [ ] JSON válido

### 5.5: Testar Build Completo

**Ação:** Construir todas as imagens

**Comandos:**
```bash
# Build de todas as imagens
docker compose build

# Verificar imagens criadas
docker images | grep mathflow
```

**Validação:**
- [ ] Build sem erros
- [ ] Todas as imagens criadas
- [ ] Tamanho das imagens aceitável

### 5.6: Testar Startup da Stack

**Ação:** Subir stack completa e verificar

**Comandos:**
```bash
# Subir stack
docker compose up -d

# Verificar status
docker ps

# Verificar logs
docker compose logs app
docker compose logs otel-collector
docker compose logs postgres

# Acessar serviços
curl http://localhost:5124
curl http://localhost:3000  # Grafana
curl http://localhost:9090  # Prometheus

# Parar
docker compose down
```

**Validação:**
- [ ] Todos os containers sobem sem erros
- [ ] Aplicação acessível em http://localhost:5124
- [ ] Grafana acessível em http://localhost:3000
- [ ] Prometheus acessível em http://localhost:9090
- [ ] PostgreSQL acessível (porta 5432)
- [ ] Logs não mostram erros críticos

### 5.7: Testar Conectividade PostgreSQL

**Ação:** Verificar conexão com PostgreSQL

**Comandos:**
```bash
# Conectar ao PostgreSQL
docker exec -it mathflow-postgres psql -U mathflow -d mathflow_db

# Dentro do psql
\l  # Listar databases
\q  # Sair
```

**Validação:**
- [ ] Conexão bem-sucedida
- [ ] Database criado

## Sequenciamento

- **Bloqueado por:** 2.0 (Infra), 3.0 (Dockerfile), 4.0 (OpenTelemetry)
- **Desbloqueia:** 6.0 (Makefile + README + Testes)
- **Paralelizável:** Não (ponto de convergência)

## Critérios de Aceitação

✅ **docker-compose.yml:**
- Arquivo criado
- Todos os serviços configurados
- Dependências corretas

✅ **PostgreSQL:**
- Serviço configurado
- Volumes persistentes
- Connection string configurada

✅ **Arquivos de configuração:**
- `.env.example` criado
- `appsettings.json` atualizado
- `appsettings.Development.json` atualizado

✅ **Stack funcional:**
- Build completo sem erros
- Todos os containers sobem
- Aplicação acessível
- Serviços de observabilidade acessíveis
- PostgreSQL acessível

## Riscos e Mitigações

| Risco | Probabilidade | Impacto | Mitigação |
|-------|---------------|---------|-----------|
| Dependências incorretas | Média | Alto | Testar ordem de startup |
| Portas conflitantes | Baixa | Médio | Documentar portas usadas |
| Volumes não persistem | Baixa | Médio | Validar configuração de volumes |
| Network issues | Baixa | Alto | Usar mesma rede para todos |

## Notas de Implementação

- **Tempo estimado:** 3-4 horas
- **Complexidade:** Média-Alta
- **Dependências:** Tarefas 2.0, 3.0, 4.0 completas
- **Teste crítico:** Stack completa deve subir sem erros

## Referências

- [Docker Compose](https://docs.docker.com/compose/)
- [PostgreSQL Docker](https://hub.docker.com/_/postgres)
- Tech Spec Seções 5 e 6

## Checklist Final

- [ ] docker-compose.yml criado
- [ ] PostgreSQL configurado
- [ ] .env.example criado
- [ ] appsettings.json atualizado
- [ ] appsettings.Development.json atualizado
- [ ] Build completo testado
- [ ] Stack completa testada
- [ ] Todos os serviços acessíveis
- [ ] Conectividade PostgreSQL validada
- [ ] Tarefa marcada como completa no `tasks.md`
