---
status: pending
parallelizable: false
blocked_by: ["15.0", "18.0"]
---

<task_context>
<domain>testing/infra</domain>
<type>testing</type>
<scope>test_infrastructure</scope>
<complexity>medium</complexity>
<dependencies>testcontainers</dependencies>
<unblocks>20.0</unblocks>
</task_context>

# Tarefa 19.0: Configurar TestContainers

## Visão Geral

Configurar TestContainers para testes de integração com PostgreSQL real, permitindo testes end-to-end confiáveis do fluxo completo de autenticação.

## Requisitos

- [ ] Configurar TestContainers no projeto de testes
- [ ] Criar classe base para testes de integração
- [ ] Configurar WebApplicationFactory customizado
- [ ] Seed de dados de teste
- [ ] Validar setup com teste simples

## Subtarefas

### 19.1: Adicionar Pacotes TestContainers

**Comandos:**
```bash
cd tests/MathFlow.IntegrationTests

dotnet add package Testcontainers.PostgreSql --version 3.10.0
dotnet add package Microsoft.AspNetCore.Mvc.Testing --version 9.0.0
dotnet add package xunit --version 2.9.0
```

### 19.2: Criar IntegrationTestBase

**Arquivo:** `tests/MathFlow.IntegrationTests/Identity/IntegrationTestBase.cs`

```csharp
using DotNet.Testcontainers.Builders;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Mvc.Testing;
using Microsoft.AspNetCore.TestHost;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using MathFlow.Infrastructure.IdentityServer.Data;
using Testcontainers.PostgreSql;

namespace MathFlow.IntegrationTests.Identity;

public class IntegrationTestBase : IAsyncLifetime
{
    private readonly PostgreSqlContainer _dbContainer;
    protected HttpClient Client { get; private set; } = null!;
    protected WebApplicationFactory<Program> Factory { get; private set; } = null!;

    public IntegrationTestBase()
    {
        _dbContainer = new PostgreSqlBuilder()
            .WithImage("postgres:17-alpine")
            .WithDatabase("mathflow_test")
            .WithUsername("test")
            .WithPassword("test")
            .Build();
    }

    public async Task InitializeAsync()
    {
        await _dbContainer.StartAsync();

        Factory = new WebApplicationFactory<Program>()
            .WithWebHostBuilder(builder =>
            {
                builder.ConfigureTestServices(services =>
                {
                    // Remover DbContext existente
                    var descriptor = services.SingleOrDefault(
                        d => d.ServiceType == typeof(DbContextOptions<ApplicationDbContext>));
                    if (descriptor != null)
                    {
                        services.Remove(descriptor);
                    }

                    // Adicionar DbContext com TestContainers
                    services.AddDbContext<ApplicationDbContext>(options =>
                    {
                        options.UseNpgsql(_dbContainer.GetConnectionString());
                    });

                    // Aplicar migrations e seed
                    var sp = services.BuildServiceProvider();
                    using var scope = sp.CreateScope();
                    var db = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();
                    db.Database.Migrate();
                });
            });

        Client = Factory.CreateClient();
    }

    public async Task DisposeAsync()
    {
        await _dbContainer.DisposeAsync();
        Factory?.Dispose();
        Client?.Dispose();
    }

    protected async Task<T> GetService<T>() where T : notnull
    {
        using var scope = Factory.Services.CreateScope();
        return scope.ServiceProvider.GetRequiredService<T>();
    }
}
```

### 19.3: Criar Teste Simples de Validação

**Arquivo:** `tests/MathFlow.IntegrationTests/Identity/SetupTests.cs`

```csharp
using FluentAssertions;
using Microsoft.AspNetCore.Identity;
using MathFlow.Infrastructure.IdentityServer.Models;

namespace MathFlow.IntegrationTests.Identity;

public class SetupTests : IntegrationTestBase
{
    [Fact]
    public async Task Database_ShouldBeAccessible()
    {
        // Arrange & Act
        var response = await Client.GetAsync("/");

        // Assert
        response.Should().NotBeNull();
    }

    [Fact]
    public async Task Roles_ShouldBeSeeded()
    {
        // Arrange
        var roleManager = await GetService<RoleManager<IdentityRole>>();

        // Act & Assert
        (await roleManager.RoleExistsAsync("masterAdmin")).Should().BeTrue();
        (await roleManager.RoleExistsAsync("admin")).Should().BeTrue();
        (await roleManager.RoleExistsAsync("premium")).Should().BeTrue();
        (await roleManager.RoleExistsAsync("normal")).Should().BeTrue();
    }

    [Fact]
    public async Task MasterAdmin_ShouldBeSeeded()
    {
        // Arrange
        var userManager = await GetService<UserManager<ApplicationUser>>();

        // Act
        var masterAdmin = await userManager.FindByEmailAsync("admin@mathflow.local");

        // Assert
        masterAdmin.Should().NotBeNull();
        masterAdmin!.TwoFactorEnabled.Should().BeFalse();
        (await userManager.IsInRoleAsync(masterAdmin, "masterAdmin")).Should().BeTrue();
    }
}
```

## Sequenciamento

- **Bloqueado por:** 15.0 (Logout), 18.0 (Apply Policies)
- **Desbloqueia:** 20.0 (Testes de Integração)
- **Paralelizável com:** Nenhum (setup necessário)

## Critérios de Aceitação

- [ ] TestContainers configurado
- [ ] IntegrationTestBase criado
- [ ] WebApplicationFactory customizado
- [ ] Testes de setup passando
- [ ] PostgreSQL iniciando e parando corretamente

## Estimativa

**Tempo estimado:** 1 dia (8 horas)
