---
status: completed
parallelizable: true
blocked_by: ["9.0"]
---

<task_context>
<domain>frontend/pages</domain>
<type>implementation</type>
<scope>user_management</scope>
<complexity>medium</complexity>
<dependencies>user_service</dependencies>
<unblocks>18.0</unblocks>
</task_context>

# Tarefa 16.0: Criar Páginas de Manage

## Visão Geral

Implementar páginas para usuários autenticados gerenciarem suas contas: perfil, troca de senha, e configuração de 2FA.

## Requisitos

- [ ] Criar Identity/Manage/Index.cshtml (perfil)
- [ ] Criar Identity/Manage/ChangePassword.cshtml
- [ ] Criar Identity/Manage/TwoFactorAuthentication.cshtml
- [ ] Aplicar policy `AuthenticatedUser`
- [ ] Integração com UserService

## Páginas a Implementar

### 16.1: Manage/Index (Perfil)

**Arquivo:** `src/MathFlow/Pages/Identity/Manage/Index.cshtml.cs`

```csharp
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using MathFlow.Infrastructure.IdentityServer.Models;
using MathFlow.Infrastructure.IdentityServer.Configuration;

namespace MathFlow.Pages.Identity.Manage;

[Authorize(Policy = AuthorizationPolicies.AuthenticatedUser)]
public class IndexModel : PageModel
{
    private readonly UserManager<ApplicationUser> _userManager;

    public IndexModel(UserManager<ApplicationUser> userManager)
    {
        _userManager = userManager;
    }

    public string? Username { get; set; }
    public string? Email { get; set; }
    public bool EmailConfirmed { get; set; }
    public bool TwoFactorEnabled { get; set; }
    public IList<string>? Roles { get; set; }

    public async Task<IActionResult> OnGetAsync()
    {
        var user = await _userManager.GetUserAsync(User);
        if (user == null)
        {
            return NotFound();
        }

        Username = user.UserName;
        Email = user.Email;
        EmailConfirmed = user.EmailConfirmed;
        TwoFactorEnabled = user.TwoFactorEnabled;
        Roles = await _userManager.GetRolesAsync(user);

        return Page();
    }
}
```

**View:** Exibir informações do usuário, links para ChangePassword e TwoFactorAuthentication.

### 16.2: Manage/ChangePassword

**Arquivo:** `src/MathFlow/Pages/Identity/Manage/ChangePassword.cshtml.cs`

```csharp
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using MathFlow.Infrastructure.IdentityServer.Models;
using MathFlow.Infrastructure.IdentityServer.Configuration;
using System.ComponentModel.DataAnnotations;

namespace MathFlow.Pages.Identity.Manage;

[Authorize(Policy = AuthorizationPolicies.AuthenticatedUser)]
public class ChangePasswordModel : PageModel
{
    private readonly UserManager<ApplicationUser> _userManager;
    private readonly SignInManager<ApplicationUser> _signInManager;

    public ChangePasswordModel(
        UserManager<ApplicationUser> userManager,
        SignInManager<ApplicationUser> signInManager)
    {
        _userManager = userManager;
        _signInManager = signInManager;
    }

    [BindProperty]
    public InputModel Input { get; set; } = new();

    public class InputModel
    {
        [Required]
        [DataType(DataType.Password)]
        [Display(Name = "Current password")]
        public string OldPassword { get; set; } = string.Empty;

        [Required]
        [StringLength(100, MinimumLength = 8)]
        [DataType(DataType.Password)]
        [Display(Name = "New password")]
        public string NewPassword { get; set; } = string.Empty;

        [DataType(DataType.Password)]
        [Display(Name = "Confirm new password")]
        [Compare("NewPassword")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    public void OnGet()
    {
    }

    public async Task<IActionResult> OnPostAsync()
    {
        if (!ModelState.IsValid)
        {
            return Page();
        }

        var user = await _userManager.GetUserAsync(User);
        if (user == null)
        {
            return NotFound();
        }

        var result = await _userManager.ChangePasswordAsync(user, Input.OldPassword, Input.NewPassword);
        if (result.Succeeded)
        {
            await _signInManager.RefreshSignInAsync(user);
            TempData["StatusMessage"] = "Password changed successfully.";
            return RedirectToPage();
        }

        foreach (var error in result.Errors)
        {
            ModelState.AddModelError(string.Empty, error.Description);
        }

        return Page();
    }
}
```

### 16.3: Manage/TwoFactorAuthentication

**Arquivo:** `src/MathFlow/Pages/Identity/Manage/TwoFactorAuthentication.cshtml.cs`

```csharp
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using MathFlow.Infrastructure.IdentityServer.Models;
using MathFlow.Infrastructure.IdentityServer.Configuration;

namespace MathFlow.Pages.Identity.Manage;

[Authorize(Policy = AuthorizationPolicies.AuthenticatedUser)]
public class TwoFactorAuthenticationModel : PageModel
{
    private readonly UserManager<ApplicationUser> _userManager;

    public TwoFactorAuthenticationModel(UserManager<ApplicationUser> userManager)
    {
        _userManager = userManager;
    }

    public bool TwoFactorEnabled { get; set; }
    public bool IsMasterAdmin { get; set; }

    public async Task<IActionResult> OnGetAsync()
    {
        var user = await _userManager.GetUserAsync(User);
        if (user == null)
        {
            return NotFound();
        }

        TwoFactorEnabled = user.TwoFactorEnabled;
        IsMasterAdmin = await _userManager.IsInRoleAsync(user, "masterAdmin");

        return Page();
    }

    public async Task<IActionResult> OnPostDisableAsync()
    {
        var user = await _userManager.GetUserAsync(User);
        if (user == null)
        {
            return NotFound();
        }

        // Master admin não pode desabilitar 2FA (sempre false)
        if (await _userManager.IsInRoleAsync(user, "masterAdmin"))
        {
            TempData["StatusMessage"] = "Master admin cannot disable 2FA.";
            return RedirectToPage();
        }

        var result = await _userManager.SetTwoFactorEnabledAsync(user, false);
        if (result.Succeeded)
        {
            TempData["StatusMessage"] = "2FA disabled successfully.";
        }

        return RedirectToPage();
    }
}
```

## Sequenciamento

- **Bloqueado por:** 9.0 (UserService)
- **Desbloqueia:** 18.0 (Apply Policies)
- **Paralelizável com:** 12.0-15.0 (Account Pages)

## Critérios de Aceitação

- [ ] 3 páginas Manage implementadas
- [ ] Authorization policies aplicadas
- [ ] Troca de senha funcionando
- [ ] Gerenciamento de 2FA funcionando
- [ ] Master admin não pode desabilitar 2FA

## Estimativa

**Tempo estimado:** 1 dia (8 horas)
