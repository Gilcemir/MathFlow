---
status: pending
parallelizable: true
blocked_by: ["12.0"]
---

<task_context>
<domain>backend/integration</domain>
<type>implementation</type>
<scope>external_auth</scope>
<complexity>medium</complexity>
<dependencies>google_oauth,identity_config</dependencies>
<unblocks>20.0</unblocks>
</task_context>

# Tarefa 14.0: Configurar Google OAuth e ExternalLogin

## Visão Geral

Implementar o callback handler para Google OAuth, permitindo que usuários façam login usando suas contas Google. Inclui criação automática de conta local se usuário não existir.

## Requisitos

- [ ] Criar ExternalLogin.cshtml e ExternalLogin.cshtml.cs
- [ ] Implementar callback handler
- [ ] Criar conta local se não existir
- [ ] Vincular conta externa a conta local
- [ ] Atribuir role `normal` para novos usuários
- [ ] Redirecionar para 2FA setup se novo usuário

## Subtarefas

### 14.1: Criar ExternalLogin Page Model

**Arquivo:** `src/MathFlow/Pages/Account/ExternalLogin.cshtml.cs`

```csharp
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using MathFlow.Infrastructure.IdentityServer.Models;
using System.Security.Claims;

namespace MathFlow.Pages.Account;

public class ExternalLoginModel : PageModel
{
    private readonly SignInManager<ApplicationUser> _signInManager;
    private readonly UserManager<ApplicationUser> _userManager;
    private readonly ILogger<ExternalLoginModel> _logger;

    public ExternalLoginModel(
        SignInManager<ApplicationUser> signInManager,
        UserManager<ApplicationUser> userManager,
        ILogger<ExternalLoginModel> logger)
    {
        _signInManager = signInManager;
        _userManager = userManager;
        _logger = logger;
    }

    public string? ErrorMessage { get; set; }

    public async Task<IActionResult> OnGetCallbackAsync(string? returnUrl = null, string? remoteError = null)
    {
        returnUrl ??= Url.Content("~/");

        if (remoteError != null)
        {
            ErrorMessage = $"Error from external provider: {remoteError}";
            return RedirectToPage("./Login", new { ReturnUrl = returnUrl });
        }

        var info = await _signInManager.GetExternalLoginInfoAsync();
        if (info == null)
        {
            ErrorMessage = "Error loading external login information.";
            return RedirectToPage("./Login", new { ReturnUrl = returnUrl });
        }

        // Tentar fazer sign in com external login
        var result = await _signInManager.ExternalLoginSignInAsync(
            info.LoginProvider, 
            info.ProviderKey, 
            isPersistent: false, 
            bypassTwoFactor: false);

        if (result.Succeeded)
        {
            _logger.LogInformation("User logged in with {Provider} provider", info.LoginProvider);
            return LocalRedirect(returnUrl);
        }

        if (result.RequiresTwoFactor)
        {
            var email = info.Principal.FindFirstValue(ClaimTypes.Email);
            return RedirectToPage("./TwoFactor", new { email, returnUrl });
        }

        if (result.IsLockedOut)
        {
            return RedirectToPage("./Lockout");
        }

        // Usuário não existe, criar conta
        var email = info.Principal.FindFirstValue(ClaimTypes.Email);
        if (string.IsNullOrEmpty(email))
        {
            ErrorMessage = "Email not provided by external provider.";
            return RedirectToPage("./Login", new { ReturnUrl = returnUrl });
        }

        var user = new ApplicationUser
        {
            UserName = email,
            Email = email,
            EmailConfirmed = true, // Email já confirmado pelo provider
            TwoFactorEnabled = true // Obrigatório
        };

        var createResult = await _userManager.CreateAsync(user);
        if (createResult.Succeeded)
        {
            // Adicionar external login
            createResult = await _userManager.AddLoginAsync(user, info);
            if (createResult.Succeeded)
            {
                // Atribuir role normal
                await _userManager.AddToRoleAsync(user, "normal");

                _logger.LogInformation("User created account using {Provider} provider", info.LoginProvider);

                // Redirecionar para setup de 2FA
                return RedirectToPage("./TwoFactorSetup", new { email, returnUrl });
            }
        }

        foreach (var error in createResult.Errors)
        {
            ModelState.AddModelError(string.Empty, error.Description);
        }

        ErrorMessage = "Failed to create account.";
        return RedirectToPage("./Login", new { ReturnUrl = returnUrl });
    }
}
```

### 14.2: Criar ExternalLogin View

**Arquivo:** `src/MathFlow/Pages/Account/ExternalLogin.cshtml`

```html
@page
@model ExternalLoginModel
@{
    ViewData["Title"] = "External Login";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Processing external login...</p>
                </div>
            </div>
        </div>
    </div>
</div>
```

### 14.3: Configurar Google OAuth Credentials

**Ação:** Documentar processo de obtenção de credenciais

**Arquivo:** `docs/google-oauth-setup.md`

```markdown
# Google OAuth Setup

## 1. Criar Projeto no Google Cloud Console

1. Acesse https://console.cloud.google.com/
2. Crie novo projeto "MathFlow"
3. Habilite Google+ API

## 2. Configurar OAuth Consent Screen

1. OAuth consent screen → External
2. App name: MathFlow
3. User support email: seu email
4. Developer contact: seu email

## 3. Criar Credenciais

1. Credentials → Create Credentials → OAuth client ID
2. Application type: Web application
3. Name: MathFlow Web Client
4. Authorized redirect URIs:
   - http://localhost:5124/signin-google (dev)
   - https://mathflow.com/signin-google (prod)

## 4. Configurar appsettings

```json
{
  "Authentication": {
    "Google": {
      "ClientId": "YOUR_CLIENT_ID.apps.googleusercontent.com",
      "ClientSecret": "YOUR_CLIENT_SECRET"
    }
  }
}
```

## 5. Variáveis de Ambiente (Produção)

```bash
export GOOGLE_CLIENT_ID="..."
export GOOGLE_CLIENT_SECRET="..."
```
```

## Sequenciamento

- **Bloqueado por:** 12.0 (Login e Register Pages)
- **Desbloqueia:** 20.0 (Testes de Integração)
- **Paralelizável com:** 13.0 (TwoFactor), 15.0 (Logout)

## Critérios de Aceitação

- [ ] ExternalLogin callback implementado
- [ ] Criação automática de conta para novos usuários
- [ ] Role `normal` atribuída
- [ ] Redirecionamento para 2FA setup
- [ ] Tratamento de erros
- [ ] Documentação de setup

## Estimativa

**Tempo estimado:** 1 dia (8 horas)

## Referências

- [Google OAuth Setup](https://developers.google.com/identity/protocols/oauth2)
- [External Authentication in ASP.NET Core](https://learn.microsoft.com/en-us/aspnet/core/security/authentication/social/)
