---
status: completed
parallelizable: false
blocked_by: ["3.0"]
---

<task_context>
<domain>backend/data</domain>
<type>implementation</type>
<scope>database</scope>
<complexity>low</complexity>
<dependencies>ef_core,postgresql,application_db_context</dependencies>
<unblocks>5.0</unblocks>
</task_context>

# Tarefa 4.0: Criar e Aplicar Migration Inicial

## Visão Geral

Criar a migration inicial do Entity Framework Core para gerar o schema de Identity no PostgreSQL. Esta tarefa estabelece a estrutura de banco de dados necessária para autenticação e autorização, criando todas as tabelas customizadas definidas no `ApplicationDbContext`.

## Contexto da Tech Spec

**Referência:** Seção 7 da Tech Spec - Migrations

- Usar EF Core Migrations para versionamento de schema
- Migrations armazenadas em `Infrastructure/IdentityServer/Data/Migrations/`
- Aplicar migrations automaticamente no startup (desenvolvimento) ou via script (produção)
- Validar schema criado no PostgreSQL

## Requisitos

- [ ] Criar migration inicial com nome `InitialIdentity`
- [ ] Validar migration gerada (tabelas, índices, constraints)
- [ ] Aplicar migration no banco de dados local
- [ ] Verificar tabelas criadas no PostgreSQL
- [ ] Documentar processo de migration
- [ ] Preparar script SQL para produção (opcional)

## Subtarefas

### 4.1: Configurar Connection String

**Ação:** Garantir que connection string está configurada corretamente

**Arquivo:** `src/MathFlow/appsettings.Development.json`

**Validar/Adicionar:**
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=mathflow_dev;Username=mathflow;Password=mathflow_dev_password"
  }
}
```

**Comandos:**
```bash
# Verificar se PostgreSQL está rodando
docker ps | grep postgres

# Se não estiver rodando, iniciar via docker-compose
cd /Users/educbank/Documents/personal_workspace/MathFlow
make docker-infra-up
```

**Validação:**
- [ ] Connection string configurada em `appsettings.Development.json`
- [ ] PostgreSQL rodando no Docker
- [ ] Porta 5432 acessível
- [ ] Database `mathflow_dev` existe ou será criada

### 4.2: Instalar EF Core Tools (se necessário)

**Ação:** Garantir que EF Core CLI tools estão instaladas

**Comandos:**
```bash
# Verificar se dotnet-ef está instalado
dotnet ef --version

# Se não estiver instalado, instalar globalmente
dotnet tool install --global dotnet-ef --version 9.0.0

# Ou atualizar se versão antiga
dotnet tool update --global dotnet-ef --version 9.0.0
```

**Validação:**
- [ ] `dotnet ef` comando disponível
- [ ] Versão 9.0.0 ou superior instalada

### 4.3: Criar Migration Inicial

**Ação:** Gerar migration com todas as tabelas de Identity

**Comandos:**
```bash
cd src/MathFlow

dotnet ef migrations add InitialIdentity \
  --context ApplicationDbContext \
  --output-dir Infrastructure/IdentityServer/Data/Migrations
```

**Saída esperada:**
```
Build started...
Build succeeded.
Done. To undo this action, use 'ef migrations remove'
```

**Validação:**
- [ ] Migration criada sem erros
- [ ] Arquivos gerados em `Infrastructure/IdentityServer/Data/Migrations/`:
  - `<timestamp>_InitialIdentity.cs`
  - `<timestamp>_InitialIdentity.Designer.cs`
  - `ApplicationDbContextModelSnapshot.cs`

### 4.4: Validar Migration Gerada

**Ação:** Revisar código da migration para garantir que todas as tabelas estão corretas

**Arquivo:** `Infrastructure/IdentityServer/Data/Migrations/<timestamp>_InitialIdentity.cs`

**Verificar método `Up()`:**
```csharp
protected override void Up(MigrationBuilder migrationBuilder)
{
    migrationBuilder.CreateTable(
        name: "Roles",  // Sem prefixo AspNet
        // ...
    );

    migrationBuilder.CreateTable(
        name: "Users",  // Sem prefixo AspNet
        // ...
    );

    migrationBuilder.CreateTable(
        name: "UserRoles",
        // ...
    );

    // ... outras tabelas
}
```

**Validação:**
- [ ] Tabela `Users` criada (não `AspNetUsers`)
- [ ] Tabela `Roles` criada (não `AspNetRoles`)
- [ ] Tabela `UserRoles` criada
- [ ] Tabela `UserClaims` criada
- [ ] Tabela `UserLogins` criada
- [ ] Tabela `RoleClaims` criada
- [ ] Tabela `UserTokens` criada
- [ ] Índices criados corretamente
- [ ] Foreign keys configuradas

### 4.5: Aplicar Migration

**Ação:** Executar migration para criar schema no banco de dados

**Comandos:**
```bash
cd src/MathFlow

# Aplicar migration
dotnet ef database update --context ApplicationDbContext

# Verificar status
dotnet ef migrations list --context ApplicationDbContext
```

**Saída esperada:**
```
Build started...
Build succeeded.
Applying migration '<timestamp>_InitialIdentity'.
Done.
```

**Validação:**
- [ ] Migration aplicada sem erros
- [ ] Mensagem "Done" exibida
- [ ] Migration listada como aplicada

### 4.6: Verificar Tabelas no PostgreSQL

**Ação:** Conectar ao PostgreSQL e validar schema criado

**Comandos:**
```bash
# Conectar ao PostgreSQL via Docker
docker exec -it mathflow-postgres psql -U mathflow -d mathflow_dev

# Dentro do psql, listar tabelas
\dt

# Verificar estrutura da tabela Users
\d "Users"

# Verificar estrutura da tabela Roles
\d "Roles"

# Sair do psql
\q
```

**Validação:**
- [ ] 7 tabelas criadas: Users, Roles, UserRoles, UserClaims, UserLogins, RoleClaims, UserTokens
- [ ] Tabela `__EFMigrationsHistory` criada (controle de migrations)
- [ ] Colunas corretas em cada tabela
- [ ] Índices criados (ex: IX_Users_Email, IX_Roles_Name)
- [ ] Foreign keys configuradas

### 4.7: Gerar Script SQL (Opcional - Produção)

**Ação:** Gerar script SQL para aplicação manual em produção

**Comandos:**
```bash
cd src/MathFlow

# Gerar script SQL completo
dotnet ef migrations script \
  --context ApplicationDbContext \
  --output Infrastructure/IdentityServer/Data/Migrations/identity-schema.sql

# Gerar script idempotente (pode ser executado múltiplas vezes)
dotnet ef migrations script \
  --context ApplicationDbContext \
  --idempotent \
  --output Infrastructure/IdentityServer/Data/Migrations/identity-schema-idempotent.sql
```

**Validação:**
- [ ] Arquivo `identity-schema.sql` gerado
- [ ] Arquivo `identity-schema-idempotent.sql` gerado
- [ ] Scripts contêm CREATE TABLE para todas as 7 tabelas
- [ ] Scripts incluem verificações de existência (idempotent)

### 4.8: Documentar Processo de Migration

**Ação:** Criar README explicando como gerenciar migrations

**Arquivo:** `src/MathFlow/Infrastructure/IdentityServer/Data/Migrations/README.md`

**Conteúdo:**
```markdown
# Identity Migrations

Este diretório contém as migrations do Entity Framework Core para o schema de Identity.

## Comandos Úteis

### Criar Nova Migration
```bash
cd src/MathFlow
dotnet ef migrations add <NomeDaMigration> \
  --context ApplicationDbContext \
  --output-dir Infrastructure/IdentityServer/Data/Migrations
```

### Aplicar Migrations
```bash
# Desenvolvimento (automático no startup)
dotnet run

# Manual
dotnet ef database update --context ApplicationDbContext
```

### Reverter Migration
```bash
# Reverter última migration
dotnet ef database update <MigrationAnterior> --context ApplicationDbContext

# Remover migration não aplicada
dotnet ef migrations remove --context ApplicationDbContext
```

### Gerar Script SQL
```bash
# Script completo
dotnet ef migrations script --context ApplicationDbContext \
  --output identity-schema.sql

# Script idempotente (produção)
dotnet ef migrations script --context ApplicationDbContext \
  --idempotent --output identity-schema-idempotent.sql
```

## Migrations Aplicadas

- `InitialIdentity`: Schema inicial com tabelas Users, Roles, UserRoles, UserClaims, UserLogins, RoleClaims, UserTokens

## Produção

Em produção, aplicar migrations via script SQL:
1. Gerar script idempotente
2. Revisar script
3. Aplicar via psql ou ferramenta de deploy
4. Validar schema criado
```

**Validação:**
- [ ] README.md criado
- [ ] Comandos documentados
- [ ] Processo de produção explicado

## Sequenciamento

- **Bloqueado por:** 3.0 (Implementar ApplicationUser e ApplicationDbContext)
- **Desbloqueia:** 5.0 (Implementar IdentityConfiguration)
- **Paralelizável com:** Nenhum (dependência sequencial)

## Critérios de Aceitação

- [ ] Migration `InitialIdentity` criada
- [ ] Migration aplicada com sucesso no PostgreSQL
- [ ] 7 tabelas Identity criadas sem prefixo "AspNet"
- [ ] Tabela `__EFMigrationsHistory` criada
- [ ] Índices e foreign keys configurados
- [ ] Scripts SQL gerados (opcional)
- [ ] README.md documentando processo
- [ ] Zero erros durante aplicação

## Comandos de Validação

```bash
# Verificar migrations criadas
ls -la src/MathFlow/Infrastructure/IdentityServer/Data/Migrations/

# Listar migrations
cd src/MathFlow
dotnet ef migrations list --context ApplicationDbContext

# Verificar tabelas no PostgreSQL
docker exec -it mathflow-postgres psql -U mathflow -d mathflow_dev -c "\dt"

# Contar tabelas criadas (deve ser 8: 7 Identity + 1 EFMigrationsHistory)
docker exec -it mathflow-postgres psql -U mathflow -d mathflow_dev -c "\dt" | grep -c "table"

# Verificar migration aplicada
docker exec -it mathflow-postgres psql -U mathflow -d mathflow_dev \
  -c "SELECT * FROM \"__EFMigrationsHistory\";"
```

## Notas de Implementação

- **Atenção**: Sempre usar `--context ApplicationDbContext` para evitar ambiguidade se houver múltiplos DbContexts
- **Dica**: Usar `--output-dir` garante que migrations fiquem organizadas na pasta correta
- **Importante**: Em produção, NUNCA aplicar migrations automaticamente no startup, sempre usar scripts SQL revisados
- **PostgreSQL**: Nomes de tabelas são case-sensitive, usar aspas duplas em queries: `"Users"` não `users`
- **Próximo passo**: Após conclusão, implementar IdentityConfiguration (5.0) para configurar Identity no Program.cs

## Estimativa

**Tempo estimado:** 0.5 dia (4 horas)

## Riscos

- **Baixo**: PostgreSQL não rodando - Mitigação: Validar Docker antes de aplicar migration
- **Baixo**: Connection string incorreta - Mitigação: Testar conectividade antes de migration
- **Baixo**: Permissões insuficientes no banco - Mitigação: Usar usuário com permissões CREATE TABLE
- **Médio**: Migration falhar por schema existente - Mitigação: Usar database limpo ou script idempotente

## Troubleshooting

### Erro: "Unable to create an object of type 'ApplicationDbContext'"
**Solução:** Adicionar connection string em `appsettings.Development.json`

### Erro: "Could not connect to the server"
**Solução:** Verificar se PostgreSQL está rodando: `docker ps | grep postgres`

### Erro: "A network-related or instance-specific error occurred"
**Solução:** Verificar porta 5432 disponível: `lsof -i :5432`

### Erro: "relation already exists"
**Solução:** Dropar database e recriar ou usar migration idempotente

## Referências

- [EF Core Migrations](https://learn.microsoft.com/en-us/ef/core/managing-schemas/migrations/)
- [EF Core CLI Tools](https://learn.microsoft.com/en-us/ef/core/cli/dotnet)
- [PostgreSQL with EF Core](https://www.npgsql.org/efcore/)
