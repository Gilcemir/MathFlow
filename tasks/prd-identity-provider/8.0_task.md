---
status: completed
parallelizable: false
blocked_by: ["7.0"]
completed_date: 2025-11-02
---

<task_context>
<domain>backend/integration</domain>
<type>implementation</type>
<scope>core_feature</scope>
<complexity>medium</complexity>
<dependencies>identity_config,seeder</dependencies>
<unblocks>9.0,10.0</unblocks>
</task_context>

# Tarefa 8.0: Integrar Identity no Program.cs

## Visão Geral

Integrar todos os componentes de Identity no `Program.cs`, configurando o pipeline de middleware e executando o seeder no startup. Esta tarefa finaliza a configuração base do Identity Provider, tornando o sistema funcional para as próximas tarefas.

## Contexto da Tech Spec

**Referência:** Seção 4 da Tech Spec - Integração no Program.cs

Integrações necessárias:
- Chamar `AddIdentityServices` para configurar Identity
- Chamar `AddAuthorizationPolicies` para configurar policies
- Registrar serviços de aplicação (UserService, RoleService)
- Executar `IdentitySeeder.SeedAsync` no startup
- Adicionar middleware `UseAuthentication` e `UseAuthorization` na ordem correta

## Requisitos

- [ ] Adicionar `AddIdentityServices` ao builder
- [ ] Adicionar `AddAuthorizationPolicies` ao builder
- [ ] Registrar `UserService` e `RoleService` (preparação para tarefa 9.0)
- [ ] **(Opcional)** Aplicar migrations automaticamente no startup
- [ ] **(Alternativa)** Executar seeder manual após `app.Build()`
- [ ] Adicionar `UseAuthentication` antes de `UseAuthorization`
- [ ] Validar ordem do middleware
- [ ] Testar startup da aplicação
- [ ] Validar seed executado

## Subtarefas

### 8.1: Adicionar Using Statements

**Ação:** Adicionar imports necessários no topo do Program.cs

**Arquivo:** `src/MathFlow/Program.cs`

**Using statements a adicionar:**
```csharp
using MathFlow.Infrastructure.IdentityServer.Configuration;
using MathFlow.Infrastructure.IdentityServer.Seeders;
using MathFlow.Application.Services.Identity;
```

**Validação:**
- [ ] Imports adicionados no topo do arquivo
- [ ] Nenhum conflito de namespace

### 8.2: Configurar Identity Services

**Ação:** Adicionar configuração de Identity após `AddRazorPages()`

**Código a adicionar no builder (antes de `var app = builder.Build();`):**
```csharp
// Configure Identity
builder.Services.AddIdentityServices(builder.Configuration);
builder.Services.AddAuthorizationPolicies();
```

**Localização no arquivo:**
```csharp
// Add services to the container.
builder.Services.AddRazorPages();
builder.Services.AddNodeJS();

// Configure OpenTelemetry
builder.AddOpenTelemetry();

// Configure Identity
builder.Services.AddIdentityServices(builder.Configuration);
builder.Services.AddAuthorizationPolicies();

// ... resto do código
```

**Validação:**
- [ ] `AddIdentityServices` chamado com `builder.Configuration`
- [ ] `AddAuthorizationPolicies` chamado
- [ ] Ordem correta (após AddRazorPages, antes de Build)

### 8.3: Registrar Application Services

**Ação:** Registrar UserService e RoleService no DI container

**Código a adicionar:**
```csharp
// Register application services
builder.Services.AddScoped<UserService>();
builder.Services.AddScoped<RoleService>();
```

**Localização:**
```csharp
// Configure Identity
builder.Services.AddIdentityServices(builder.Configuration);
builder.Services.AddAuthorizationPolicies();

// Register application services
builder.Services.AddScoped<UserService>();
builder.Services.AddScoped<RoleService>();
```

**Validação:**
- [ ] Ambos os serviços registrados como `Scoped`
- [ ] Ordem após configuração de Identity

### 8.4: Aplicar Migrations e Seed (Escolha uma opção)

#### Opção A: Auto-Migration (Recomendado para Desenvolvimento)

**Ação:** Aplicar migrations automaticamente no startup

**Código a adicionar (após `var app = builder.Build();`):**
```csharp
// Aplicar migrations automaticamente
using (var scope = app.Services.CreateScope())
{
    var services = scope.ServiceProvider;
    try
    {
        var dbContext = services.GetRequiredService<ApplicationDbContext>();
        dbContext.Database.Migrate(); // Equivalente a 'dotnet ef database update'
        
        var logger = services.GetRequiredService<ILogger<Program>>();
        logger.LogInformation("Database migrations applied successfully");
    }
    catch (Exception ex)
    {
        var logger = services.GetRequiredService<ILogger<Program>>();
        logger.LogError(ex, "An error occurred while applying migrations");
        throw;
    }
}
```

**Vantagens:**
- ✅ Não precisa rodar `dotnet ef database update` manualmente
- ✅ Seed data (via `HasData`) aplicado automaticamente
- ✅ Banco sempre atualizado ao iniciar aplicação
- ✅ Ideal para desenvolvimento local e CI/CD

**Desvantagens:**
- ⚠️ Pode aumentar tempo de startup (primeira vez)
- ⚠️ Em produção, preferível aplicar migrations manualmente antes do deploy

#### Opção B: Seeder Manual (Abordagem Original)

**Ação:** Executar seeder manual após `app.Build()`

**Código a adicionar:**
```csharp
// Seed Identity data
using (var scope = app.Services.CreateScope())
{
    var services = scope.ServiceProvider;
    try
    {
        await IdentitySeeder.SeedAsync(services, builder.Configuration);
    }
    catch (Exception ex)
    {
        var logger = services.GetRequiredService<ILogger<Program>>();
        logger.LogError(ex, "An error occurred while seeding the database");
        throw;
    }
}
```

**Nota:** Requer que você rode `dotnet ef database update` manualmente antes.

**Validação (ambas opções):**
- [ ] Scope criado para resolver serviços
- [ ] Exceções capturadas e logadas
- [ ] Exceção re-lançada para evitar startup com falha
- [ ] Seed data criado no banco

### 8.5: Adicionar Middleware de Autenticação

**Ação:** Adicionar `UseAuthentication` e `UseAuthorization` na ordem correta

**Código a adicionar (após `UseRouting`, antes de `MapStaticAssets`):**
```csharp
app.UseRouting();

// IMPORTANTE: Ordem correta
app.UseAuthentication();  // Novo
app.UseAuthorization();

app.MapStaticAssets();
```

**Validação:**
- [ ] `UseAuthentication` adicionado
- [ ] `UseAuthorization` já existe (mover se necessário)
- [ ] Ordem: UseRouting → UseAuthentication → UseAuthorization
- [ ] Antes de MapStaticAssets e MapRazorPages

### 8.6: Validar Program.cs Completo

**Ação:** Revisar Program.cs completo para garantir ordem correta

**Estrutura esperada:**
```csharp
using Jering.Javascript.NodeJS;
using MathFlow.Infrastructure.Converters;
using MathFlow.Infrastructure.Observability;
using MathFlow.Infrastructure.IdentityServer.Configuration;
using MathFlow.Infrastructure.IdentityServer.Seeders;
using MathFlow.Application.Services.Identity;
using MathFlow.Services;
using MathFlow.Services.Coverters;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
builder.Services.AddRazorPages();
builder.Services.AddNodeJS();

// Configure OpenTelemetry
builder.AddOpenTelemetry();

// Configure Identity
builder.Services.AddIdentityServices(builder.Configuration);
builder.Services.AddAuthorizationPolicies();

// Register application services
builder.Services.AddScoped<UserService>();
builder.Services.AddScoped<RoleService>();

builder.Services.Configure<OutOfProcessNodeJSServiceOptions>(options =>
{
    options.Concurrency = Concurrency.MultiProcess;
    options.ConcurrencyDegree = 4;
    options.EnableFileWatching = false;
});

builder.Services.Configure<NodeJSProcessOptions>(options =>
{
    options.ProjectPath = Path.Combine(Directory.GetCurrentDirectory(), "Infrastructure/Converters/Scripts");
});

builder.Services.AddSingleton<WordProcessor>();
builder.Services.AddSingleton<OmmlToMathMLConverter>();

var app = builder.Build();

// Seed Identity data
using (var scope = app.Services.CreateScope())
{
    var services = scope.ServiceProvider;
    try
    {
        await IdentitySeeder.SeedAsync(services, builder.Configuration);
    }
    catch (Exception ex)
    {
        var logger = services.GetRequiredService<ILogger<Program>>();
        logger.LogError(ex, "An error occurred while seeding the database");
        throw;
    }
}

// Configure the HTTP request pipeline.
if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Error");
    app.UseHsts();
}

app.UseHttpsRedirection();

app.UseRouting();

// IMPORTANTE: Ordem correta
app.UseAuthentication();
app.UseAuthorization();

app.MapStaticAssets();
app.MapRazorPages()
   .WithStaticAssets();

app.Run();
```

**Validação:**
- [ ] Todos os using statements presentes
- [ ] Identity configurado antes de Build
- [ ] Seeder executado após Build
- [ ] Middleware na ordem correta
- [ ] Código compila sem erros

### 8.7: Testar Startup

**Ação:** Executar aplicação e validar que Identity foi configurado

**Comandos:**
```bash
cd src/MathFlow

# Compilar
dotnet build

# Executar aplicação
dotnet run
```

**Validação:**
- [ ] Aplicação inicia sem erros
- [ ] Seeder executa com sucesso
- [ ] Logs indicam roles criadas
- [ ] Logs indicam master admin criado
- [ ] Aplicação responde em http://localhost:5124

### 8.8: Validar Seed no Banco

**Ação:** Verificar que roles e master admin foram criados

**Comandos:**
```bash
# Verificar roles
docker exec -it mathflow-postgres psql -U mathflow -d mathflow_dev \
  -c "SELECT \"Id\", \"Name\" FROM \"Roles\";"

# Verificar master admin
docker exec -it mathflow-postgres psql -U mathflow -d mathflow_dev \
  -c "SELECT \"Id\", \"UserName\", \"Email\", \"TwoFactorEnabled\" FROM \"Users\";"

# Verificar role atribuída
docker exec -it mathflow-postgres psql -U mathflow -d mathflow_dev \
  -c "SELECT u.\"Email\", r.\"Name\" FROM \"Users\" u 
      JOIN \"UserRoles\" ur ON u.\"Id\" = ur.\"UserId\"
      JOIN \"Roles\" r ON ur.\"RoleId\" = r.\"Id\";"
```

**Validação:**
- [ ] 4 roles criadas: masterAdmin, admin, premium, normal
- [ ] 1 usuário criado (master admin)
- [ ] Master admin tem `TwoFactorEnabled = false`
- [ ] Master admin tem role `masterAdmin`

## Sequenciamento

- **Bloqueado por:** 7.0 (Implementar IdentitySeeder)
- **Desbloqueia:** 9.0 (Implementar UserService), 10.0 (Implementar RoleService)
- **Paralelizável com:** Nenhum (dependência sequencial)

## Critérios de Aceitação

- [ ] `AddIdentityServices` e `AddAuthorizationPolicies` chamados
- [ ] `UserService` e `RoleService` registrados
- [ ] Seeder executado no startup
- [ ] Middleware `UseAuthentication` e `UseAuthorization` na ordem correta
- [ ] Aplicação inicia sem erros
- [ ] Roles e master admin criados no banco
- [ ] Logs indicam sucesso do seeder

## Comandos de Validação

```bash
# Compilar
cd src/MathFlow
dotnet build --no-restore

# Executar e verificar logs
dotnet run 2>&1 | grep -i "identity\|seed\|role"

# Verificar que aplicação responde
curl http://localhost:5124

# Contar roles no banco (deve ser 4)
docker exec -it mathflow-postgres psql -U mathflow -d mathflow_dev \
  -c "SELECT COUNT(*) FROM \"Roles\";"

# Contar usuários no banco (deve ser 1)
docker exec -it mathflow-postgres psql -U mathflow -d mathflow_dev \
  -c "SELECT COUNT(*) FROM \"Users\";"
```

## Notas de Implementação

- **Atenção**: Ordem do middleware é crítica: UseAuthentication ANTES de UseAuthorization
- **Dica**: Usar scope para seeder garante que DbContext seja descartado corretamente
- **Importante**: Seeder deve lançar exceção em caso de falha para evitar startup com dados inconsistentes
- **Logging**: Logs do seeder ajudam a debugar problemas de configuração
- **Próximo passo**: Após conclusão, implementar UserService (9.0) e RoleService (10.0)

## Estimativa

**Tempo estimado:** 1 dia (8 horas)

## Riscos

- **Baixo**: Ordem incorreta do middleware - Mitigação: Seguir documentação oficial
- **Médio**: Seeder falhar silenciosamente - Mitigação: Re-lançar exceção após logging
- **Baixo**: Connection string não configurada - Mitigação: Exceção clara no IdentityConfiguration

## Troubleshooting

### Erro: "Unable to resolve service for type 'ApplicationDbContext'"
**Solução:** Verificar que `AddIdentityServices` foi chamado antes de `app.Build()`

### Erro: "Master admin credentials not configured"
**Solução:** Adicionar credenciais em `appsettings.Development.json`:
```json
{
  "Identity": {
    "MasterAdmin": {
      "Email": "admin@mathflow.local",
      "Password": "Dev@1234"
    }
  }
}
```

### Erro: "An error occurred while seeding the database"
**Solução:** Verificar logs detalhados, provavelmente password policy não satisfeita

## Referências

- [ASP.NET Core Middleware](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/)
- [Authentication Middleware](https://learn.microsoft.com/en-us/aspnet/core/security/authentication/)
- [Dependency Injection in ASP.NET Core](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection)
