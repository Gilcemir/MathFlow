---
status: completed
parallelizable: false
blocked_by: ["5.0"]
completed_date: 2025-11-02
---

<task_context>
<domain>backend/config</domain>
<type>implementation</type>
<scope>security</scope>
<complexity>low</complexity>
<dependencies>identity_config</dependencies>
<unblocks>7.0</unblocks>
</task_context>

# Tarefa 6.0: Implementar AuthorizationPolicies

## Visão Geral

Implementar as políticas de autorização nomeadas que serão usadas para proteger endpoints e páginas da aplicação. As policies fornecem uma camada de abstração flexível sobre roles, permitindo lógica de autorização mais complexa no futuro.

## Contexto da Tech Spec

**Referência:** Seção 3.4 da Tech Spec - AuthorizationPolicies

Policies definidas:
- **MasterAdminOnly**: apenas role `masterAdmin`
- **AdminOnly**: roles `admin` ou `masterAdmin`
- **PremiumAccess**: roles `premium`, `admin` ou `masterAdmin`
- **AuthenticatedUser**: qualquer usuário autenticado

## Requisitos

- [ ] Criar extension method `AddAuthorizationPolicies`
- [ ] Implementar policy `MasterAdminOnly`
- [ ] Implementar policy `AdminOnly`
- [ ] Implementar policy `PremiumAccess`
- [ ] Implementar policy `AuthenticatedUser`
- [ ] Definir constantes para nomes de policies
- [ ] Adicionar documentação XML
- [ ] Validar configuração

## Subtarefas

### 6.1: Criar Classe AuthorizationPolicies

**Ação:** Criar classe estática com constantes e extension method

**Arquivo:** `src/MathFlow/Infrastructure/IdentityServer/Configuration/AuthorizationPolicies.cs`

**Código:**
```csharp
using Microsoft.AspNetCore.Authorization;

namespace MathFlow.Infrastructure.IdentityServer.Configuration;

/// <summary>
/// Provides extension methods for configuring authorization policies.
/// </summary>
public static class AuthorizationPolicies
{
    // Policy names as constants for type safety
    public const string MasterAdminOnly = "MasterAdminOnly";
    public const string AdminOnly = "AdminOnly";
    public const string PremiumAccess = "PremiumAccess";
    public const string AuthenticatedUser = "AuthenticatedUser";

    /// <summary>
    /// Adds and configures authorization policies for the application.
    /// </summary>
    /// <param name="services">The service collection to add services to.</param>
    /// <returns>The service collection for chaining.</returns>
    public static IServiceCollection AddAuthorizationPolicies(this IServiceCollection services)
    {
        // Implementação nas próximas subtarefas
        return services;
    }
}
```

**Validação:**
- [ ] Arquivo criado em `Infrastructure/IdentityServer/Configuration/`
- [ ] Namespace correto
- [ ] Classe estática
- [ ] Constantes públicas definidas
- [ ] Extension method com documentação XML

### 6.2: Implementar Policy MasterAdminOnly

**Ação:** Adicionar policy que requer apenas role `masterAdmin`

**Código a adicionar no método `AddAuthorizationPolicies`:**
```csharp
services.AddAuthorization(options =>
{
    // Master Admin: apenas masterAdmin
    options.AddPolicy(MasterAdminOnly, policy =>
        policy.RequireRole("masterAdmin"));
});
```

**Validação:**
- [ ] Policy criada com nome correto
- [ ] Requer role `masterAdmin`
- [ ] Comentário explicativo presente

### 6.3: Implementar Policy AdminOnly

**Ação:** Adicionar policy que aceita `admin` ou `masterAdmin`

**Código a adicionar:**
```csharp
// Admin: admin ou masterAdmin
options.AddPolicy(AdminOnly, policy =>
    policy.RequireRole("admin", "masterAdmin"));
```

**Validação:**
- [ ] Policy aceita múltiplas roles
- [ ] Roles `admin` e `masterAdmin` incluídas
- [ ] Comentário explicativo presente

### 6.4: Implementar Policy PremiumAccess

**Ação:** Adicionar policy que aceita `premium`, `admin` ou `masterAdmin`

**Código a adicionar:**
```csharp
// Premium: premium, admin ou masterAdmin
options.AddPolicy(PremiumAccess, policy =>
    policy.RequireRole("premium", "admin", "masterAdmin"));
```

**Validação:**
- [ ] Policy aceita 3 roles
- [ ] Roles `premium`, `admin` e `masterAdmin` incluídas
- [ ] Comentário explicativo presente

### 6.5: Implementar Policy AuthenticatedUser

**Ação:** Adicionar policy que aceita qualquer usuário autenticado

**Código a adicionar:**
```csharp
// Authenticated: qualquer usuário autenticado
options.AddPolicy(AuthenticatedUser, policy =>
    policy.RequireAuthenticatedUser());
```

**Validação:**
- [ ] Policy usa `RequireAuthenticatedUser()`
- [ ] Não requer role específica
- [ ] Comentário explicativo presente

### 6.6: Adicionar Documentação

**Ação:** Documentar cada policy com XML comments

**Adicionar comentários:**
```csharp
/// <summary>
/// Policy name for master administrator access only.
/// Requires the 'masterAdmin' role.
/// </summary>
public const string MasterAdminOnly = "MasterAdminOnly";

/// <summary>
/// Policy name for administrator access.
/// Requires either 'admin' or 'masterAdmin' role.
/// </summary>
public const string AdminOnly = "AdminOnly";

/// <summary>
/// Policy name for premium feature access.
/// Requires 'premium', 'admin', or 'masterAdmin' role.
/// </summary>
public const string PremiumAccess = "PremiumAccess";

/// <summary>
/// Policy name for any authenticated user.
/// Requires the user to be authenticated but no specific role.
/// </summary>
public const string AuthenticatedUser = "AuthenticatedUser";
```

**Validação:**
- [ ] Todas as constantes documentadas
- [ ] Documentação clara sobre requisitos de cada policy

### 6.7: Validar Configuração

**Ação:** Compilar e testar configuração

**Comandos:**
```bash
cd src/MathFlow

# Compilar
dotnet build

# Verificar warnings
dotnet build 2>&1 | grep -i warning | grep -i authorization
```

**Validação:**
- [ ] Compilação bem-sucedida
- [ ] Zero warnings relacionados a Authorization
- [ ] Extension method acessível

## Código Completo

**Arquivo final:** `src/MathFlow/Infrastructure/IdentityServer/Configuration/AuthorizationPolicies.cs`

```csharp
using Microsoft.AspNetCore.Authorization;

namespace MathFlow.Infrastructure.IdentityServer.Configuration;

/// <summary>
/// Provides extension methods for configuring authorization policies.
/// </summary>
public static class AuthorizationPolicies
{
    /// <summary>
    /// Policy name for master administrator access only.
    /// Requires the 'masterAdmin' role.
    /// </summary>
    public const string MasterAdminOnly = "MasterAdminOnly";

    /// <summary>
    /// Policy name for administrator access.
    /// Requires either 'admin' or 'masterAdmin' role.
    /// </summary>
    public const string AdminOnly = "AdminOnly";

    /// <summary>
    /// Policy name for premium feature access.
    /// Requires 'premium', 'admin', or 'masterAdmin' role.
    /// </summary>
    public const string PremiumAccess = "PremiumAccess";

    /// <summary>
    /// Policy name for any authenticated user.
    /// Requires the user to be authenticated but no specific role.
    /// </summary>
    public const string AuthenticatedUser = "AuthenticatedUser";

    /// <summary>
    /// Adds and configures authorization policies for the application.
    /// </summary>
    /// <param name="services">The service collection to add services to.</param>
    /// <returns>The service collection for chaining.</returns>
    public static IServiceCollection AddAuthorizationPolicies(this IServiceCollection services)
    {
        services.AddAuthorization(options =>
        {
            // Master Admin: apenas masterAdmin
            options.AddPolicy(MasterAdminOnly, policy =>
                policy.RequireRole("masterAdmin"));

            // Admin: admin ou masterAdmin
            options.AddPolicy(AdminOnly, policy =>
                policy.RequireRole("admin", "masterAdmin"));

            // Premium: premium, admin ou masterAdmin
            options.AddPolicy(PremiumAccess, policy =>
                policy.RequireRole("premium", "admin", "masterAdmin"));

            // Authenticated: qualquer usuário autenticado
            options.AddPolicy(AuthenticatedUser, policy =>
                policy.RequireAuthenticatedUser());
        });

        return services;
    }
}
```

## Uso das Policies

**Exemplo em Razor Pages:**
```csharp
// Requer apenas master admin
[Authorize(Policy = AuthorizationPolicies.MasterAdminOnly)]
public class SystemConfigModel : PageModel { }

// Requer admin ou master admin
[Authorize(Policy = AuthorizationPolicies.AdminOnly)]
public class UsersManagementModel : PageModel { }

// Requer premium, admin ou master admin
[Authorize(Policy = AuthorizationPolicies.PremiumAccess)]
public class PremiumFeatureModel : PageModel { }

// Requer apenas autenticação
[Authorize(Policy = AuthorizationPolicies.AuthenticatedUser)]
public class ProfileModel : PageModel { }
```

## Sequenciamento

- **Bloqueado por:** 5.0 (Implementar IdentityConfiguration)
- **Desbloqueia:** 7.0 (Implementar IdentitySeeder)
- **Paralelizável com:** Nenhum (dependência sequencial)

## Critérios de Aceitação

- [ ] Extension method `AddAuthorizationPolicies` implementado
- [ ] 4 policies definidas com nomes corretos
- [ ] Constantes públicas para nomes de policies
- [ ] Documentação XML completa
- [ ] Compilação sem erros ou warnings
- [ ] Policies testáveis via atributo `[Authorize(Policy = ...)]`

## Comandos de Validação

```bash
# Compilar
cd src/MathFlow
dotnet build --no-restore

# Verificar arquivo criado
ls -la Infrastructure/IdentityServer/Configuration/AuthorizationPolicies.cs

# Verificar constantes definidas
grep -n "public const string" Infrastructure/IdentityServer/Configuration/AuthorizationPolicies.cs

# Contar policies (deve ser 4)
grep -c "AddPolicy" Infrastructure/IdentityServer/Configuration/AuthorizationPolicies.cs
```

## Notas de Implementação

- **Atenção**: Usar constantes ao invés de strings mágicas previne erros de digitação
- **Dica**: Policies podem ser estendidas no futuro para incluir lógica mais complexa (ex: verificar créditos)
- **Importante**: `RequireRole()` aceita múltiplas roles com lógica OR (qualquer uma satisfaz)
- **Flexibilidade**: Policies podem combinar múltiplos requisitos (roles + claims + custom logic)
- **Próximo passo**: Após conclusão, implementar IdentitySeeder (7.0) para criar roles

## Estimativa

**Tempo estimado:** 0.5 dia (4 horas)

## Riscos

- **Baixo**: Typo em nomes de roles - Mitigação: Usar constantes e validar com seeder
- **Baixo**: Lógica de policy incorreta - Mitigação: Testar com diferentes roles em tarefas futuras

## Extensões Futuras

**Fase 2 - Lógica Complexa:**
```csharp
// Exemplo: Premium com verificação de créditos
options.AddPolicy("PremiumWithCredits", policy =>
    policy.RequireRole("premium", "admin", "masterAdmin")
          .Requirements.Add(new HasCreditsRequirement(minCredits: 1)));
```

**Fase 3 - Claims-based:**
```csharp
// Exemplo: Verificar claim específico
options.AddPolicy("CanEditContent", policy =>
    policy.RequireClaim("permission", "content.edit"));
```

## Referências

- [Policy-based Authorization](https://learn.microsoft.com/en-us/aspnet/core/security/authorization/policies)
- [Role-based Authorization](https://learn.microsoft.com/en-us/aspnet/core/security/authorization/roles)
- [Authorization in Razor Pages](https://learn.microsoft.com/en-us/aspnet/core/security/authorization/razor-pages-authorization)
