---
status: pending
parallelizable: true
blocked_by: ["8.0"]
---

<task_context>
<domain>backend/service</domain>
<type>implementation</type>
<scope>core_feature</scope>
<complexity>high</complexity>
<dependencies>identity_config,database</dependencies>
<unblocks>11.0,12.0,16.0</unblocks>
</task_context>

# Tarefa 9.0: Implementar UserService

## Visão Geral

Implementar o serviço de aplicação `UserService` responsável por toda a lógica de negócio relacionada a usuários: registro, login, two-factor authentication e gestão de autenticação. Este é um componente crítico que orquestra as operações do ASP.NET Core Identity.

## Contexto da Tech Spec

**Referência:** Seção 3.6 da Tech Spec - UserService

Responsabilidades principais:
- Registro de novos usuários com role padrão `normal`
- Login com suporte a 2FA obrigatório (exceto masterAdmin)
- Verificação de códigos TOTP
- Geração de chaves para configuração de authenticator apps
- Logging de eventos de autenticação

## Requisitos

- [ ] Implementar método `RegisterUserAsync`
- [ ] Implementar método `LoginAsync` com suporte a 2FA
- [ ] Implementar método `VerifyTwoFactorCodeAsync`
- [ ] Implementar método `GetTwoFactorSetupKeyAsync`
- [ ] Adicionar logging estruturado
- [ ] Implementar tratamento de erros
- [ ] Validar regras de negócio (2FA obrigatório, role padrão)

## Subtarefas

### 9.1: Criar Classe UserService

**Ação:** Criar estrutura base do serviço com dependências

**Arquivo:** `src/MathFlow/Application/Services/Identity/UserService.cs`

**Código:**
```csharp
using Microsoft.AspNetCore.Identity;
using MathFlow.Infrastructure.IdentityServer.Models;

namespace MathFlow.Application.Services.Identity;

public class UserService
{
    private readonly UserManager<ApplicationUser> _userManager;
    private readonly SignInManager<ApplicationUser> _signInManager;
    private readonly ILogger<UserService> _logger;

    public UserService(
        UserManager<ApplicationUser> userManager,
        SignInManager<ApplicationUser> signInManager,
        ILogger<UserService> logger)
    {
        _userManager = userManager;
        _signInManager = signInManager;
        _logger = logger;
    }
}
```

**Validação:**
- [ ] Classe criada no namespace correto
- [ ] Dependências injetadas via construtor
- [ ] Logger configurado

### 9.2: Implementar RegisterUserAsync

**Ação:** Implementar registro de usuários com 2FA obrigatório e role padrão

**Código:**
```csharp
public async Task<IdentityResult> RegisterUserAsync(
    string email,
    string password,
    string userName)
{
    var user = new ApplicationUser
    {
        UserName = userName,
        Email = email,
        TwoFactorEnabled = true // Obrigatório para todos exceto masterAdmin
    };

    var result = await _userManager.CreateAsync(user, password);

    if (result.Succeeded)
    {
        // Atribuir role padrão "normal"
        await _userManager.AddToRoleAsync(user, "normal");

        _logger.LogInformation(
            "User {Email} registered successfully with role 'normal'",
            email);
    }
    else
    {
        _logger.LogWarning(
            "Failed to register user {Email}: {Errors}",
            email,
            string.Join(", ", result.Errors.Select(e => e.Description)));
    }

    return result;
}
```

**Validação:**
- [ ] Usuário criado com `TwoFactorEnabled = true`
- [ ] Role `normal` atribuída automaticamente
- [ ] Logging de sucesso e falha implementado
- [ ] Retorna `IdentityResult` com erros se aplicável

### 9.3: Implementar LoginAsync

**Ação:** Implementar login com detecção de 2FA

**Código:**
```csharp
public async Task<SignInResult> LoginAsync(
    string email,
    string password,
    bool rememberMe)
{
    var user = await _userManager.FindByEmailAsync(email);
    if (user == null)
    {
        _logger.LogWarning("Login attempt for non-existent user {Email}", email);
        return SignInResult.Failed;
    }

    // Verificar se 2FA está habilitado
    if (await _userManager.GetTwoFactorEnabledAsync(user))
    {
        // Validar senha primeiro
        var passwordValid = await _userManager.CheckPasswordAsync(user, password);
        if (!passwordValid)
        {
            _logger.LogWarning("Invalid password for user {Email}", email);
            return SignInResult.Failed;
        }

        _logger.LogInformation("User {Email} requires 2FA", email);
        // Retornar que requer 2FA
        return SignInResult.TwoFactorRequired;
    }

    // Login normal (apenas para masterAdmin sem 2FA)
    var result = await _signInManager.PasswordSignInAsync(
        email,
        password,
        rememberMe,
        lockoutOnFailure: true);

    if (result.Succeeded)
    {
        _logger.LogInformation("User {Email} logged in successfully", email);
    }
    else if (result.IsLockedOut)
    {
        _logger.LogWarning("User {Email} is locked out", email);
    }

    return result;
}
```

**Validação:**
- [ ] Verifica existência do usuário
- [ ] Detecta se 2FA está habilitado
- [ ] Valida senha antes de retornar `TwoFactorRequired`
- [ ] Implementa lockout após tentativas falhadas
- [ ] Logging detalhado de todos os cenários

### 9.4: Implementar VerifyTwoFactorCodeAsync

**Ação:** Implementar verificação de código TOTP

**Código:**
```csharp
public async Task<bool> VerifyTwoFactorCodeAsync(
    string email,
    string code)
{
    var user = await _userManager.FindByEmailAsync(email);
    if (user == null)
    {
        _logger.LogWarning("2FA verification attempt for non-existent user {Email}", email);
        return false;
    }

    var isValid = await _userManager.VerifyTwoFactorTokenAsync(
        user,
        _userManager.Options.Tokens.AuthenticatorTokenProvider,
        code);

    if (isValid)
    {
        await _signInManager.SignInAsync(user, isPersistent: true);
        _logger.LogInformation("User {Email} completed 2FA successfully", email);
    }
    else
    {
        _logger.LogWarning("Invalid 2FA code for user {Email}", email);
    }

    return isValid;
}
```

**Validação:**
- [ ] Verifica código TOTP usando `VerifyTwoFactorTokenAsync`
- [ ] Completa sign-in após verificação bem-sucedida
- [ ] Logging de sucesso e falha
- [ ] Retorna booleano indicando resultado

### 9.5: Implementar GetTwoFactorSetupKeyAsync

**Ação:** Implementar geração de chave para configuração de authenticator

**Código:**
```csharp
public async Task<string> GetTwoFactorSetupKeyAsync(string userId)
{
    var user = await _userManager.FindByIdAsync(userId);
    if (user == null)
    {
        _logger.LogError("Attempted to get 2FA key for non-existent user {UserId}", userId);
        throw new InvalidOperationException("User not found");
    }

    var key = await _userManager.GetAuthenticatorKeyAsync(user);
    if (string.IsNullOrEmpty(key))
    {
        await _userManager.ResetAuthenticatorKeyAsync(user);
        key = await _userManager.GetAuthenticatorKeyAsync(user);
        _logger.LogInformation("Generated new authenticator key for user {UserId}", userId);
    }

    return key!;
}
```

**Validação:**
- [ ] Gera chave se não existir
- [ ] Retorna chave existente se já configurada
- [ ] Lança exceção se usuário não encontrado
- [ ] Logging de geração de chave

### 9.6: Adicionar Tratamento de Erros

**Ação:** Adicionar validações e tratamento robusto de erros

**Validações a adicionar:**
- Validar formato de email
- Validar força de senha (delegado ao Identity)
- Validar que userName não está vazio
- Tratar exceções de banco de dados

**Código adicional:**
```csharp
private void ValidateEmail(string email)
{
    if (string.IsNullOrWhiteSpace(email) || !email.Contains('@'))
    {
        throw new ArgumentException("Invalid email format", nameof(email));
    }
}

private void ValidateUserName(string userName)
{
    if (string.IsNullOrWhiteSpace(userName))
    {
        throw new ArgumentException("Username cannot be empty", nameof(userName));
    }
}
```

**Validação:**
- [ ] Validações de entrada implementadas
- [ ] Exceções apropriadas lançadas
- [ ] Mensagens de erro descritivas

## Sequenciamento

- **Bloqueado por:** 8.0 (Integrar Identity no Program.cs)
- **Desbloqueia:** 11.0 (Testes Unitários), 12.0 (Login/Register Pages), 16.0 (Manage Pages)
- **Paralelizável com:** 10.0 (RoleService)

## Critérios de Aceitação

- [ ] Todos os métodos públicos implementados
- [ ] 2FA obrigatório para novos usuários (exceto masterAdmin)
- [ ] Role `normal` atribuída automaticamente no registro
- [ ] Logging estruturado em todos os métodos
- [ ] Tratamento de erros robusto
- [ ] Código compila sem warnings
- [ ] Documentação XML em métodos públicos

## Comandos de Validação

```bash
# Compilar
cd src/MathFlow
dotnet build

# Verificar warnings
dotnet build 2>&1 | grep -i warning

# Validar que arquivo foi criado
ls -la Application/Services/Identity/UserService.cs
```

## Notas de Implementação

- **Atenção**: `SignInResult.TwoFactorRequired` não completa o sign-in, apenas indica que 2FA é necessário
- **Dica**: Usar `_userManager.Options.Tokens.AuthenticatorTokenProvider` garante uso do provider correto
- **Importante**: Logging deve evitar expor informações sensíveis (senhas, tokens)
- **Próximo passo**: Após conclusão, implementar testes unitários (11.0) e páginas de UI (12.0)

## Estimativa

**Tempo estimado:** 2 dias (16 horas)

## Riscos

- **Médio**: Complexidade de 2FA - Mitigação: Usar bibliotecas padrão do ASP.NET Core Identity
- **Baixo**: Logging excessivo impactando performance - Mitigação: Usar níveis apropriados (Information, Warning)
- **Baixo**: Validações inconsistentes - Mitigação: Centralizar validações em métodos privados

## Referências

- [UserManager<TUser> Documentation](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.identity.usermanager-1)
- [SignInManager<TUser> Documentation](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.identity.signinmanager-1)
- [Two-Factor Authentication in ASP.NET Core](https://learn.microsoft.com/en-us/aspnet/core/security/authentication/2fa)
