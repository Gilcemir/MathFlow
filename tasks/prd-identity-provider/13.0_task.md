---
status: pending
parallelizable: true
blocked_by: ["12.0"]
---

<task_context>
<domain>frontend/pages</domain>
<type>implementation</type>
<scope>core_feature</scope>
<complexity>medium</complexity>
<dependencies>user_service,two_factor</dependencies>
<unblocks>20.0</unblocks>
</task_context>

# Tarefa 13.0: Implementar TwoFactor Page

## Visão Geral

Implementar a página Razor para verificação de código TOTP (Time-based One-Time Password) durante o login, além de configurar o **IEmailSender** (obrigatório para ASP.NET Core Identity 2FA) e **Mailpit** para testes locais de emails.

## Contexto da Tech Spec

**Referência:** Seção 8.1 da Tech Spec - Pages/Account/TwoFactor.cshtml

Funcionalidades:
- Solicitar código de 6 dígitos do authenticator app
- Validar código via UserService
- Completar login após verificação bem-sucedida
- Mensagens de erro claras para código inválido
- **IEmailSender** implementado (requisito do ASP.NET Core Identity)
- **Mailpit** configurado para testes locais

## Requisitos

- [ ] **Implementar IEmailSender** (obrigatório para Identity 2FA)
- [ ] Configurar Mailpit no Docker Compose (desenvolvimento)
- [ ] Criar página TwoFactor.cshtml e TwoFactor.cshtml.cs
- [ ] Criar página TwoFactorSetup.cshtml (pós-registro)
- [ ] Implementar formulário de verificação de código
- [ ] Integrar com UserService.VerifyTwoFactorCodeAsync
- [ ] Validação de formato de código (6 dígitos)
- [ ] Mensagens de erro user-friendly
- [ ] Redirecionamento após verificação bem-sucedida

## Subtarefas

### 13.0: Implementar IEmailSender (Obrigatório)

**Ação:** Criar implementação do IEmailSender para ASP.NET Core Identity

**Contexto:** ASP.NET Core Identity **requer** uma implementação de `IEmailSender` para funcionalidades de 2FA, confirmação de email e recuperação de senha. Sem isso, o Identity não consegue enviar emails.

**Arquivo:** `src/MathFlow/Infrastructure/IdentityServer/Services/EmailSender.cs`

**Código:**
```csharp
using Microsoft.AspNetCore.Identity;
using MathFlow.Infrastructure.IdentityServer.Models;

namespace MathFlow.Infrastructure.IdentityServer.Services;

/// <summary>
/// Email sender implementation for ASP.NET Core Identity.
/// In development, emails are sent to Mailpit (SMTP mock).
/// In production, configure with real SMTP provider.
/// </summary>
public class EmailSender : IEmailSender<ApplicationUser>
{
    private readonly IConfiguration _configuration;
    private readonly ILogger<EmailSender> _logger;

    public EmailSender(IConfiguration configuration, ILogger<EmailSender> logger)
    {
        _configuration = configuration;
        _logger = logger;
    }

    public Task SendConfirmationLinkAsync(ApplicationUser user, string email, string confirmationLink)
    {
        return SendEmailAsync(email, "Confirm your email",
            $"Please confirm your account by <a href='{confirmationLink}'>clicking here</a>.");
    }

    public Task SendPasswordResetLinkAsync(ApplicationUser user, string email, string resetLink)
    {
        return SendEmailAsync(email, "Reset your password",
            $"Please reset your password by <a href='{resetLink}'>clicking here</a>.");
    }

    public Task SendPasswordResetCodeAsync(ApplicationUser user, string email, string resetCode)
    {
        return SendEmailAsync(email, "Reset your password",
            $"Please reset your password using the following code: {resetCode}");
    }

    public async Task SendEmailAsync(string email, string subject, string htmlMessage)
    {
        var smtpHost = _configuration["Email:Smtp:Host"] ?? "localhost";
        var smtpPort = int.Parse(_configuration["Email:Smtp:Port"] ?? "1025");
        var smtpUser = _configuration["Email:Smtp:User"] ?? "";
        var smtpPassword = _configuration["Email:Smtp:Password"] ?? "";
        var fromEmail = _configuration["Email:From"] ?? "noreply@mathflow.local";

        try
        {
            using var client = new System.Net.Mail.SmtpClient(smtpHost, smtpPort);
            client.EnableSsl = false; // Mailpit não usa SSL
            
            if (!string.IsNullOrEmpty(smtpUser))
            {
                client.Credentials = new System.Net.NetworkCredential(smtpUser, smtpPassword);
            }

            var mailMessage = new System.Net.Mail.MailMessage
            {
                From = new System.Net.Mail.MailAddress(fromEmail, "MathFlow"),
                Subject = subject,
                Body = htmlMessage,
                IsBodyHtml = true
            };
            mailMessage.To.Add(email);

            await client.SendMailAsync(mailMessage);
            
            _logger.LogInformation("Email sent to {Email} with subject '{Subject}'", email, subject);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to send email to {Email}", email);
            // Não lançar exceção em desenvolvimento para não quebrar fluxo
            // Em produção, considere lançar ou usar fila de retry
        }
    }
}
```

**Validação:**
- [ ] Classe implementa `IEmailSender<ApplicationUser>`
- [ ] Configuração SMTP lida do appsettings
- [ ] Logging de sucesso e erro
- [ ] Tratamento de exceções

### 13.1: Configurar Mailpit no Docker Compose

**Ação:** Adicionar Mailpit ao docker-compose para capturar emails localmente

**Arquivo:** `docker-compose.yml`

**Código a adicionar:**
```yaml
services:
  # ... postgres existente ...

  mailpit:
    image: axllent/mailpit:latest
    container_name: mathflow-mailpit
    ports:
      - "1025:1025"  # SMTP server
      - "8025:8025"  # Web UI
    environment:
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
    networks:
      - mathflow-network
```

**Configurar appsettings.Development.json:**
```json
{
  "Email": {
    "Smtp": {
      "Host": "localhost",
      "Port": "1025",
      "User": "",
      "Password": ""
    },
    "From": "noreply@mathflow.local"
  }
}
```

**Validação:**
- [ ] Mailpit adicionado ao docker-compose
- [ ] Porta 1025 (SMTP) e 8025 (Web UI) expostas
- [ ] Configuração no appsettings.Development.json
- [ ] Mailpit acessível em http://localhost:8025

### 13.2: Registrar EmailSender no DI

**Ação:** Registrar EmailSender no Program.cs

**Arquivo:** `src/MathFlow/Program.cs`

**Código a adicionar (após AddIdentityServices):**
```csharp
// Configure Identity
builder.Services.AddIdentityServices(builder.Configuration);
builder.Services.AddAuthorizationPolicies();

// Register Email Sender (required for Identity)
builder.Services.AddScoped<IEmailSender<ApplicationUser>, EmailSender>();
```

**Validação:**
- [ ] EmailSender registrado como Scoped
- [ ] Tipo genérico correto: `IEmailSender<ApplicationUser>`

### 13.3: Criar TwoFactor Page Model

**Ação:** Criar PageModel para TwoFactor

**Arquivo:** `src/MathFlow/Pages/Account/TwoFactor.cshtml.cs`

**Código:**
```csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using MathFlow.Application.Services.Identity;
using System.ComponentModel.DataAnnotations;

namespace MathFlow.Pages.Account;

public class TwoFactorModel : PageModel
{
    private readonly UserService _userService;
    private readonly ILogger<TwoFactorModel> _logger;

    public TwoFactorModel(UserService userService, ILogger<TwoFactorModel> logger)
    {
        _userService = userService;
        _logger = logger;
    }

    [BindProperty]
    public InputModel Input { get; set; } = new();

    public string? ReturnUrl { get; set; }

    public bool RememberMe { get; set; }

    [TempData]
    public string? Email { get; set; }

    public class InputModel
    {
        [Required(ErrorMessage = "Verification code is required")]
        [StringLength(6, ErrorMessage = "Code must be 6 digits", MinimumLength = 6)]
        [RegularExpression(@"^\d{6}$", ErrorMessage = "Code must be 6 digits")]
        [Display(Name = "Verification Code")]
        public string Code { get; set; } = string.Empty;
    }

    public IActionResult OnGet(string? email, bool rememberMe = false, string? returnUrl = null)
    {
        if (string.IsNullOrEmpty(email))
        {
            return RedirectToPage("./Login");
        }

        Email = email;
        RememberMe = rememberMe;
        ReturnUrl = returnUrl;

        return Page();
    }

    public async Task<IActionResult> OnPostAsync(string? email, bool rememberMe = false, string? returnUrl = null)
    {
        if (string.IsNullOrEmpty(email))
        {
            return RedirectToPage("./Login");
        }

        returnUrl ??= Url.Content("~/");

        if (!ModelState.IsValid)
        {
            Email = email;
            RememberMe = rememberMe;
            ReturnUrl = returnUrl;
            return Page();
        }

        var result = await _userService.VerifyTwoFactorCodeAsync(email, Input.Code);

        if (result)
        {
            _logger.LogInformation("User {Email} completed 2FA verification", email);
            return LocalRedirect(returnUrl);
        }

        _logger.LogWarning("Invalid 2FA code for user {Email}", email);
        ModelState.AddModelError(string.Empty, "Invalid verification code. Please try again.");

        Email = email;
        RememberMe = rememberMe;
        ReturnUrl = returnUrl;

        return Page();
    }
}
```

**Validação:**
- [ ] PageModel criado com InputModel
- [ ] Validação de código (6 dígitos numéricos)
- [ ] Email passado via query string
- [ ] Integração com UserService
- [ ] Logging de tentativas

### 13.2: Criar TwoFactor View

**Ação:** Criar view Razor para TwoFactor

**Arquivo:** `src/MathFlow/Pages/Account/TwoFactor.cshtml`

**Código:**
```html
@page
@model TwoFactorModel
@{
    ViewData["Title"] = "Two-Factor Authentication";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h2>@ViewData["Title"]</h2>
                    <p class="text-muted">Enter the verification code from your authenticator app</p>
                </div>
                <div class="card-body">
                    <form method="post">
                        <input type="hidden" asp-for="Email" value="@Model.Email" />
                        <input type="hidden" name="rememberMe" value="@Model.RememberMe" />
                        <input type="hidden" name="returnUrl" value="@Model.ReturnUrl" />
                        
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                        
                        <div class="mb-3">
                            <label asp-for="Input.Code" class="form-label"></label>
                            <input asp-for="Input.Code" 
                                   class="form-control form-control-lg text-center" 
                                   autocomplete="off" 
                                   aria-required="true" 
                                   placeholder="000000"
                                   maxlength="6"
                                   pattern="\d{6}"
                                   inputmode="numeric" />
                            <span asp-validation-for="Input.Code" class="text-danger"></span>
                            <small class="form-text text-muted">
                                Enter the 6-digit code from your authenticator app (e.g., Google Authenticator, Microsoft Authenticator).
                            </small>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">Verify</button>
                        </div>
                        
                        <div class="mt-3 text-center">
                            <p>
                                <a asp-page="./Login">Back to login</a>
                            </p>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="alert alert-info mt-3" role="alert">
                <h5 class="alert-heading">
                    <i class="bi bi-info-circle"></i> Need help?
                </h5>
                <p class="mb-0">
                    Open your authenticator app and enter the 6-digit code shown for MathFlow.
                    The code refreshes every 30 seconds.
                </p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        // Auto-submit quando 6 dígitos forem digitados
        document.querySelector('input[name="Input.Code"]').addEventListener('input', function(e) {
            if (e.target.value.length === 6 && /^\d{6}$/.test(e.target.value)) {
                // Opcional: auto-submit após breve delay
                // setTimeout(() => e.target.form.submit(), 500);
            }
        });
    </script>
}
```

**Validação:**
- [ ] Formulário com campo de código
- [ ] Input otimizado para números (inputmode="numeric")
- [ ] Maxlength de 6 caracteres
- [ ] Hidden inputs para email, rememberMe, returnUrl
- [ ] Help text explicativo
- [ ] Link para voltar ao login
- [ ] Bootstrap styling aplicado

### 13.3: Adicionar TwoFactorSetup Page (Pós-Registro)

**Ação:** Criar página para configurar 2FA após registro

**Arquivo:** `src/MathFlow/Pages/Account/TwoFactorSetup.cshtml.cs`

**Código:**
```csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using MathFlow.Application.Services.Identity;
using System.ComponentModel.DataAnnotations;

namespace MathFlow.Pages.Account;

public class TwoFactorSetupModel : PageModel
{
    private readonly UserService _userService;
    private readonly ILogger<TwoFactorSetupModel> _logger;

    public TwoFactorSetupModel(UserService userService, ILogger<TwoFactorSetupModel> logger)
    {
        _userService = userService;
        _logger = logger;
    }

    public string? AuthenticatorKey { get; set; }

    public string? QrCodeUri { get; set; }

    [BindProperty]
    public InputModel Input { get; set; } = new();

    public string? ReturnUrl { get; set; }

    [TempData]
    public string? Email { get; set; }

    public class InputModel
    {
        [Required(ErrorMessage = "Verification code is required")]
        [StringLength(6, ErrorMessage = "Code must be 6 digits", MinimumLength = 6)]
        [RegularExpression(@"^\d{6}$", ErrorMessage = "Code must be 6 digits")]
        [Display(Name = "Verification Code")]
        public string Code { get; set; } = string.Empty;
    }

    public async Task<IActionResult> OnGetAsync(string? email, string? returnUrl = null)
    {
        if (string.IsNullOrEmpty(email))
        {
            return RedirectToPage("./Login");
        }

        Email = email;
        ReturnUrl = returnUrl;

        // Obter chave do authenticator (será implementado no UserService)
        // Por ora, gerar placeholder
        AuthenticatorKey = "PLACEHOLDER_KEY";
        QrCodeUri = $"otpauth://totp/MathFlow:{email}?secret={AuthenticatorKey}&issuer=MathFlow";

        return Page();
    }

    public async Task<IActionResult> OnPostAsync(string? email, string? returnUrl = null)
    {
        if (string.IsNullOrEmpty(email))
        {
            return RedirectToPage("./Login");
        }

        returnUrl ??= Url.Content("~/");

        if (!ModelState.IsValid)
        {
            Email = email;
            ReturnUrl = returnUrl;
            return Page();
        }

        var result = await _userService.VerifyTwoFactorCodeAsync(email, Input.Code);

        if (result)
        {
            _logger.LogInformation("User {Email} completed 2FA setup", email);
            return LocalRedirect(returnUrl);
        }

        ModelState.AddModelError(string.Empty, "Invalid verification code. Please try again.");

        Email = email;
        ReturnUrl = returnUrl;

        return Page();
    }
}
```

**Validação:**
- [ ] PageModel para setup inicial de 2FA
- [ ] Geração de QR code URI
- [ ] Validação de código para confirmar setup

### 13.4: Criar TwoFactorSetup View

**Ação:** Criar view para setup de 2FA

**Arquivo:** `src/MathFlow/Pages/Account/TwoFactorSetup.cshtml`

**Código:**
```html
@page
@model TwoFactorSetupModel
@{
    ViewData["Title"] = "Set Up Two-Factor Authentication";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h2>@ViewData["Title"]</h2>
                    <p class="text-muted">Secure your account with two-factor authentication</p>
                </div>
                <div class="card-body">
                    <div class="alert alert-info" role="alert">
                        <h5 class="alert-heading">
                            <i class="bi bi-shield-check"></i> Why 2FA?
                        </h5>
                        <p class="mb-0">
                            Two-factor authentication adds an extra layer of security to your account.
                            Even if someone knows your password, they cannot access your account without the verification code.
                        </p>
                    </div>
                    
                    <h4 class="mt-4">Step 1: Install an Authenticator App</h4>
                    <p>Download and install one of these apps on your mobile device:</p>
                    <ul>
                        <li>Google Authenticator (iOS/Android)</li>
                        <li>Microsoft Authenticator (iOS/Android)</li>
                        <li>Authy (iOS/Android)</li>
                    </ul>
                    
                    <h4 class="mt-4">Step 2: Scan QR Code</h4>
                    <p>Open your authenticator app and scan this QR code:</p>
                    <div class="text-center my-3">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=@Model.QrCodeUri" 
                             alt="QR Code" 
                             class="img-fluid" />
                    </div>
                    <p class="text-center">
                        <small class="text-muted">
                            Or manually enter this key: <code>@Model.AuthenticatorKey</code>
                        </small>
                    </p>
                    
                    <h4 class="mt-4">Step 3: Verify Setup</h4>
                    <p>Enter the 6-digit code from your authenticator app to complete setup:</p>
                    
                    <form method="post">
                        <input type="hidden" name="email" value="@Model.Email" />
                        <input type="hidden" name="returnUrl" value="@Model.ReturnUrl" />
                        
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                        
                        <div class="mb-3">
                            <label asp-for="Input.Code" class="form-label"></label>
                            <input asp-for="Input.Code" 
                                   class="form-control form-control-lg text-center" 
                                   autocomplete="off" 
                                   aria-required="true" 
                                   placeholder="000000"
                                   maxlength="6"
                                   pattern="\d{6}"
                                   inputmode="numeric" />
                            <span asp-validation-for="Input.Code" class="text-danger"></span>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">Complete Setup</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
```

**Validação:**
- [ ] Instruções passo-a-passo
- [ ] QR code exibido
- [ ] Chave manual disponível
- [ ] Formulário de verificação

### 13.5: Atualizar Register para Redirecionar para TwoFactorSetup

**Ação:** Atualizar Register.cshtml.cs para redirecionar corretamente

**Código já implementado em 12.0:**
```csharp
if (result.Succeeded)
{
    _logger.LogInformation("User {Email} registered successfully", Input.Email);
    
    // Redirecionar para setup de 2FA
    return RedirectToPage("./TwoFactorSetup", new { email = Input.Email, returnUrl });
}
```

**Validação:**
- [ ] Redirecionamento implementado
- [ ] Email passado via query string

### 13.6: Compilar e Testar

**Ação:** Compilar e testar fluxo completo

**Comandos:**
```bash
cd src/MathFlow

# Compilar
dotnet build

# Executar aplicação
dotnet run

# Testar fluxo:
# 1. Registrar novo usuário
# 2. Configurar 2FA (TwoFactorSetup)
# 3. Fazer logout
# 4. Login novamente
# 5. Verificar código 2FA
```

**Validação:**
- [ ] Compilação bem-sucedida
- [ ] Fluxo completo funciona
- [ ] Código 2FA validado corretamente
- [ ] Redirecionamentos corretos

## Sequenciamento

- **Bloqueado por:** 12.0 (Login e Register Pages)
- **Desbloqueia:** 20.0 (Testes de Integração)
- **Paralelizável com:** 14.0 (Google OAuth), 15.0 (Logout)

## Critérios de Aceitação

- [ ] TwoFactor.cshtml e TwoFactor.cshtml.cs implementados
- [ ] TwoFactorSetup.cshtml e TwoFactorSetup.cshtml.cs implementados
- [ ] Validação de código (6 dígitos numéricos)
- [ ] QR code gerado e exibido
- [ ] Integração com UserService
- [ ] Fluxo completo: registro → setup 2FA → login → verificação 2FA
- [ ] Mensagens de erro claras
- [ ] UI responsiva com Bootstrap

## Comandos de Validação

```bash
# Compilar
cd src/MathFlow
dotnet build --no-restore

# Verificar arquivos criados
ls -la Pages/Account/TwoFactor.cshtml*
ls -la Pages/Account/TwoFactorSetup.cshtml*

# Executar e testar
dotnet run
```

## Teste do Mailpit

**Após implementação, testar envio de emails:**

1. **Iniciar Mailpit:**
```bash
docker-compose up -d mailpit
```

2. **Acessar Web UI:**
- Abrir http://localhost:8025
- Verificar que interface está acessível

3. **Testar envio de email:**
```bash
# Executar aplicação
cd src/MathFlow
dotnet run

# Registrar novo usuário
# Emails de confirmação/2FA aparecerão no Mailpit
```

4. **Verificar email recebido:**
- Acessar http://localhost:8025
- Verificar que email aparece na inbox
- Clicar no email para ver conteúdo HTML
- Verificar links e formatação

**Comandos úteis:**
```bash
# Ver logs do Mailpit
docker logs mathflow-mailpit

# Parar Mailpit
docker-compose stop mailpit

# Remover Mailpit
docker-compose down mailpit
```

## Notas de Implementação

- **IEmailSender**: Obrigatório para ASP.NET Core Identity funcionar corretamente
- **Mailpit**: Excelente para desenvolvimento, captura todos os emails sem enviar de verdade
- **Produção**: Substituir Mailpit por SMTP real (SendGrid, AWS SES, etc.)
- **Atenção**: QR code usa serviço externo (qrserver.com) - considerar biblioteca local para produção
- **Dica**: Input com `inputmode="numeric"` facilita digitação em mobile
- **Importante**: Código TOTP expira a cada 30 segundos, usuário deve ser rápido
- **UX**: Auto-submit opcional quando 6 dígitos digitados
- **Próximo passo**: Após conclusão, implementar ExternalLogin (14.0)

## Estimativa

**Tempo estimado:** 1.5 dias (12 horas) - aumentado devido a IEmailSender e Mailpit

## Riscos

- **Baixo**: QR code não renderizar - Mitigação: Fornecer chave manual sempre
- **Baixo**: Código expirar durante digitação - Mitigação: Mensagem clara de erro
- **Médio**: Usuário perder acesso ao authenticator - Mitigação: Recovery codes (Fase 2)

## Referências

- [Two-Factor Authentication in ASP.NET Core](https://learn.microsoft.com/en-us/aspnet/core/security/authentication/2fa)
- [IEmailSender Interface](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.identity.ui.services.iemailsender)
- [Account Confirmation and Password Recovery](https://learn.microsoft.com/en-us/aspnet/core/security/authentication/accconfirm)
- [Mailpit - Email Testing Tool](https://github.com/axllent/mailpit)
- [TOTP RFC 6238](https://datatracker.ietf.org/doc/html/rfc6238)
- [QR Code API](https://goqr.me/api/)
