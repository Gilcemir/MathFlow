---
status: completed
parallelizable: false
blocked_by: ["16.0", "17.0"]
---

<task_context>
<domain>frontend/security</domain>
<type>implementation</type>
<scope>security</scope>
<complexity>low</complexity>
<dependencies>authorization_policies</dependencies>
<unblocks>19.0</unblocks>
</task_context>

# Tarefa 18.0: Aplicar Authorization Policies nas Pages

## Visão Geral

Revisar todas as páginas Razor e aplicar authorization policies apropriadas, garantindo que apenas usuários autorizados possam acessar cada página.

## Requisitos

- [ ] Aplicar policies em todas as páginas
- [ ] Testar acesso negado
- [ ] Criar página AccessDenied
- [ ] Validar redirecionamentos

## Subtarefas

### 18.1: Aplicar Policies em Account Pages

**Páginas públicas (sem [Authorize]):**
- Login.cshtml
- Register.cshtml
- TwoFactor.cshtml
- TwoFactorSetup.cshtml
- ExternalLogin.cshtml

**Páginas com logout:**
- Logout.cshtml (sem [Authorize], mas verifica se está autenticado)

### 18.2: Aplicar Policies em Identity/Manage Pages

**Todas requerem `AuthenticatedUser`:**

```csharp
[Authorize(Policy = AuthorizationPolicies.AuthenticatedUser)]
public class IndexModel : PageModel { }

[Authorize(Policy = AuthorizationPolicies.AuthenticatedUser)]
public class ChangePasswordModel : PageModel { }

[Authorize(Policy = AuthorizationPolicies.AuthenticatedUser)]
public class TwoFactorAuthenticationModel : PageModel { }
```

### 18.3: Aplicar Policies em Admin Pages

**Todas requerem `AdminOnly`:**

```csharp
[Authorize(Policy = AuthorizationPolicies.AdminOnly)]
public class IndexModel : PageModel { }

[Authorize(Policy = AuthorizationPolicies.AdminOnly)]
public class EditModel : PageModel { }
```

### 18.4: Criar AccessDenied Page

**Arquivo:** `src/MathFlow/Pages/Account/AccessDenied.cshtml.cs`

```csharp
using Microsoft.AspNetCore.Mvc.RazorPages;

namespace MathFlow.Pages.Account;

public class AccessDeniedModel : PageModel
{
    public void OnGet()
    {
    }
}
```

**View:**
```html
@page
@model AccessDeniedModel
@{
    ViewData["Title"] = "Access Denied";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="alert alert-danger" role="alert">
                <h4 class="alert-heading">Access Denied</h4>
                <p>You do not have permission to access this page.</p>
                <hr>
                <p class="mb-0">
                    <a asp-page="/Public/Index">Return to home</a>
                </p>
            </div>
        </div>
    </div>
</div>
```

### 18.5: Testar Acesso

**Cenários de teste:**
1. Usuário não autenticado tenta acessar /Identity/Manage → Redireciona para Login
2. Usuário normal tenta acessar /Admin/Users → AccessDenied
3. Admin acessa /Admin/Users → Sucesso
4. Master admin acessa tudo → Sucesso

## Sequenciamento

- **Bloqueado por:** 16.0 (Manage Pages), 17.0 (Admin Pages)
- **Desbloqueia:** 19.0 (TestContainers)
- **Paralelizável com:** Nenhum (revisão final)

## Critérios de Aceitação

- [ ] Todas as páginas com policies corretas
- [ ] AccessDenied page criada
- [ ] Testes de acesso passando
- [ ] Redirecionamentos corretos

## Estimativa

**Tempo estimado:** 0.5 dia (4 horas)
