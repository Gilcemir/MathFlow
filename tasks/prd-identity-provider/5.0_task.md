---
status: completed
parallelizable: false
blocked_by: ["4.0"]
completed_date: 2025-11-02
---

<task_context>
<domain>backend/config</domain>
<type>implementation</type>
<scope>core_feature</scope>
<complexity>medium</complexity>
<dependencies>identity_packages,database</dependencies>
<unblocks>6.0</unblocks>
</task_context>

# Tarefa 5.0: Implementar IdentityConfiguration

## Visão Geral

Implementar a configuração completa do ASP.NET Core Identity, incluindo políticas de senha, lockout, autenticação externa (Google OAuth), e configuração de cookies. Este componente centraliza todas as configurações de Identity em um extension method reutilizável.

## Contexto da Tech Spec

**Referência:** Seção 3.3 da Tech Spec - IdentityConfiguration

Configurações principais:
- **Password policy**: 8+ caracteres, 1 maiúscula, 1 especial
- **Lockout**: 5 tentativas, 5 minutos
- **Google OAuth**: callback `/signin-google`
- **Cookies**: paths customizados para login/logout
- **User settings**: email único obrigatório

## Requisitos

- [ ] Criar extension method `AddIdentityServices`
- [ ] Configurar DbContext com connection string
- [ ] Configurar políticas de senha (PRD requirements)
- [ ] Configurar lockout settings
- [ ] Configurar Google OAuth (condicional)
- [ ] Configurar cookies de autenticação
- [ ] Adicionar documentação XML
- [ ] Validar configuração

## Subtarefas

### 5.1: Criar Classe IdentityConfiguration

**Ação:** Criar classe estática com extension method

**Arquivo:** `src/MathFlow/Infrastructure/IdentityServer/Configuration/IdentityConfiguration.cs`

**Código:**
```csharp
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using MathFlow.Infrastructure.IdentityServer.Data;
using MathFlow.Infrastructure.IdentityServer.Models;

namespace MathFlow.Infrastructure.IdentityServer.Configuration;

/// <summary>
/// Provides extension methods for configuring ASP.NET Core Identity services.
/// </summary>
public static class IdentityConfiguration
{
    /// <summary>
    /// Adds and configures ASP.NET Core Identity services with custom settings.
    /// </summary>
    /// <param name="services">The service collection to add services to.</param>
    /// <param name="configuration">The application configuration.</param>
    /// <returns>The service collection for chaining.</returns>
    public static IServiceCollection AddIdentityServices(
        this IServiceCollection services,
        IConfiguration configuration)
    {
        // Implementação nas próximas subtarefas
        return services;
    }
}
```

**Validação:**
- [ ] Arquivo criado em `Infrastructure/IdentityServer/Configuration/`
- [ ] Namespace correto
- [ ] Classe estática
- [ ] Extension method com documentação XML

### 5.2: Configurar DbContext

**Ação:** Adicionar ApplicationDbContext ao DI container

**Código a adicionar no método `AddIdentityServices`:**
```csharp
// Configurar DbContext
var connectionString = configuration.GetConnectionString("DefaultConnection");
if (string.IsNullOrEmpty(connectionString))
{
    throw new InvalidOperationException(
        "Connection string 'DefaultConnection' not found in configuration");
}

services.AddDbContext<ApplicationDbContext>(options =>
    options.UseNpgsql(connectionString));
```

**Validação:**
- [ ] Connection string lida de `appsettings.json`
- [ ] Exceção lançada se connection string não encontrada
- [ ] PostgreSQL provider configurado

### 5.3: Configurar Identity Core

**Ação:** Adicionar Identity com políticas customizadas

**Código a adicionar:**
```csharp
// Configurar Identity
services.AddIdentity<ApplicationUser, IdentityRole>(options =>
{
    // Password settings (PRD: mínimo 8 caracteres, 1 maiúscula, 1 especial)
    options.Password.RequireDigit = false;
    options.Password.RequireLowercase = false;
    options.Password.RequireNonAlphanumeric = true;
    options.Password.RequireUppercase = true;
    options.Password.RequiredLength = 8;
    options.Password.RequiredUniqueChars = 1;

    // Lockout settings
    options.Lockout.DefaultLockoutTimeSpan = TimeSpan.FromMinutes(5);
    options.Lockout.MaxFailedAccessAttempts = 5;
    options.Lockout.AllowedForNewUsers = true;

    // User settings
    options.User.RequireUniqueEmail = true;

    // Sign-in settings
    options.SignIn.RequireConfirmedAccount = false; // MVP: sem confirmação de email
    options.SignIn.RequireConfirmedEmail = false;
})
.AddEntityFrameworkStores<ApplicationDbContext>()
.AddDefaultTokenProviders();
```

**Validação:**
- [ ] Password policy: 8+ caracteres, 1 maiúscula, 1 especial
- [ ] Lockout: 5 tentativas, 5 minutos
- [ ] Email único obrigatório
- [ ] Confirmação de email desabilitada (MVP)
- [ ] Token providers adicionados (necessário para 2FA)

### 5.4: Configurar Google OAuth

**Ação:** Adicionar autenticação externa via Google (condicional)

**Código a adicionar:**
```csharp
// Configurar autenticação externa (Google)
var googleClientId = configuration["Authentication:Google:ClientId"];
var googleClientSecret = configuration["Authentication:Google:ClientSecret"];

if (!string.IsNullOrEmpty(googleClientId) && !string.IsNullOrEmpty(googleClientSecret))
{
    services.AddAuthentication()
        .AddGoogle(options =>
        {
            options.ClientId = googleClientId;
            options.ClientSecret = googleClientSecret;
            options.CallbackPath = "/signin-google";
        });
}
```

**Validação:**
- [ ] Configuração condicional (não quebra se credenciais ausentes)
- [ ] Client ID e Secret lidos de configuration
- [ ] Callback path customizado: `/signin-google`

### 5.5: Configurar Cookies

**Ação:** Customizar paths e configurações de cookies

**Código a adicionar:**
```csharp
// Configurar cookies
services.ConfigureApplicationCookie(options =>
{
    options.LoginPath = "/Account/Login";
    options.LogoutPath = "/Account/Logout";
    options.AccessDeniedPath = "/Account/AccessDenied";
    options.ExpireTimeSpan = TimeSpan.FromDays(7);
    options.SlidingExpiration = true;
    options.Cookie.HttpOnly = true;
    options.Cookie.SecurePolicy = CookieSecurePolicy.Always;
    options.Cookie.SameSite = SameSiteMode.Lax;
});
```

**Validação:**
- [ ] Paths customizados para páginas de Account
- [ ] Cookie expira em 7 dias
- [ ] Sliding expiration habilitado
- [ ] HttpOnly e Secure configurados
- [ ] SameSite configurado como Lax

### 5.6: Adicionar Using Statements

**Ação:** Garantir todos os imports necessários

**Using statements completos:**
```csharp
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using MathFlow.Infrastructure.IdentityServer.Data;
using MathFlow.Infrastructure.IdentityServer.Models;
```

**Validação:**
- [ ] Todos os tipos resolvidos
- [ ] Nenhum using desnecessário

### 5.7: Validar Configuração

**Ação:** Compilar e testar configuração

**Comandos:**
```bash
cd src/MathFlow

# Compilar
dotnet build

# Verificar warnings
dotnet build 2>&1 | grep -i warning | grep -i identity
```

**Validação:**
- [ ] Compilação bem-sucedida
- [ ] Zero warnings relacionados a Identity
- [ ] Extension method acessível

## Código Completo

**Arquivo final:** `src/MathFlow/Infrastructure/IdentityServer/Configuration/IdentityConfiguration.cs`

```csharp
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using MathFlow.Infrastructure.IdentityServer.Data;
using MathFlow.Infrastructure.IdentityServer.Models;

namespace MathFlow.Infrastructure.IdentityServer.Configuration;

/// <summary>
/// Provides extension methods for configuring ASP.NET Core Identity services.
/// </summary>
public static class IdentityConfiguration
{
    /// <summary>
    /// Adds and configures ASP.NET Core Identity services with custom settings.
    /// </summary>
    /// <param name="services">The service collection to add services to.</param>
    /// <param name="configuration">The application configuration.</param>
    /// <returns>The service collection for chaining.</returns>
    public static IServiceCollection AddIdentityServices(
        this IServiceCollection services,
        IConfiguration configuration)
    {
        // Configurar DbContext
        var connectionString = configuration.GetConnectionString("DefaultConnection");
        if (string.IsNullOrEmpty(connectionString))
        {
            throw new InvalidOperationException(
                "Connection string 'DefaultConnection' not found in configuration");
        }

        services.AddDbContext<ApplicationDbContext>(options =>
            options.UseNpgsql(connectionString));

        // Configurar Identity
        services.AddIdentity<ApplicationUser, IdentityRole>(options =>
        {
            // Password settings (PRD: mínimo 8 caracteres, 1 maiúscula, 1 especial)
            options.Password.RequireDigit = false;
            options.Password.RequireLowercase = false;
            options.Password.RequireNonAlphanumeric = true;
            options.Password.RequireUppercase = true;
            options.Password.RequiredLength = 8;
            options.Password.RequiredUniqueChars = 1;

            // Lockout settings
            options.Lockout.DefaultLockoutTimeSpan = TimeSpan.FromMinutes(5);
            options.Lockout.MaxFailedAccessAttempts = 5;
            options.Lockout.AllowedForNewUsers = true;

            // User settings
            options.User.RequireUniqueEmail = true;

            // Sign-in settings
            options.SignIn.RequireConfirmedAccount = false;
            options.SignIn.RequireConfirmedEmail = false;
        })
        .AddEntityFrameworkStores<ApplicationDbContext>()
        .AddDefaultTokenProviders();

        // Configurar autenticação externa (Google)
        var googleClientId = configuration["Authentication:Google:ClientId"];
        var googleClientSecret = configuration["Authentication:Google:ClientSecret"];

        if (!string.IsNullOrEmpty(googleClientId) && !string.IsNullOrEmpty(googleClientSecret))
        {
            services.AddAuthentication()
                .AddGoogle(options =>
                {
                    options.ClientId = googleClientId;
                    options.ClientSecret = googleClientSecret;
                    options.CallbackPath = "/signin-google";
                });
        }

        // Configurar cookies
        services.ConfigureApplicationCookie(options =>
        {
            options.LoginPath = "/Account/Login";
            options.LogoutPath = "/Account/Logout";
            options.AccessDeniedPath = "/Account/AccessDenied";
            options.ExpireTimeSpan = TimeSpan.FromDays(7);
            options.SlidingExpiration = true;
            options.Cookie.HttpOnly = true;
            options.Cookie.SecurePolicy = CookieSecurePolicy.Always;
            options.Cookie.SameSite = SameSiteMode.Lax;
        });

        return services;
    }
}
```

## Sequenciamento

- **Bloqueado por:** 4.0 (Criar e Aplicar Migration Inicial)
- **Desbloqueia:** 6.0 (Implementar AuthorizationPolicies)
- **Paralelizável com:** Nenhum (dependência sequencial)

## Critérios de Aceitação

- [ ] Extension method `AddIdentityServices` implementado
- [ ] DbContext configurado com PostgreSQL
- [ ] Password policy conforme PRD (8+ caracteres, 1 maiúscula, 1 especial)
- [ ] Lockout configurado (5 tentativas, 5 minutos)
- [ ] Google OAuth configurado (condicional)
- [ ] Cookies customizados com paths corretos
- [ ] Documentação XML completa
- [ ] Compilação sem erros ou warnings

## Comandos de Validação

```bash
# Compilar
cd src/MathFlow
dotnet build --no-restore

# Verificar arquivo criado
ls -la Infrastructure/IdentityServer/Configuration/IdentityConfiguration.cs

# Verificar que extension method está acessível (via grep)
grep -n "AddIdentityServices" Infrastructure/IdentityServer/Configuration/IdentityConfiguration.cs
```

## Notas de Implementação

- **Atenção**: `AddDefaultTokenProviders()` é essencial para 2FA funcionar
- **Dica**: Configuração condicional de Google OAuth evita erros em ambientes sem credenciais
- **Importante**: `CookieSecurePolicy.Always` força HTTPS, ajustar para desenvolvimento se necessário
- **Segurança**: `HttpOnly = true` previne acesso via JavaScript, `SameSite = Lax` protege contra CSRF
- **Próximo passo**: Após conclusão, implementar AuthorizationPolicies (6.0)

## Estimativa

**Tempo estimado:** 1 dia (8 horas)

## Riscos

- **Baixo**: Connection string não encontrada - Mitigação: Validação com exceção clara
- **Baixo**: Google OAuth quebrar sem credenciais - Mitigação: Configuração condicional
- **Médio**: Password policy muito restritiva - Mitigação: Seguir exatamente requisitos do PRD

## Referências

- [Identity Configuration](https://learn.microsoft.com/en-us/aspnet/core/security/authentication/identity-configuration)
- [Google Authentication](https://learn.microsoft.com/en-us/aspnet/core/security/authentication/social/google-logins)
- [Cookie Authentication](https://learn.microsoft.com/en-us/aspnet/core/security/authentication/cookie)
