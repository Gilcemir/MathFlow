---
status: completed
parallelizable: true
blocked_by: ["10.0", "16.0"]
---

<task_context>
<domain>frontend/pages</domain>
<type>implementation</type>
<scope>admin_feature</scope>
<complexity>medium</complexity>
<dependencies>role_service</dependencies>
<unblocks>18.0</unblocks>
</task_context>

# Tarefa 17.0: Criar Páginas Admin

## Visão Geral

Implementar páginas administrativas para gerenciar usuários e atribuir roles. Apenas acessíveis para usuários com policy `AdminOnly`.

## Requisitos

- [ ] Criar Admin/Users/Index.cshtml (listagem)
- [ ] Criar Admin/Users/Edit.cshtml (editar roles)
- [ ] Aplicar policy `AdminOnly`
- [ ] Integração com RoleService
- [ ] Paginação de usuários

## Páginas a Implementar

### 17.1: Admin/Users/Index (Listagem)

**Arquivo:** `src/MathFlow/Pages/Admin/Users/Index.cshtml.cs`

```csharp
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.EntityFrameworkCore;
using MathFlow.Infrastructure.IdentityServer.Models;
using MathFlow.Infrastructure.IdentityServer.Configuration;

namespace MathFlow.Pages.Admin.Users;

[Authorize(Policy = AuthorizationPolicies.AdminOnly)]
public class IndexModel : PageModel
{
    private readonly UserManager<ApplicationUser> _userManager;

    public IndexModel(UserManager<ApplicationUser> userManager)
    {
        _userManager = userManager;
    }

    public List<UserViewModel> Users { get; set; } = new();

    public class UserViewModel
    {
        public string Id { get; set; } = string.Empty;
        public string UserName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public bool EmailConfirmed { get; set; }
        public bool TwoFactorEnabled { get; set; }
        public List<string> Roles { get; set; } = new();
    }

    public async Task OnGetAsync()
    {
        var users = await _userManager.Users.ToListAsync();

        foreach (var user in users)
        {
            var roles = await _userManager.GetRolesAsync(user);
            Users.Add(new UserViewModel
            {
                Id = user.Id,
                UserName = user.UserName!,
                Email = user.Email!,
                EmailConfirmed = user.EmailConfirmed,
                TwoFactorEnabled = user.TwoFactorEnabled,
                Roles = roles.ToList()
            });
        }
    }
}
```

**View:** Tabela com usuários, exibindo email, roles, 2FA status, link para editar.

### 17.2: Admin/Users/Edit (Editar Roles)

**Arquivo:** `src/MathFlow/Pages/Admin/Users/Edit.cshtml.cs`

```csharp
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.AspNetCore.Mvc.Rendering;
using MathFlow.Application.Services.Identity;
using MathFlow.Infrastructure.IdentityServer.Models;
using MathFlow.Infrastructure.IdentityServer.Configuration;
using System.ComponentModel.DataAnnotations;

namespace MathFlow.Pages.Admin.Users;

[Authorize(Policy = AuthorizationPolicies.AdminOnly)]
public class EditModel : PageModel
{
    private readonly UserManager<ApplicationUser> _userManager;
    private readonly RoleService _roleService;

    public EditModel(UserManager<ApplicationUser> userManager, RoleService roleService)
    {
        _userManager = userManager;
        _roleService = roleService;
    }

    public string UserId { get; set; } = string.Empty;
    public string UserName { get; set; } = string.Empty;
    public string Email { get; set; } = string.Empty;
    public List<string> CurrentRoles { get; set; } = new();

    [BindProperty]
    public InputModel Input { get; set; } = new();

    public List<SelectListItem> AvailableRoles { get; set; } = new();

    public class InputModel
    {
        [Required]
        public string SelectedRole { get; set; } = string.Empty;
    }

    public async Task<IActionResult> OnGetAsync(string id)
    {
        if (string.IsNullOrEmpty(id))
        {
            return NotFound();
        }

        var user = await _userManager.FindByIdAsync(id);
        if (user == null)
        {
            return NotFound();
        }

        UserId = user.Id;
        UserName = user.UserName!;
        Email = user.Email!;
        CurrentRoles = (await _roleService.GetUserRolesAsync(user.Id)).ToList();

        // Roles disponíveis (exceto masterAdmin)
        AvailableRoles = new List<SelectListItem>
        {
            new SelectListItem { Value = "normal", Text = "Normal" },
            new SelectListItem { Value = "premium", Text = "Premium" },
            new SelectListItem { Value = "admin", Text = "Admin" }
        };

        return Page();
    }

    public async Task<IActionResult> OnPostAsync(string id)
    {
        if (!ModelState.IsValid)
        {
            return await OnGetAsync(id);
        }

        var result = await _roleService.AssignRoleAsync(id, Input.SelectedRole);

        if (result.Succeeded)
        {
            TempData["StatusMessage"] = "Role updated successfully.";
            return RedirectToPage("./Index");
        }

        foreach (var error in result.Errors)
        {
            ModelState.AddModelError(string.Empty, error.Description);
        }

        return await OnGetAsync(id);
    }
}
```

**View:** Formulário com dropdown de roles, botão salvar, exibir roles atuais.

## Sequenciamento

- **Bloqueado por:** 10.0 (RoleService), 16.0 (Manage Pages)
- **Desbloqueia:** 18.0 (Apply Policies)
- **Paralelizável com:** Nenhum (depende de 10.0 e 16.0)

## Critérios de Aceitação

- [ ] 2 páginas Admin implementadas
- [ ] Policy `AdminOnly` aplicada
- [ ] Listagem de usuários funcionando
- [ ] Edição de roles funcionando
- [ ] Master admin protegido

## Estimativa

**Tempo estimado:** 1 dia (8 horas)
