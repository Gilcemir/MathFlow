---
status: completed
parallelizable: false
blocked_by: ["6.0"]
completed_date: 2025-11-02
---

<task_context>
<domain>backend/data</domain>
<type>implementation</type>
<scope>core_feature</scope>
<complexity>medium</complexity>
<dependencies>identity_config,roles</dependencies>
<unblocks>8.0</unblocks>
</task_context>

# Tarefa 7.0: Configurar Data Seeding via EF Core

## Visão Geral

Configurar **EF Core Data Seeding** no `ApplicationDbContext` para criar automaticamente roles estáticas e o usuário master admin via migrations. Esta abordagem é mais robusta e automática do que seeding manual no `Program.cs`.

## Contexto da Tech Spec

**Referência:** Seção 3.5 da Tech Spec - IdentitySeeder (refatorado para EF Core Seeding)

Responsabilidades:
- Criar 4 roles estáticas via `HasData`: `masterAdmin`, `admin`, `premium`, `normal`
- Criar usuário master admin via `HasData`
- Master admin não requer 2FA
- Seed executado automaticamente ao aplicar migrations

## Requisitos

- [ ] Configurar seed de roles no `OnModelCreating`
- [ ] Configurar seed de master admin no `OnModelCreating`
- [ ] Gerar IDs determinísticos para seed data
- [ ] Master admin sem 2FA obrigatório
- [ ] Criar migration com seed data
- [ ] Validar seed após aplicar migration

## Subtarefas

### 7.1: Criar Classe IdentitySeeder

**Ação:** Criar classe estática com método SeedAsync

**Arquivo:** `src/MathFlow/Infrastructure/IdentityServer/Seeders/IdentitySeeder.cs`

**Código:**
```csharp
using Microsoft.AspNetCore.Identity;
using MathFlow.Infrastructure.IdentityServer.Models;

namespace MathFlow.Infrastructure.IdentityServer.Seeders;

/// <summary>
/// Provides methods for seeding initial Identity data (roles and users).
/// </summary>
public static class IdentitySeeder
{
    /// <summary>
    /// Seeds roles and master admin user if they do not exist.
    /// </summary>
    /// <param name="serviceProvider">The service provider to resolve dependencies.</param>
    /// <param name="configuration">The application configuration.</param>
    public static async Task SeedAsync(
        IServiceProvider serviceProvider,
        IConfiguration configuration)
    {
        // Implementação nas próximas subtarefas
    }
}
```

**Validação:**
- [ ] Arquivo criado em `Infrastructure/IdentityServer/Seeders/`
- [ ] Namespace correto
- [ ] Classe estática
- [ ] Método assíncrono com documentação XML

### 7.2: Resolver Dependências

**Ação:** Obter RoleManager e UserManager do service provider

**Código a adicionar no método `SeedAsync`:**
```csharp
var roleManager = serviceProvider.GetRequiredService<RoleManager<IdentityRole>>();
var userManager = serviceProvider.GetRequiredService<UserManager<ApplicationUser>>();
```

**Validação:**
- [ ] `RoleManager<IdentityRole>` resolvido
- [ ] `UserManager<ApplicationUser>` resolvido
- [ ] Usar `GetRequiredService` para garantir exceção se não encontrado

### 7.3: Seed de Roles

**Ação:** Criar 4 roles estáticas se não existirem

**Código a adicionar:**
```csharp
// Seed roles
string[] roles = { "masterAdmin", "admin", "premium", "normal" };
foreach (var role in roles)
{
    if (!await roleManager.RoleExistsAsync(role))
    {
        var result = await roleManager.CreateAsync(new IdentityRole(role));
        if (!result.Succeeded)
        {
            throw new InvalidOperationException(
                $"Failed to create role '{role}': {string.Join(", ", result.Errors.Select(e => e.Description))}");
        }
    }
}
```

**Validação:**
- [ ] 4 roles criadas: masterAdmin, admin, premium, normal
- [ ] Verificação idempotente (`RoleExistsAsync`)
- [ ] Exceção lançada se criação falhar
- [ ] Mensagem de erro descritiva

### 7.4: Ler Credenciais do Master Admin

**Ação:** Obter email e senha do configuration

**Código a adicionar:**
```csharp
// Seed master admin
var masterEmail = configuration["Identity:MasterAdmin:Email"];
var masterPassword = configuration["Identity:MasterAdmin:Password"];

if (string.IsNullOrEmpty(masterEmail) || string.IsNullOrEmpty(masterPassword))
{
    throw new InvalidOperationException(
        "Master admin credentials not configured in appsettings. " +
        "Please set Identity:MasterAdmin:Email and Identity:MasterAdmin:Password");
}
```

**Validação:**
- [ ] Email lido de `Identity:MasterAdmin:Email`
- [ ] Senha lida de `Identity:MasterAdmin:Password`
- [ ] Exceção lançada se credenciais ausentes
- [ ] Mensagem de erro clara

### 7.5: Criar Master Admin

**Ação:** Criar usuário master admin se não existir

**Código a adicionar:**
```csharp
var masterUser = await userManager.FindByEmailAsync(masterEmail);
if (masterUser == null)
{
    masterUser = new ApplicationUser
    {
        UserName = masterEmail,
        Email = masterEmail,
        EmailConfirmed = true,
        TwoFactorEnabled = false // Master admin não requer 2FA
    };

    var result = await userManager.CreateAsync(masterUser, masterPassword);
    if (result.Succeeded)
    {
        await userManager.AddToRoleAsync(masterUser, "masterAdmin");
    }
    else
    {
        throw new InvalidOperationException(
            $"Failed to create master admin: {string.Join(", ", result.Errors.Select(e => e.Description))}");
    }
}
```

**Validação:**
- [ ] Verificação idempotente (`FindByEmailAsync`)
- [ ] `TwoFactorEnabled = false` para master admin
- [ ] `EmailConfirmed = true` para evitar bloqueios
- [ ] Role `masterAdmin` atribuída
- [ ] Exceção lançada se criação falhar

### 7.6: Adicionar Logging (Opcional)

**Ação:** Adicionar logging para rastreabilidade

**Código a adicionar (se logger disponível):**
```csharp
// No início do método, resolver logger
var logger = serviceProvider.GetService<ILogger<IdentitySeeder>>();

// Após criar roles
logger?.LogInformation("Roles seeded successfully");

// Após criar master admin
logger?.LogInformation("Master admin user created: {Email}", masterEmail);

// Se master admin já existe
logger?.LogInformation("Master admin user already exists: {Email}", masterEmail);
```

**Validação:**
- [ ] Logger resolvido (opcional, não obrigatório)
- [ ] Logging de eventos importantes
- [ ] Não logar senha

### 7.4: (Opcional) Configurar Auto-Migration no Startup

**Ação:** Adicionar código para aplicar migrations automaticamente no startup da aplicação

**Nota:** Esta subtarefa será detalhada na tarefa 8.0, mas pode ser implementada aqui se preferir automação total.

**Código a adicionar no `Program.cs` (após `app.Build()`):**
```

**Validação:**
- [ ] Compilação bem-sucedida
- [ ] Zero warnings relacionados a Seeder

## Código Completo

**Arquivo final:** `src/MathFlow/Infrastructure/IdentityServer/Seeders/IdentitySeeder.cs`

```csharp
using Microsoft.AspNetCore.Identity;
using MathFlow.Infrastructure.IdentityServer.Models;

namespace MathFlow.Infrastructure.IdentityServer.Seeders;

/// <summary>
/// Provides methods for seeding initial Identity data (roles and users).
/// </summary>
public static class IdentitySeeder
{
    /// <summary>
    /// Seeds roles and master admin user if they do not exist.
    /// </summary>
    /// <param name="serviceProvider">The service provider to resolve dependencies.</param>
    /// <param name="configuration">The application configuration.</param>
    public static async Task SeedAsync(
        IServiceProvider serviceProvider,
        IConfiguration configuration)
    {
        var roleManager = serviceProvider.GetRequiredService<RoleManager<IdentityRole>>();
        var userManager = serviceProvider.GetRequiredService<UserManager<ApplicationUser>>();

        // Seed roles
        string[] roles = { "masterAdmin", "admin", "premium", "normal" };
        foreach (var role in roles)
        {
            if (!await roleManager.RoleExistsAsync(role))
            {
                var result = await roleManager.CreateAsync(new IdentityRole(role));
                if (!result.Succeeded)
                {
                    throw new InvalidOperationException(
                        $"Failed to create role '{role}': {string.Join(", ", result.Errors.Select(e => e.Description))}");
                }
            }
        }

        // Seed master admin
        var masterEmail = configuration["Identity:MasterAdmin:Email"];
        var masterPassword = configuration["Identity:MasterAdmin:Password"];

        if (string.IsNullOrEmpty(masterEmail) || string.IsNullOrEmpty(masterPassword))
        {
            throw new InvalidOperationException(
                "Master admin credentials not configured in appsettings. " +
                "Please set Identity:MasterAdmin:Email and Identity:MasterAdmin:Password");
        }

        var masterUser = await userManager.FindByEmailAsync(masterEmail);
        if (masterUser == null)
        {
            masterUser = new ApplicationUser
            {
                UserName = masterEmail,
                Email = masterEmail,
                EmailConfirmed = true,
                TwoFactorEnabled = false // Master admin não requer 2FA
            };

            var result = await userManager.CreateAsync(masterUser, masterPassword);
            if (result.Succeeded)
            {
                await userManager.AddToRoleAsync(masterUser, "masterAdmin");
            }
            else
            {
                throw new InvalidOperationException(
                    $"Failed to create master admin: {string.Join(", ", result.Errors.Select(e => e.Description))}");
            }
        }
    }
}
```

## Configuração Necessária

**appsettings.Development.json:**
```json
{
  "Identity": {
    "MasterAdmin": {
      "Email": "admin@mathflow.local",
      "Password": "Dev@1234"
    }
  }
}
```

**appsettings.json (produção):**
```json
{
  "Identity": {
    "MasterAdmin": {
      "Email": "admin@mathflow.com",
      "Password": ""  // Ler de variável de ambiente
    }
  }
}
```

## Sequenciamento

- **Bloqueado por:** 6.0 (Implementar AuthorizationPolicies)
- **Desbloqueia:** 8.0 (Integrar Identity no Program.cs)
- **Paralelizável com:** Nenhum (dependência sequencial)

## Critérios de Aceitação

- [ ] Método `SeedAsync` implementado
- [ ] 4 roles criadas: masterAdmin, admin, premium, normal
- [ ] Master admin criado com credenciais do appsettings
- [ ] Master admin sem 2FA (`TwoFactorEnabled = false`)
- [ ] Lógica idempotente (não duplica se já existe)
- [ ] Exceções lançadas com mensagens claras
- [ ] Compilação sem erros ou warnings

## Comandos de Validação

```bash
# Compilar
cd src/MathFlow
dotnet build --no-restore

# Verificar arquivo criado
ls -la Infrastructure/IdentityServer/Seeders/IdentitySeeder.cs

# Verificar método SeedAsync
grep -n "SeedAsync" Infrastructure/IdentityServer/Seeders/IdentitySeeder.cs
```

## Notas de Implementação

- **Atenção**: Seeder deve ser chamado APÓS `app.Build()` mas ANTES de `app.Run()` no Program.cs
- **Dica**: Usar scope para resolver serviços garante que DbContext seja descartado corretamente
- **Importante**: Master admin sem 2FA é requisito do PRD para acesso durante incidentes
- **Segurança**: Em produção, senha deve vir de variável de ambiente, não hardcoded
- **Próximo passo**: Após conclusão, integrar seeder no Program.cs (8.0)

## Estimativa

**Tempo estimado:** 1 dia (8 horas)

## Riscos

- **Baixo**: Credenciais não configuradas - Mitigação: Exceção clara com instruções
- **Baixo**: Password policy não satisfeita - Mitigação: Documentar requisitos mínimos
- **Médio**: Seed falhar silenciosamente - Mitigação: Lançar exceções, não apenas logar

## Teste Manual

**Após integração no Program.cs (tarefa 8.0):**
```bash
# Executar aplicação
cd src/MathFlow
dotnet run

# Verificar roles criadas
docker exec -it mathflow-postgres psql -U mathflow -d mathflow_dev \
  -c "SELECT * FROM \"Roles\";"

# Verificar master admin criado
docker exec -it mathflow-postgres psql -U mathflow -d mathflow_dev \
  -c "SELECT \"Id\", \"UserName\", \"Email\", \"TwoFactorEnabled\" FROM \"Users\";"

# Verificar role atribuída
docker exec -it mathflow-postgres psql -U mathflow -d mathflow_dev \
  -c "SELECT u.\"Email\", r.\"Name\" FROM \"Users\" u 
      JOIN \"UserRoles\" ur ON u.\"Id\" = ur.\"UserId\"
      JOIN \"Roles\" r ON ur.\"RoleId\" = r.\"Id\";"
```

## Alternativa: EF Core Data Seeding (Recomendado)

**Nota:** Ao invés de usar `IdentitySeeder` manual, você pode usar **EF Core Data Seeding** via `HasData` no `ApplicationDbContext.OnModelCreating`. Esta abordagem é mais robusta e automática.

**Vantagens:**
- ✅ Seed data incluído nas migrations
- ✅ Aplicado automaticamente com `dotnet ef database update`
- ✅ Não precisa chamar seeder no `Program.cs`
- ✅ Idempotente por padrão

**Implementação:**
Ver exemplo completo na subtarefa 7.1 (código já incluído acima com `HasData`).

**Para aplicar automaticamente no startup:**
```csharp
// No Program.cs, após app.Build()
using (var scope = app.Services.CreateScope())
{
    var dbContext = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();
    dbContext.Database.Migrate(); // Aplica migrations pendentes automaticamente
}
```

## Referências

- [Data Seeding in EF Core](https://learn.microsoft.com/en-us/ef/core/modeling/data-seeding)
- [Applying Migrations at Runtime](https://learn.microsoft.com/en-us/ef/core/managing-schemas/migrations/applying#apply-migrations-at-runtime)
- [RoleManager Class](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.identity.rolemanager-1)
- [UserManager Class](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.identity.usermanager-1)
