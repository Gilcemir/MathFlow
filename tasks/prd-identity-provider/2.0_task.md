---
status: completed
parallelizable: false
blocked_by: ["1.0"]
---

<task_context>
<domain>backend/infra</domain>
<type>implementation</type>
<scope>dependencies</scope>
<complexity>low</complexity>
<dependencies>1.0</dependencies>
<unblocks>3.0</unblocks>
</task_context>

# Tarefa 2.0: Configuração de Pacotes NuGet e Dependências

## Visão Geral

Adicionar todos os pacotes NuGet necessários para implementar o Identity Provider com ASP.NET Core Identity, Entity Framework Core, Google OAuth e TestContainers. Esta tarefa garante que todas as dependências estejam disponíveis antes de iniciar a implementação dos componentes.

## Contexto da Tech Spec

**Referência:** Seção 6 da Tech Spec - Pacotes NuGet

Pacotes principais:
- `Microsoft.AspNetCore.Identity.EntityFrameworkCore` 9.0.0
- `Microsoft.AspNetCore.Identity.UI` 9.0.0
- `Microsoft.AspNetCore.Authentication.Google` 9.0.0
- `Npgsql.EntityFrameworkCore.PostgreSQL` 9.0.0
- `Microsoft.EntityFrameworkCore.Design` 9.0.0
- `Testcontainers.PostgreSql` (para testes)

## Requisitos

- [ ] Adicionar pacotes Identity ao projeto principal
- [ ] Adicionar pacotes Entity Framework Core
- [ ] Adicionar pacote Google Authentication
- [ ] Adicionar pacotes TestContainers aos projetos de teste
- [ ] Restaurar pacotes e validar instalação
- [ ] Verificar compatibilidade de versões

## Subtarefas

### 2.1: Adicionar Pacotes Identity

**Ação:** Instalar pacotes do ASP.NET Core Identity

**Comandos:**
```bash
cd src/MathFlow

dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore --version 9.0.0
dotnet add package Microsoft.AspNetCore.Identity.UI --version 9.0.0
```

**Validação:**
- [ ] Pacote `Microsoft.AspNetCore.Identity.EntityFrameworkCore` adicionado
- [ ] Pacote `Microsoft.AspNetCore.Identity.UI` adicionado
- [ ] Versões corretas (9.0.0) instaladas

### 2.2: Adicionar Pacotes Entity Framework Core

**Ação:** Instalar pacotes do EF Core para PostgreSQL

**Comandos:**
```bash
cd src/MathFlow

dotnet add package Npgsql.EntityFrameworkCore.PostgreSQL --version 9.0.0
dotnet add package Microsoft.EntityFrameworkCore.Design --version 9.0.0
```

**Validação:**
- [ ] Pacote `Npgsql.EntityFrameworkCore.PostgreSQL` adicionado
- [ ] Pacote `Microsoft.EntityFrameworkCore.Design` adicionado
- [ ] Versões corretas (9.0.0) instaladas

### 2.3: Adicionar Pacote Google Authentication

**Ação:** Instalar pacote para autenticação externa via Google OAuth

**Comandos:**
```bash
cd src/MathFlow

dotnet add package Microsoft.AspNetCore.Authentication.Google --version 9.0.0
```

**Validação:**
- [ ] Pacote `Microsoft.AspNetCore.Authentication.Google` adicionado
- [ ] Versão correta (9.0.0) instalada

### 2.4: Adicionar Pacotes TestContainers

**Ação:** Instalar TestContainers para testes de integração com PostgreSQL real

**Comandos:**
```bash
# Testes de integração
cd tests/MathFlow.IntegrationTests

dotnet add package Testcontainers.PostgreSql --version 3.10.0
dotnet add package Microsoft.AspNetCore.Mvc.Testing --version 9.0.0
```

**Validação:**
- [ ] Pacote `Testcontainers.PostgreSql` adicionado ao projeto de testes
- [ ] Pacote `Microsoft.AspNetCore.Mvc.Testing` adicionado
- [ ] Versões compatíveis instaladas

### 2.5: Restaurar e Validar Pacotes

**Ação:** Restaurar todos os pacotes e validar instalação

**Comandos:**
```bash
# Restaurar pacotes do projeto principal
cd src/MathFlow
dotnet restore

# Restaurar pacotes dos testes
cd ../../tests/MathFlow.UnitTests
dotnet restore

cd ../MathFlow.IntegrationTests
dotnet restore

# Validar build
cd ../../src/MathFlow
dotnet build
```

**Validação:**
- [ ] Restore executado sem erros
- [ ] Build executado sem erros
- [ ] Nenhum conflito de versões reportado

### 2.6: Verificar MathFlow.csproj

**Ação:** Validar que o arquivo `.csproj` contém todos os pacotes

**Arquivo:** `src/MathFlow/MathFlow.csproj`

**Validação manual:**
```xml
<ItemGroup>
  <!-- Identity packages -->
  <PackageReference Include="Microsoft.AspNetCore.Identity.EntityFrameworkCore" Version="9.0.0" />
  <PackageReference Include="Microsoft.AspNetCore.Identity.UI" Version="9.0.0" />
  <PackageReference Include="Microsoft.AspNetCore.Authentication.Google" Version="9.0.0" />
  
  <!-- Entity Framework Core -->
  <PackageReference Include="Npgsql.EntityFrameworkCore.PostgreSQL" Version="9.0.0" />
  <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="9.0.0">
    <PrivateAssets>all</PrivateAssets>
    <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
  </PackageReference>
  
  <!-- Existing packages -->
  <PackageReference Include="DocumentFormat.OpenXml" Version="3.3.0" />
  <PackageReference Include="Jering.Javascript.NodeJS" Version="7.0.0" />
  
  <!-- OpenTelemetry packages (já existentes) -->
  <PackageReference Include="OpenTelemetry" Version="1.10.0" />
  <!-- ... outros pacotes OpenTelemetry ... -->
</ItemGroup>
```

**Validação:**
- [ ] Todos os pacotes Identity presentes
- [ ] Todos os pacotes EF Core presentes
- [ ] Pacote Google Authentication presente
- [ ] Pacotes existentes preservados

## Sequenciamento

- **Bloqueado por:** 1.0 (Setup Inicial)
- **Desbloqueia:** 3.0 (Implementar ApplicationUser e ApplicationDbContext)
- **Paralelizável com:** Nenhum (dependência sequencial)

## Critérios de Aceitação

- [ ] Todos os pacotes NuGet instalados com versões corretas
- [ ] Projeto compila sem erros
- [ ] Nenhum conflito de dependências
- [ ] TestContainers configurado nos testes de integração
- [ ] Arquivo `.csproj` atualizado corretamente

## Comandos de Validação

```bash
# Listar pacotes instalados
cd src/MathFlow
dotnet list package

# Verificar versões específicas
dotnet list package | grep Identity
dotnet list package | grep EntityFrameworkCore
dotnet list package | grep Google

# Validar build
dotnet build --no-restore

# Verificar warnings
dotnet build --no-restore 2>&1 | grep -i warning
```

## Notas de Implementação

- **Atenção**: Usar sempre versão 9.0.0 para pacotes Microsoft para garantir compatibilidade com .NET 9.0
- **Dica**: O pacote `Microsoft.EntityFrameworkCore.Design` é necessário para comandos `dotnet ef migrations`
- **Importante**: TestContainers requer Docker rodando localmente para testes de integração
- **Próximo passo**: Após conclusão, iniciar tarefa 3.0 para implementar modelos e contexto

## Estimativa

**Tempo estimado:** 0.5 dia (4 horas)

## Riscos

- **Baixo**: Conflito de versões com pacotes existentes - Mitigação: Usar versões compatíveis com .NET 9.0
- **Baixo**: Falha no restore por problemas de rede - Mitigação: Verificar conectividade e cache do NuGet
- **Médio**: TestContainers não funcionar sem Docker - Mitigação: Documentar requisito de Docker para testes

## Referências

- [ASP.NET Core Identity NuGet](https://www.nuget.org/packages/Microsoft.AspNetCore.Identity.EntityFrameworkCore)
- [Npgsql EF Core Provider](https://www.nuget.org/packages/Npgsql.EntityFrameworkCore.PostgreSQL)
- [TestContainers for .NET](https://dotnet.testcontainers.org/)
