---
status: pending
parallelizable: false
blocked_by: ["19.0"]
---

<task_context>
<domain>testing/integration</domain>
<type>testing</type>
<scope>quality_assurance</scope>
<complexity>high</complexity>
<dependencies>testcontainers,all_pages</dependencies>
<unblocks>21.0</unblocks>
</task_context>

# Tarefa 20.0: Testes de Integração - Fluxos Completos

## Visão Geral

Implementar testes de integração end-to-end para todos os fluxos críticos de autenticação: registro, login, 2FA, Google OAuth, e gerenciamento de conta.

## Requisitos

- [ ] Testes de fluxo de registro completo
- [ ] Testes de fluxo de login com 2FA
- [ ] Testes de Google OAuth (mock)
- [ ] Testes de troca de senha
- [ ] Testes de gerenciamento de roles
- [ ] Cobertura > 80% em fluxos críticos

## Testes a Implementar

### 20.1: RegistrationFlowTests

**Arquivo:** `tests/MathFlow.IntegrationTests/Identity/RegistrationFlowTests.cs`

```csharp
using FluentAssertions;
using Microsoft.AspNetCore.Identity;
using MathFlow.Infrastructure.IdentityServer.Models;

namespace MathFlow.IntegrationTests.Identity;

public class RegistrationFlowTests : IntegrationTestBase
{
    [Fact]
    public async Task Register_WithValidData_ShouldCreateUser()
    {
        // Arrange
        var userManager = await GetService<UserManager<ApplicationUser>>();

        // Act
        var response = await Client.GetAsync("/Account/Register");
        response.EnsureSuccessStatusCode();

        // Simular registro (via UserService diretamente para simplicidade)
        var user = new ApplicationUser
        {
            UserName = "testuser",
            Email = "test@example.com",
            TwoFactorEnabled = true
        };
        var result = await userManager.CreateAsync(user, "Test@1234");

        // Assert
        result.Succeeded.Should().BeTrue();
        var createdUser = await userManager.FindByEmailAsync("test@example.com");
        createdUser.Should().NotBeNull();
        createdUser!.TwoFactorEnabled.Should().BeTrue();
        (await userManager.IsInRoleAsync(createdUser, "normal")).Should().BeTrue();
    }

    [Fact]
    public async Task Register_WithWeakPassword_ShouldFail()
    {
        // Arrange
        var userManager = await GetService<UserManager<ApplicationUser>>();

        // Act
        var user = new ApplicationUser
        {
            UserName = "testuser2",
            Email = "test2@example.com"
        };
        var result = await userManager.CreateAsync(user, "weak");

        // Assert
        result.Succeeded.Should().BeFalse();
        result.Errors.Should().NotBeEmpty();
    }
}
```

### 20.2: LoginFlowTests

**Arquivo:** `tests/MathFlow.IntegrationTests/Identity/LoginFlowTests.cs`

```csharp
using FluentAssertions;
using Microsoft.AspNetCore.Identity;
using MathFlow.Application.Services.Identity;
using MathFlow.Infrastructure.IdentityServer.Models;

namespace MathFlow.IntegrationTests.Identity;

public class LoginFlowTests : IntegrationTestBase
{
    [Fact]
    public async Task Login_WithValidCredentials_ShouldRequireTwoFactor()
    {
        // Arrange
        var userManager = await GetService<UserManager<ApplicationUser>>();
        var userService = await GetService<UserService>();

        var user = new ApplicationUser
        {
            UserName = "logintest",
            Email = "logintest@example.com",
            TwoFactorEnabled = true
        };
        await userManager.CreateAsync(user, "Test@1234");

        // Act
        var result = await userService.LoginAsync("logintest@example.com", "Test@1234", false);

        // Assert
        result.RequiresTwoFactor.Should().BeTrue();
    }

    [Fact]
    public async Task Login_WithInvalidPassword_ShouldFail()
    {
        // Arrange
        var userManager = await GetService<UserManager<ApplicationUser>>();
        var userService = await GetService<UserService>();

        var user = new ApplicationUser
        {
            UserName = "logintest2",
            Email = "logintest2@example.com"
        };
        await userManager.CreateAsync(user, "Test@1234");

        // Act
        var result = await userService.LoginAsync("logintest2@example.com", "WrongPassword", false);

        // Assert
        result.Succeeded.Should().BeFalse();
    }

    [Fact]
    public async Task MasterAdmin_ShouldLoginWithout2FA()
    {
        // Arrange
        var userManager = await GetService<UserManager<ApplicationUser>>();
        var masterAdmin = await userManager.FindByEmailAsync("admin@mathflow.local");

        // Assert
        masterAdmin.Should().NotBeNull();
        masterAdmin!.TwoFactorEnabled.Should().BeFalse();
    }
}
```

### 20.3: TwoFactorFlowTests

**Arquivo:** `tests/MathFlow.IntegrationTests/Identity/TwoFactorFlowTests.cs`

```csharp
using FluentAssertions;
using Microsoft.AspNetCore.Identity;
using MathFlow.Application.Services.Identity;
using MathFlow.Infrastructure.IdentityServer.Models;

namespace MathFlow.IntegrationTests.Identity;

public class TwoFactorFlowTests : IntegrationTestBase
{
    [Fact]
    public async Task GetTwoFactorSetupKey_ShouldGenerateKey()
    {
        // Arrange
        var userManager = await GetService<UserManager<ApplicationUser>>();
        var userService = await GetService<UserService>();

        var user = new ApplicationUser
        {
            UserName = "2fatest",
            Email = "2fatest@example.com"
        };
        await userManager.CreateAsync(user, "Test@1234");

        // Act
        var key = await userService.GetTwoFactorSetupKeyAsync(user.Id);

        // Assert
        key.Should().NotBeNullOrEmpty();
    }
}
```

### 20.4: RoleManagementTests

**Arquivo:** `tests/MathFlow.IntegrationTests/Identity/RoleManagementTests.cs`

**Nota:** Usuários podem ter múltiplas roles simultaneamente. O RoleService fornece métodos para adicionar e remover roles individualmente.

```csharp
using FluentAssertions;
using Microsoft.AspNetCore.Identity;
using MathFlow.Application.Services.Identity;
using MathFlow.Infrastructure.IdentityServer.Models;

namespace MathFlow.IntegrationTests.Identity;

public class RoleManagementTests : IntegrationTestBase
{
    [Fact]
    public async Task AssignRole_ShouldAddRoleToUser()
    {
        // Arrange
        var userManager = await GetService<UserManager<ApplicationUser>>();
        var roleService = await GetService<RoleService>();

        var user = new ApplicationUser
        {
            UserName = "roletest",
            Email = "roletest@example.com"
        };
        await userManager.CreateAsync(user, "Test@1234");
        await userManager.AddToRoleAsync(user, "normal");

        // Act
        var result = await roleService.AssignRoleAsync(user.Id, "premium");

        // Assert
        result.Succeeded.Should().BeTrue();
        var roles = await userManager.GetRolesAsync(user);
        roles.Should().Contain("premium");
        roles.Should().Contain("normal"); // Roles stack
    }

    [Fact]
    public async Task RemoveRole_ShouldRemoveRoleFromUser()
    {
        // Arrange
        var userManager = await GetService<UserManager<ApplicationUser>>();
        var roleService = await GetService<RoleService>();

        var user = new ApplicationUser
        {
            UserName = "removerole",
            Email = "removerole@example.com"
        };
        await userManager.CreateAsync(user, "Test@1234");
        await userManager.AddToRoleAsync(user, "normal");
        await userManager.AddToRoleAsync(user, "premium");

        // Act
        var result = await roleService.RemoveRoleAsync(user.Id, "normal");

        // Assert
        result.Succeeded.Should().BeTrue();
        var roles = await userManager.GetRolesAsync(user);
        roles.Should().Contain("premium");
        roles.Should().NotContain("normal");
    }

    [Fact]
    public async Task RemoveRole_CannotRemoveMasterAdmin()
    {
        // Arrange
        var userManager = await GetService<UserManager<ApplicationUser>>();
        var roleService = await GetService<RoleService>();

        var user = new ApplicationUser
        {
            UserName = "mastertest",
            Email = "mastertest@example.com"
        };
        await userManager.CreateAsync(user, "Test@1234");
        await userManager.AddToRoleAsync(user, "masterAdmin");

        // Act
        var result = await roleService.RemoveRoleAsync(user.Id, "masterAdmin");

        // Assert
        result.Succeeded.Should().BeFalse(); // masterAdmin cannot be removed
    }
}
```

## Sequenciamento

- **Bloqueado por:** 19.0 (TestContainers)
- **Desbloqueia:** 21.0 (Testes de Segurança)
- **Paralelizável com:** Nenhum (testes sequenciais)

## Critérios de Aceitação

- [ ] 10+ testes de integração implementados
- [ ] Todos os fluxos críticos cobertos
- [ ] Todos os testes passando
- [ ] Cobertura > 80%

## Estimativa

**Tempo estimado:** 2 dias (16 horas)
