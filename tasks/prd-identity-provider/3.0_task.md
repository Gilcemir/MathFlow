---
status: completed
parallelizable: false
blocked_by: ["2.0"]
---

<task_context>
<domain>backend/data</domain>
<type>implementation</type>
<scope>core_feature</scope>
<complexity>medium</complexity>
<dependencies>identity_packages,ef_core</dependencies>
<unblocks>4.0</unblocks>
</task_context>

# Tarefa 3.0: Implementar ApplicationUser e ApplicationDbContext

## Visão Geral

Implementar os modelos de dados fundamentais para o Identity Provider: `ApplicationUser` (herda de `IdentityUser`) e `ApplicationDbContext` (contexto do Entity Framework Core). Estes componentes formam a base da persistência de dados de autenticação e autorização.

## Contexto da Tech Spec

**Referência:** Seções 3.1 e 3.2 da Tech Spec

- `ApplicationUser` herda de `IdentityUser` para aproveitar toda infraestrutura do ASP.NET Core Identity
- `ApplicationDbContext` herda de `IdentityDbContext<ApplicationUser>` para gerenciar tabelas de Identity
- Customização de nomes de tabelas para seguir convenções do projeto
- Preparação para futuras extensões (propriedades adicionais em ApplicationUser)

## Requisitos

- [ ] Criar classe `ApplicationUser` herdando de `IdentityUser`
- [ ] Criar classe `ApplicationDbContext` herdando de `IdentityDbContext<ApplicationUser>`
- [ ] Customizar nomes de tabelas (Users, Roles, UserRoles, etc.)
- [ ] Configurar namespace correto
- [ ] Preparar estrutura para extensões futuras
- [ ] Validar compilação

## Subtarefas

### 3.1: Criar ApplicationUser

**Ação:** Criar modelo de usuário estendendo IdentityUser

**Arquivo:** `src/MathFlow/Infrastructure/IdentityServer/Models/ApplicationUser.cs`

**Código:**
```csharp
using Microsoft.AspNetCore.Identity;

namespace MathFlow.Infrastructure.IdentityServer.Models;

/// <summary>
/// Represents an application user with authentication and authorization capabilities.
/// Extends IdentityUser to leverage ASP.NET Core Identity infrastructure.
/// </summary>
public class ApplicationUser : IdentityUser
{
    // Propriedades adicionais podem ser adicionadas aqui no futuro
    // Exemplos:
    // public DateTime CreatedAt { get; set; }
    // public DateTime? LastLoginAt { get; set; }
    // public string? ProfilePictureUrl { get; set; }
}
```

**Validação:**
- [ ] Arquivo criado em `Infrastructure/IdentityServer/Models/`
- [ ] Namespace correto: `MathFlow.Infrastructure.IdentityServer.Models`
- [ ] Herda de `IdentityUser`
- [ ] Documentação XML presente
- [ ] Comentários indicando extensibilidade futura

### 3.2: Criar ApplicationDbContext

**Ação:** Criar contexto do Entity Framework Core para Identity

**Arquivo:** `src/MathFlow/Infrastructure/IdentityServer/Data/ApplicationDbContext.cs`

**Código:**
```csharp
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;
using MathFlow.Infrastructure.IdentityServer.Models;

namespace MathFlow.Infrastructure.IdentityServer.Data;

/// <summary>
/// Database context for ASP.NET Core Identity.
/// Manages user authentication, authorization, roles, and related entities.
/// </summary>
public class ApplicationDbContext : IdentityDbContext<ApplicationUser>
{
    public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
        : base(options)
    {
    }

    protected override void OnModelCreating(ModelBuilder builder)
    {
        base.OnModelCreating(builder);

        // Customizar nomes de tabelas para seguir convenções do projeto
        builder.Entity<ApplicationUser>(entity =>
        {
            entity.ToTable("Users");
        });

        builder.Entity<IdentityRole>(entity =>
        {
            entity.ToTable("Roles");
        });

        builder.Entity<IdentityUserRole<string>>(entity =>
        {
            entity.ToTable("UserRoles");
        });

        builder.Entity<IdentityUserClaim<string>>(entity =>
        {
            entity.ToTable("UserClaims");
        });

        builder.Entity<IdentityUserLogin<string>>(entity =>
        {
            entity.ToTable("UserLogins");
        });

        builder.Entity<IdentityRoleClaim<string>>(entity =>
        {
            entity.ToTable("RoleClaims");
        });

        builder.Entity<IdentityUserToken<string>>(entity =>
        {
            entity.ToTable("UserTokens");
        });

        // Configurações adicionais podem ser adicionadas aqui
        // Exemplo: índices customizados, constraints, etc.
    }
}
```

**Validação:**
- [ ] Arquivo criado em `Infrastructure/IdentityServer/Data/`
- [ ] Namespace correto: `MathFlow.Infrastructure.IdentityServer.Data`
- [ ] Herda de `IdentityDbContext<ApplicationUser>`
- [ ] Construtor recebe `DbContextOptions<ApplicationDbContext>`
- [ ] Método `OnModelCreating` sobrescrito
- [ ] Todas as 7 tabelas Identity customizadas
- [ ] Documentação XML presente

### 3.3: Validar Nomes de Tabelas

**Ação:** Verificar que os nomes de tabelas seguem convenção PascalCase sem prefixo "AspNet"

**Tabelas configuradas:**
- `Users` (ao invés de `AspNetUsers`)
- `Roles` (ao invés de `AspNetRoles`)
- `UserRoles` (ao invés de `AspNetUserRoles`)
- `UserClaims` (ao invés de `AspNetUserClaims`)
- `UserLogins` (ao invés de `AspNetUserLogins`)
- `RoleClaims` (ao invés de `AspNetRoleClaims`)
- `UserTokens` (ao invés de `AspNetUserTokens`)

**Validação:**
- [ ] Todos os nomes sem prefixo "AspNet"
- [ ] Nomes em PascalCase
- [ ] Consistência com convenções do projeto

### 3.4: Adicionar Using Statements

**Ação:** Garantir que todos os using statements necessários estão presentes

**ApplicationUser.cs:**
```csharp
using Microsoft.AspNetCore.Identity;
```

**ApplicationDbContext.cs:**
```csharp
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;
using MathFlow.Infrastructure.IdentityServer.Models;
```

**Validação:**
- [ ] Nenhum using desnecessário
- [ ] Todos os tipos resolvidos corretamente
- [ ] Sem ambiguidades de namespace

### 3.5: Compilar e Validar

**Ação:** Compilar projeto e validar que não há erros

**Comandos:**
```bash
cd src/MathFlow

# Compilar
dotnet build

# Verificar warnings
dotnet build 2>&1 | grep -i warning

# Verificar erros
dotnet build 2>&1 | grep -i error
```

**Validação:**
- [ ] Compilação bem-sucedida
- [ ] Zero erros
- [ ] Zero warnings relacionados a Identity
- [ ] Tipos `ApplicationUser` e `ApplicationDbContext` resolvidos

### 3.6: Preparar para Extensões Futuras

**Ação:** Documentar pontos de extensão para futuras funcionalidades

**Adicionar comentários em ApplicationUser.cs:**
```csharp
// FUTURE EXTENSIONS:
// - CreatedAt: timestamp de criação do usuário
// - LastLoginAt: timestamp do último login
// - ProfilePictureUrl: URL da foto de perfil
// - Relacionamento com Wallet (quando implementado)
// - Relacionamento com UsageLogs (quando implementado)
```

**Adicionar comentários em ApplicationDbContext.cs:**
```csharp
// FUTURE EXTENSIONS:
// - DbSet<Wallet> Wallets (quando domínio for implementado)
// - DbSet<UsageLog> UsageLogs (quando domínio for implementado)
// - Configurações de relacionamentos entre User e entidades de domínio
// - Índices customizados para performance
```

**Validação:**
- [ ] Comentários de extensão futura adicionados
- [ ] Documentação clara sobre próximos passos

## Sequenciamento

- **Bloqueado por:** 2.0 (Configuração de Pacotes NuGet)
- **Desbloqueia:** 4.0 (Criar e Aplicar Migration Inicial)
- **Paralelizável com:** Nenhum (dependência sequencial)

## Critérios de Aceitação

- [ ] `ApplicationUser` criado e compilando
- [ ] `ApplicationDbContext` criado e compilando
- [ ] Todas as 7 tabelas Identity customizadas
- [ ] Nomes de tabelas sem prefixo "AspNet"
- [ ] Documentação XML em classes públicas
- [ ] Comentários indicando extensibilidade futura
- [ ] Zero erros de compilação
- [ ] Zero warnings relacionados a Identity

## Comandos de Validação

```bash
# Verificar arquivos criados
ls -la src/MathFlow/Infrastructure/IdentityServer/Models/ApplicationUser.cs
ls -la src/MathFlow/Infrastructure/IdentityServer/Data/ApplicationDbContext.cs

# Compilar
cd src/MathFlow
dotnet build --no-restore

# Verificar que tipos estão disponíveis (via reflection)
dotnet build -v:q 2>&1 | grep -i "ApplicationUser\|ApplicationDbContext"

# Contar warnings
dotnet build 2>&1 | grep -c warning
```

## Notas de Implementação

- **Atenção**: `IdentityDbContext<ApplicationUser>` já cria DbSets para todas as entidades Identity, não é necessário declará-los explicitamente
- **Dica**: Chamar `base.OnModelCreating(builder)` ANTES de customizações é crucial para não perder configurações padrão do Identity
- **Importante**: Usar `string` como tipo de chave (padrão do Identity) simplifica integração, mas pode ser mudado para `Guid` se necessário
- **Próximo passo**: Após conclusão, criar migration inicial (4.0) para gerar schema no banco de dados

## Estimativa

**Tempo estimado:** 1 dia (8 horas)

## Riscos

- **Baixo**: Esquecer de chamar `base.OnModelCreating()` - Mitigação: Validar com migration que todas as tabelas são criadas
- **Baixo**: Conflito de namespaces com `IdentityRole` - Mitigação: Usar `using Microsoft.AspNetCore.Identity;` explicitamente
- **Baixo**: Customizações de tabela não aplicadas - Mitigação: Verificar migration gerada na tarefa 4.0

## Referências

- [IdentityUser Class](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.identity.identityuser)
- [IdentityDbContext Class](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.identity.entityframeworkcore.identitydbcontext-1)
- [Customize Identity Model](https://learn.microsoft.com/en-us/aspnet/core/security/authentication/customize-identity-model)
