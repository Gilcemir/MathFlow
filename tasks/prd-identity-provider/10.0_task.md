---
status: pending
parallelizable: true
blocked_by: ["8.0"]
---

<task_context>
<domain>backend/service</domain>
<type>implementation</type>
<scope>core_feature</scope>
<complexity>medium</complexity>
<dependencies>identity_config,user_manager</dependencies>
<unblocks>11.0,17.0</unblocks>
</task_context>

# Tarefa 10.0: Implementar RoleService

## Visão Geral

Implementar o serviço de aplicação `RoleService` responsável por gerenciar atribuição de roles a usuários. Este serviço será usado pelas páginas administrativas para promover usuários entre roles (normal → premium, normal → admin, etc.).

## Contexto da Tech Spec

**Referência:** Seção 3.6 da Tech Spec - RoleService

Responsabilidades:
- Atribuir role a um usuário (substituindo role anterior)
- Obter roles de um usuário
- Validar que usuário existe
- Proteger role `masterAdmin` (não pode ser removida)
- Logging de mudanças de role

## Requisitos

- [ ] Criar classe `RoleService`
- [ ] Implementar método `AssignRoleAsync`
- [ ] Implementar método `GetUserRolesAsync`
- [ ] Proteger role `masterAdmin` de remoção
- [ ] Adicionar logging estruturado
- [ ] Implementar tratamento de erros
- [ ] Validar que usuário existe

## Subtarefas

### 10.1: Criar Classe RoleService

**Ação:** Criar estrutura base do serviço com dependências

**Arquivo:** `src/MathFlow/Application/Services/Identity/RoleService.cs`

**Código:**
```csharp
using Microsoft.AspNetCore.Identity;
using MathFlow.Infrastructure.IdentityServer.Models;

namespace MathFlow.Application.Services.Identity;

/// <summary>
/// Provides services for managing user roles.
/// </summary>
public class RoleService
{
    private readonly UserManager<ApplicationUser> _userManager;
    private readonly ILogger<RoleService> _logger;

    public RoleService(
        UserManager<ApplicationUser> userManager,
        ILogger<RoleService> logger)
    {
        _userManager = userManager;
        _logger = logger;
    }
}
```

**Validação:**
- [ ] Classe criada no namespace correto
- [ ] Dependências injetadas via construtor
- [ ] Logger configurado
- [ ] Documentação XML presente

### 10.2: Implementar AssignRoleAsync

**Ação:** Implementar atribuição de role com proteção de masterAdmin

**Código:**
```csharp
/// <summary>
/// Assigns a role to a user, removing previous roles except masterAdmin.
/// </summary>
/// <param name="userId">The user ID.</param>
/// <param name="roleName">The role name to assign.</param>
/// <returns>The result of the operation.</returns>
public async Task<IdentityResult> AssignRoleAsync(string userId, string roleName)
{
    var user = await _userManager.FindByIdAsync(userId);
    if (user == null)
    {
        _logger.LogWarning("Attempted to assign role to non-existent user {UserId}", userId);
        return IdentityResult.Failed(
            new IdentityError { Description = "User not found" });
    }

    // Obter roles atuais
    var currentRoles = await _userManager.GetRolesAsync(user);
    
    // Remover roles anteriores (exceto masterAdmin)
    var rolesToRemove = currentRoles.Where(r => r != "masterAdmin").ToList();

    if (rolesToRemove.Any())
    {
        var removeResult = await _userManager.RemoveFromRolesAsync(user, rolesToRemove);
        if (!removeResult.Succeeded)
        {
            _logger.LogError(
                "Failed to remove roles from user {UserId}: {Errors}",
                userId,
                string.Join(", ", removeResult.Errors.Select(e => e.Description)));
            return removeResult;
        }
    }

    // Adicionar nova role
    var result = await _userManager.AddToRoleAsync(user, roleName);

    if (result.Succeeded)
    {
        _logger.LogInformation(
            "User {UserId} ({Email}) assigned to role {RoleName}",
            userId,
            user.Email,
            roleName);
    }
    else
    {
        _logger.LogError(
            "Failed to assign role {RoleName} to user {UserId}: {Errors}",
            roleName,
            userId,
            string.Join(", ", result.Errors.Select(e => e.Description)));
    }

    return result;
}
```

**Validação:**
- [ ] Verifica existência do usuário
- [ ] Remove roles anteriores (exceto masterAdmin)
- [ ] Adiciona nova role
- [ ] Logging de sucesso e falha
- [ ] Retorna `IdentityResult` com erros se aplicável
- [ ] Documentação XML presente

### 10.3: Implementar GetUserRolesAsync

**Ação:** Implementar obtenção de roles de um usuário

**Código:**
```csharp
/// <summary>
/// Gets all roles assigned to a user.
/// </summary>
/// <param name="userId">The user ID.</param>
/// <returns>A list of role names.</returns>
public async Task<IList<string>> GetUserRolesAsync(string userId)
{
    var user = await _userManager.FindByIdAsync(userId);
    if (user == null)
    {
        _logger.LogWarning("Attempted to get roles for non-existent user {UserId}", userId);
        return new List<string>();
    }

    var roles = await _userManager.GetRolesAsync(user);
    
    _logger.LogDebug("User {UserId} has roles: {Roles}", userId, string.Join(", ", roles));
    
    return roles;
}
```

**Validação:**
- [ ] Verifica existência do usuário
- [ ] Retorna lista vazia se usuário não encontrado
- [ ] Logging de debug com roles
- [ ] Documentação XML presente

### 10.4: Adicionar Método de Validação

**Ação:** Adicionar método helper para validar role name

**Código:**
```csharp
/// <summary>
/// Validates that a role name is one of the allowed roles.
/// </summary>
/// <param name="roleName">The role name to validate.</param>
/// <returns>True if valid, false otherwise.</returns>
private bool IsValidRole(string roleName)
{
    var validRoles = new[] { "masterAdmin", "admin", "premium", "normal" };
    return validRoles.Contains(roleName);
}
```

**Atualizar AssignRoleAsync para usar validação:**
```csharp
public async Task<IdentityResult> AssignRoleAsync(string userId, string roleName)
{
    // Validar role name
    if (!IsValidRole(roleName))
    {
        _logger.LogWarning("Attempted to assign invalid role {RoleName} to user {UserId}", roleName, userId);
        return IdentityResult.Failed(
            new IdentityError { Description = $"Invalid role: {roleName}" });
    }

    // ... resto do código
}
```

**Validação:**
- [ ] Método de validação implementado
- [ ] Validação chamada em `AssignRoleAsync`
- [ ] Logging de tentativa de role inválida

### 10.5: Adicionar Tratamento de Erros

**Ação:** Adicionar validações e tratamento robusto de erros

**Validações a adicionar:**
```csharp
private void ValidateUserId(string userId)
{
    if (string.IsNullOrWhiteSpace(userId))
    {
        throw new ArgumentException("User ID cannot be empty", nameof(userId));
    }
}

private void ValidateRoleName(string roleName)
{
    if (string.IsNullOrWhiteSpace(roleName))
    {
        throw new ArgumentException("Role name cannot be empty", nameof(roleName));
    }
}
```

**Atualizar métodos para usar validações:**
```csharp
public async Task<IdentityResult> AssignRoleAsync(string userId, string roleName)
{
    ValidateUserId(userId);
    ValidateRoleName(roleName);
    
    // ... resto do código
}

public async Task<IList<string>> GetUserRolesAsync(string userId)
{
    ValidateUserId(userId);
    
    // ... resto do código
}
```

**Validação:**
- [ ] Validações de entrada implementadas
- [ ] Exceções apropriadas lançadas
- [ ] Mensagens de erro descritivas

### 10.6: Compilar e Validar

**Ação:** Compilar projeto e validar implementação

**Comandos:**
```bash
cd src/MathFlow

# Compilar
dotnet build

# Verificar warnings
dotnet build 2>&1 | grep -i warning | grep -i roleservice
```

**Validação:**
- [ ] Compilação bem-sucedida
- [ ] Zero warnings relacionados a RoleService

## Código Completo

**Arquivo final:** `src/MathFlow/Application/Services/Identity/RoleService.cs`

```csharp
using Microsoft.AspNetCore.Identity;
using MathFlow.Infrastructure.IdentityServer.Models;

namespace MathFlow.Application.Services.Identity;

/// <summary>
/// Provides services for managing user roles.
/// </summary>
public class RoleService
{
    private readonly UserManager<ApplicationUser> _userManager;
    private readonly ILogger<RoleService> _logger;

    public RoleService(
        UserManager<ApplicationUser> userManager,
        ILogger<RoleService> logger)
    {
        _userManager = userManager;
        _logger = logger;
    }

    /// <summary>
    /// Assigns a role to a user, removing previous roles except masterAdmin.
    /// </summary>
    /// <param name="userId">The user ID.</param>
    /// <param name="roleName">The role name to assign.</param>
    /// <returns>The result of the operation.</returns>
    public async Task<IdentityResult> AssignRoleAsync(string userId, string roleName)
    {
        ValidateUserId(userId);
        ValidateRoleName(roleName);

        if (!IsValidRole(roleName))
        {
            _logger.LogWarning("Attempted to assign invalid role {RoleName} to user {UserId}", roleName, userId);
            return IdentityResult.Failed(
                new IdentityError { Description = $"Invalid role: {roleName}" });
        }

        var user = await _userManager.FindByIdAsync(userId);
        if (user == null)
        {
            _logger.LogWarning("Attempted to assign role to non-existent user {UserId}", userId);
            return IdentityResult.Failed(
                new IdentityError { Description = "User not found" });
        }

        var currentRoles = await _userManager.GetRolesAsync(user);
        var rolesToRemove = currentRoles.Where(r => r != "masterAdmin").ToList();

        if (rolesToRemove.Any())
        {
            var removeResult = await _userManager.RemoveFromRolesAsync(user, rolesToRemove);
            if (!removeResult.Succeeded)
            {
                _logger.LogError(
                    "Failed to remove roles from user {UserId}: {Errors}",
                    userId,
                    string.Join(", ", removeResult.Errors.Select(e => e.Description)));
                return removeResult;
            }
        }

        var result = await _userManager.AddToRoleAsync(user, roleName);

        if (result.Succeeded)
        {
            _logger.LogInformation(
                "User {UserId} ({Email}) assigned to role {RoleName}",
                userId,
                user.Email,
                roleName);
        }
        else
        {
            _logger.LogError(
                "Failed to assign role {RoleName} to user {UserId}: {Errors}",
                roleName,
                userId,
                string.Join(", ", result.Errors.Select(e => e.Description)));
        }

        return result;
    }

    /// <summary>
    /// Gets all roles assigned to a user.
    /// </summary>
    /// <param name="userId">The user ID.</param>
    /// <returns>A list of role names.</returns>
    public async Task<IList<string>> GetUserRolesAsync(string userId)
    {
        ValidateUserId(userId);

        var user = await _userManager.FindByIdAsync(userId);
        if (user == null)
        {
            _logger.LogWarning("Attempted to get roles for non-existent user {UserId}", userId);
            return new List<string>();
        }

        var roles = await _userManager.GetRolesAsync(user);
        
        _logger.LogDebug("User {UserId} has roles: {Roles}", userId, string.Join(", ", roles));
        
        return roles;
    }

    private bool IsValidRole(string roleName)
    {
        var validRoles = new[] { "masterAdmin", "admin", "premium", "normal" };
        return validRoles.Contains(roleName);
    }

    private void ValidateUserId(string userId)
    {
        if (string.IsNullOrWhiteSpace(userId))
        {
            throw new ArgumentException("User ID cannot be empty", nameof(userId));
        }
    }

    private void ValidateRoleName(string roleName)
    {
        if (string.IsNullOrWhiteSpace(roleName))
        {
            throw new ArgumentException("Role name cannot be empty", nameof(roleName));
        }
    }
}
```

## Sequenciamento

- **Bloqueado por:** 8.0 (Integrar Identity no Program.cs)
- **Desbloqueia:** 11.0 (Testes Unitários), 17.0 (Páginas Admin)
- **Paralelizável com:** 9.0 (UserService)

## Critérios de Aceitação

- [ ] Todos os métodos públicos implementados
- [ ] Role `masterAdmin` protegida de remoção
- [ ] Validação de role names
- [ ] Logging estruturado em todos os métodos
- [ ] Tratamento de erros robusto
- [ ] Código compila sem warnings
- [ ] Documentação XML em métodos públicos

## Comandos de Validação

```bash
# Compilar
cd src/MathFlow
dotnet build --no-restore

# Verificar arquivo criado
ls -la Application/Services/Identity/RoleService.cs

# Contar métodos públicos (deve ser 2)
grep -c "public async Task" Application/Services/Identity/RoleService.cs
```

## Notas de Implementação

- **Atenção**: Proteger `masterAdmin` é crítico para não perder acesso administrativo
- **Dica**: Remover roles anteriores garante que usuário tenha apenas uma role por vez (exceto masterAdmin)
- **Importante**: Logging deve incluir email do usuário para auditoria
- **Próximo passo**: Após conclusão, implementar testes unitários (11.0) e páginas admin (17.0)

## Estimativa

**Tempo estimado:** 1 dia (8 horas)

## Riscos

- **Baixo**: Remover acidentalmente masterAdmin - Mitigação: Proteção explícita no código
- **Baixo**: Validações inconsistentes - Mitigação: Centralizar validações em métodos privados
- **Baixo**: Logging excessivo - Mitigação: Usar níveis apropriados (Information, Warning, Debug)

## Referências

- [UserManager<TUser> Documentation](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.identity.usermanager-1)
- [Role Management in ASP.NET Core Identity](https://learn.microsoft.com/en-us/aspnet/core/security/authorization/roles)
