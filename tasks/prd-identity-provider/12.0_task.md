---
status: pending
parallelizable: true
blocked_by: ["9.0"]
---

<task_context>
<domain>frontend/pages</domain>
<type>implementation</type>
<scope>core_feature</scope>
<complexity>high</complexity>
<dependencies>user_service,identity_config</dependencies>
<unblocks>13.0,14.0,15.0</unblocks>
</task_context>

# Tarefa 12.0: Criar Login e Register Pages

## Visão Geral

Implementar as páginas Razor de Login e Register, permitindo que usuários se autentiquem com email/password ou Google OAuth, e se registrem com validação de senha e atribuição automática de role `normal`. Estas são as páginas mais críticas do fluxo de autenticação.

## Contexto da Tech Spec

**Referência:** Seção 8.1 da Tech Spec - Pages/Account/

Páginas a implementar:
- **Login.cshtml**: Login com email/password ou Google
- **Register.cshtml**: Registro com validação de senha
- Integração com `UserService`
- Redirecionamento para 2FA se necessário
- Mensagens de erro claras

## Requisitos

- [ ] Criar página Login.cshtml e Login.cshtml.cs
- [ ] Criar página Register.cshtml e Register.cshtml.cs
- [ ] Implementar formulário de login
- [ ] Implementar formulário de registro
- [ ] Integrar com UserService
- [ ] Adicionar botão de Google OAuth
- [ ] Validação client-side e server-side
- [ ] Mensagens de erro user-friendly
- [ ] Redirecionamento correto após sucesso

## Subtarefas

### 12.1: Criar Login Page Model

**Ação:** Criar PageModel para Login

**Arquivo:** `src/MathFlow/Pages/Account/Login.cshtml.cs`

**Código:**
```csharp
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using MathFlow.Application.Services.Identity;
using System.ComponentModel.DataAnnotations;

namespace MathFlow.Pages.Account;

public class LoginModel : PageModel
{
    private readonly UserService _userService;
    private readonly ILogger<LoginModel> _logger;

    public LoginModel(UserService userService, ILogger<LoginModel> logger)
    {
        _userService = userService;
        _logger = logger;
    }

    [BindProperty]
    public InputModel Input { get; set; } = new();

    public string? ReturnUrl { get; set; }

    public string? ErrorMessage { get; set; }

    public class InputModel
    {
        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email format")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "Password is required")]
        [DataType(DataType.Password)]
        public string Password { get; set; } = string.Empty;

        [Display(Name = "Remember me")]
        public bool RememberMe { get; set; }
    }

    public async Task OnGetAsync(string? returnUrl = null)
    {
        if (!string.IsNullOrEmpty(ErrorMessage))
        {
            ModelState.AddModelError(string.Empty, ErrorMessage);
        }

        returnUrl ??= Url.Content("~/");

        // Limpar cookies de autenticação externa
        await HttpContext.SignOutAsync();

        ReturnUrl = returnUrl;
    }

    public async Task<IActionResult> OnPostAsync(string? returnUrl = null)
    {
        returnUrl ??= Url.Content("~/");

        if (ModelState.IsValid)
        {
            var result = await _userService.LoginAsync(Input.Email, Input.Password, Input.RememberMe);

            if (result.Succeeded)
            {
                _logger.LogInformation("User {Email} logged in", Input.Email);
                return LocalRedirect(returnUrl);
            }

            if (result.RequiresTwoFactor)
            {
                return RedirectToPage("./TwoFactor", new { ReturnUrl = returnUrl, RememberMe = Input.RememberMe });
            }

            if (result.IsLockedOut)
            {
                _logger.LogWarning("User {Email} account locked out", Input.Email);
                ModelState.AddModelError(string.Empty, "Account locked out. Please try again later.");
                return Page();
            }

            ModelState.AddModelError(string.Empty, "Invalid login attempt.");
        }

        return Page();
    }
}
```

**Validação:**
- [ ] PageModel criado com InputModel
- [ ] Validação de email e senha
- [ ] Integração com UserService
- [ ] Redirecionamento para 2FA se necessário
- [ ] Tratamento de lockout

### 12.2: Criar Login View

**Ação:** Criar view Razor para Login

**Arquivo:** `src/MathFlow/Pages/Account/Login.cshtml`

**Código:**
```html
@page
@model LoginModel
@{
    ViewData["Title"] = "Log in";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h2>@ViewData["Title"]</h2>
                </div>
                <div class="card-body">
                    <form method="post">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                        
                        <div class="mb-3">
                            <label asp-for="Input.Email" class="form-label"></label>
                            <input asp-for="Input.Email" class="form-control" autocomplete="username" aria-required="true" placeholder="name@example.com" />
                            <span asp-validation-for="Input.Email" class="text-danger"></span>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="Input.Password" class="form-label"></label>
                            <input asp-for="Input.Password" class="form-control" autocomplete="current-password" aria-required="true" placeholder="Password" />
                            <span asp-validation-for="Input.Password" class="text-danger"></span>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input asp-for="Input.RememberMe" class="form-check-input" />
                            <label asp-for="Input.RememberMe" class="form-check-label">
                                Remember me
                            </label>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">Log in</button>
                        </div>
                        
                        <div class="mt-3 text-center">
                            <p>
                                <a asp-page="./Register" asp-route-returnUrl="@Model.ReturnUrl">Register as a new user</a>
                            </p>
                        </div>
                    </form>
                    
                    <hr />
                    
                    <div class="mt-3">
                        <h4>Or use external login</h4>
                        <form method="post" asp-page-handler="ExternalLogin" asp-route-returnUrl="@Model.ReturnUrl">
                            <div class="d-grid">
                                <button type="submit" class="btn btn-outline-secondary" name="provider" value="Google">
                                    <i class="bi bi-google"></i> Sign in with Google
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
```

**Validação:**
- [ ] Formulário com campos email, password, remember me
- [ ] Validação client-side habilitada
- [ ] Botão de Google OAuth
- [ ] Link para registro
- [ ] Bootstrap styling aplicado

### 12.3: Criar Register Page Model

**Ação:** Criar PageModel para Register

**Arquivo:** `src/MathFlow/Pages/Account/Register.cshtml.cs`

**Código:**
```csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using MathFlow.Application.Services.Identity;
using System.ComponentModel.DataAnnotations;

namespace MathFlow.Pages.Account;

public class RegisterModel : PageModel
{
    private readonly UserService _userService;
    private readonly ILogger<RegisterModel> _logger;

    public RegisterModel(UserService userService, ILogger<RegisterModel> logger)
    {
        _userService = userService;
        _logger = logger;
    }

    [BindProperty]
    public InputModel Input { get; set; } = new();

    public string? ReturnUrl { get; set; }

    public class InputModel
    {
        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email format")]
        [Display(Name = "Email")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "Username is required")]
        [StringLength(50, ErrorMessage = "Username must be between {2} and {1} characters", MinimumLength = 3)]
        [Display(Name = "Username")]
        public string UserName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Password is required")]
        [StringLength(100, ErrorMessage = "Password must be at least {2} characters long", MinimumLength = 8)]
        [DataType(DataType.Password)]
        [Display(Name = "Password")]
        [RegularExpression(@"^(?=.*[A-Z])(?=.*[^a-zA-Z0-9]).*$", 
            ErrorMessage = "Password must contain at least one uppercase letter and one special character")]
        public string Password { get; set; } = string.Empty;

        [DataType(DataType.Password)]
        [Display(Name = "Confirm password")]
        [Compare("Password", ErrorMessage = "Password and confirmation do not match")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    public void OnGet(string? returnUrl = null)
    {
        ReturnUrl = returnUrl;
    }

    public async Task<IActionResult> OnPostAsync(string? returnUrl = null)
    {
        returnUrl ??= Url.Content("~/");

        if (ModelState.IsValid)
        {
            var result = await _userService.RegisterUserAsync(Input.Email, Input.Password, Input.UserName);

            if (result.Succeeded)
            {
                _logger.LogInformation("User {Email} registered successfully", Input.Email);
                
                // Redirecionar para setup de 2FA
                return RedirectToPage("./TwoFactorSetup", new { email = Input.Email, returnUrl });
            }

            foreach (var error in result.Errors)
            {
                ModelState.AddModelError(string.Empty, error.Description);
            }
        }

        return Page();
    }
}
```

**Validação:**
- [ ] PageModel criado com InputModel
- [ ] Validação de email, username, password
- [ ] Regex para password policy (8+ chars, 1 uppercase, 1 special)
- [ ] Confirmação de senha
- [ ] Integração com UserService
- [ ] Redirecionamento para 2FA setup

### 12.4: Criar Register View

**Ação:** Criar view Razor para Register

**Arquivo:** `src/MathFlow/Pages/Account/Register.cshtml`

**Código:**
```html
@page
@model RegisterModel
@{
    ViewData["Title"] = "Register";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h2>@ViewData["Title"]</h2>
                    <p class="text-muted">Create a new account</p>
                </div>
                <div class="card-body">
                    <form method="post">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                        
                        <div class="mb-3">
                            <label asp-for="Input.Email" class="form-label"></label>
                            <input asp-for="Input.Email" class="form-control" autocomplete="username" aria-required="true" placeholder="name@example.com" />
                            <span asp-validation-for="Input.Email" class="text-danger"></span>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="Input.UserName" class="form-label"></label>
                            <input asp-for="Input.UserName" class="form-control" aria-required="true" placeholder="Choose a username" />
                            <span asp-validation-for="Input.UserName" class="text-danger"></span>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="Input.Password" class="form-label"></label>
                            <input asp-for="Input.Password" class="form-control" autocomplete="new-password" aria-required="true" placeholder="Password" />
                            <span asp-validation-for="Input.Password" class="text-danger"></span>
                            <small class="form-text text-muted">
                                Password must be at least 8 characters, contain one uppercase letter and one special character.
                            </small>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="Input.ConfirmPassword" class="form-label"></label>
                            <input asp-for="Input.ConfirmPassword" class="form-control" autocomplete="new-password" aria-required="true" placeholder="Confirm password" />
                            <span asp-validation-for="Input.ConfirmPassword" class="text-danger"></span>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">Register</button>
                        </div>
                        
                        <div class="mt-3 text-center">
                            <p>
                                Already have an account? <a asp-page="./Login" asp-route-returnUrl="@Model.ReturnUrl">Log in</a>
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
```

**Validação:**
- [ ] Formulário com campos email, username, password, confirm password
- [ ] Validação client-side habilitada
- [ ] Hint de requisitos de senha
- [ ] Link para login
- [ ] Bootstrap styling aplicado

### 12.5: Adicionar Handler de Google OAuth no Login

**Ação:** Adicionar método para iniciar Google OAuth

**Código a adicionar em Login.cshtml.cs:**
```csharp
public IActionResult OnPostExternalLogin(string provider, string? returnUrl = null)
{
    returnUrl ??= Url.Content("~/");
    
    var redirectUrl = Url.Page("./ExternalLogin", pageHandler: "Callback", values: new { returnUrl });
    var properties = _signInManager.ConfigureExternalAuthenticationProperties(provider, redirectUrl);
    
    return new ChallengeResult(provider, properties);
}
```

**Nota:** Requer injeção de `SignInManager` no construtor:
```csharp
private readonly SignInManager<ApplicationUser> _signInManager;

public LoginModel(
    UserService userService, 
    SignInManager<ApplicationUser> signInManager,
    ILogger<LoginModel> logger)
{
    _userService = userService;
    _signInManager = signInManager;
    _logger = logger;
}
```

**Validação:**
- [ ] Handler `OnPostExternalLogin` implementado
- [ ] SignInManager injetado
- [ ] Redirect URL configurado

### 12.6: Compilar e Testar

**Ação:** Compilar e testar páginas

**Comandos:**
```bash
cd src/MathFlow

# Compilar
dotnet build

# Executar aplicação
dotnet run

# Testar navegação
# http://localhost:5124/Account/Login
# http://localhost:5124/Account/Register
```

**Validação:**
- [ ] Compilação bem-sucedida
- [ ] Páginas acessíveis
- [ ] Formulários renderizando corretamente
- [ ] Validação client-side funcionando

## Sequenciamento

- **Bloqueado por:** 9.0 (Implementar UserService)
- **Desbloqueia:** 13.0 (TwoFactor Page), 14.0 (Google OAuth), 15.0 (Logout)
- **Paralelizável com:** 16.0 (Manage Pages) - pode iniciar em paralelo

## Critérios de Aceitação

- [ ] Login.cshtml e Login.cshtml.cs implementados
- [ ] Register.cshtml e Register.cshtml.cs implementados
- [ ] Validação server-side e client-side funcionando
- [ ] Password policy validada (8+ chars, 1 uppercase, 1 special)
- [ ] Integração com UserService
- [ ] Redirecionamento para 2FA após registro
- [ ] Botão de Google OAuth presente
- [ ] Mensagens de erro claras
- [ ] UI responsiva com Bootstrap

## Comandos de Validação

```bash
# Compilar
cd src/MathFlow
dotnet build --no-restore

# Verificar arquivos criados
ls -la Pages/Account/Login.cshtml*
ls -la Pages/Account/Register.cshtml*

# Executar e testar
dotnet run
```

## Notas de Implementação

- **Atenção**: Password regex deve corresponder exatamente à policy configurada no Identity
- **Dica**: Usar `LocalRedirect` ao invés de `Redirect` previne open redirect vulnerabilities
- **Importante**: Limpar cookies de autenticação externa no OnGet do Login
- **UX**: Mostrar requisitos de senha ajuda usuário a criar senha válida
- **Próximo passo**: Após conclusão, implementar TwoFactor page (13.0)

## Estimativa

**Tempo estimado:** 2 dias (16 horas)

## Riscos

- **Médio**: Validação de senha inconsistente - Mitigação: Testar com múltiplas senhas
- **Baixo**: Google OAuth não configurado - Mitigação: Botão condicional se credenciais ausentes
- **Baixo**: Redirect loops - Mitigação: Usar `LocalRedirect` e validar returnUrl

## Referências

- [Razor Pages in ASP.NET Core](https://learn.microsoft.com/en-us/aspnet/core/razor-pages/)
- [Model Validation](https://learn.microsoft.com/en-us/aspnet/core/mvc/models/validation)
- [External Authentication](https://learn.microsoft.com/en-us/aspnet/core/security/authentication/social/)
