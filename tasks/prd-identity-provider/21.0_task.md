---
status: pending
parallelizable: false
blocked_by: ["20.0"]
---

<task_context>
<domain>testing/security</domain>
<type>testing</type>
<scope>security_validation</scope>
<complexity>medium</complexity>
<dependencies>integration_tests</dependencies>
<unblocks>22.0</unblocks>
</task_context>

# Tarefa 21.0: Testes de Segurança e Refinamento

## Visão Geral

Implementar testes de segurança para validar que não há vulnerabilidades ou bypass de autenticação/autorização. Inclui testes de tentativas de acesso não autorizado, brute force protection, e validação de policies.

## Requisitos

- [ ] Testes de bypass de autenticação
- [ ] Testes de bypass de autorização
- [ ] Testes de lockout (brute force)
- [ ] Testes de validação de password policy
- [ ] Testes de proteção de master admin
- [ ] Validar métricas de sucesso do PRD

## Testes a Implementar

### 21.1: AuthorizationBypassTests

**Arquivo:** `tests/MathFlow.IntegrationTests/Identity/AuthorizationBypassTests.cs`

```csharp
using FluentAssertions;
using System.Net;

namespace MathFlow.IntegrationTests.Identity;

public class AuthorizationBypassTests : IntegrationTestBase
{
    [Fact]
    public async Task UnauthenticatedUser_CannotAccessManagePages()
    {
        // Act
        var response = await Client.GetAsync("/Identity/Manage/Index");

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.Redirect);
        response.Headers.Location?.ToString().Should().Contain("/Account/Login");
    }

    [Fact]
    public async Task NormalUser_CannotAccessAdminPages()
    {
        // Arrange - Criar e autenticar usuário normal
        // (Simplificado - em implementação real, usar cookies de autenticação)

        // Act
        var response = await Client.GetAsync("/Admin/Users/Index");

        // Assert
        response.StatusCode.Should().BeOneOf(HttpStatusCode.Redirect, HttpStatusCode.Forbidden);
    }

    [Fact]
    public async Task PublicPages_ShouldBeAccessibleWithoutAuth()
    {
        // Act
        var loginResponse = await Client.GetAsync("/Account/Login");
        var registerResponse = await Client.GetAsync("/Account/Register");

        // Assert
        loginResponse.StatusCode.Should().Be(HttpStatusCode.OK);
        registerResponse.StatusCode.Should().Be(HttpStatusCode.OK);
    }
}
```

### 21.2: LockoutTests

**Arquivo:** `tests/MathFlow.IntegrationTests/Identity/LockoutTests.cs`

```csharp
using FluentAssertions;
using Microsoft.AspNetCore.Identity;
using MathFlow.Application.Services.Identity;
using MathFlow.Infrastructure.IdentityServer.Models;

namespace MathFlow.IntegrationTests.Identity;

public class LockoutTests : IntegrationTestBase
{
    [Fact]
    public async Task Login_After5FailedAttempts_ShouldLockout()
    {
        // Arrange
        var userManager = await GetService<UserManager<ApplicationUser>>();
        var userService = await GetService<UserService>();

        var user = new ApplicationUser
        {
            UserName = "lockouttest",
            Email = "lockouttest@example.com",
            LockoutEnabled = true
        };
        await userManager.CreateAsync(user, "Test@1234");

        // Act - 5 tentativas falhadas
        for (int i = 0; i < 5; i++)
        {
            await userService.LoginAsync("lockouttest@example.com", "WrongPassword", false);
        }

        // 6ª tentativa (mesmo com senha correta)
        var result = await userService.LoginAsync("lockouttest@example.com", "Test@1234", false);

        // Assert
        result.IsLockedOut.Should().BeTrue();
    }
}
```

### 21.3: PasswordPolicyTests

**Arquivo:** `tests/MathFlow.IntegrationTests/Identity/PasswordPolicyTests.cs`

```csharp
using FluentAssertions;
using Microsoft.AspNetCore.Identity;
using MathFlow.Infrastructure.IdentityServer.Models;

namespace MathFlow.IntegrationTests.Identity;

public class PasswordPolicyTests : IntegrationTestBase
{
    [Theory]
    [InlineData("short", false)] // Menos de 8 caracteres
    [InlineData("nouppercase1!", false)] // Sem maiúscula
    [InlineData("NoSpecial1", false)] // Sem caractere especial
    [InlineData("Valid@1234", true)] // Válida
    [InlineData("AnotherValid!Pass1", true)] // Válida
    public async Task PasswordPolicy_ShouldEnforceRequirements(string password, bool shouldSucceed)
    {
        // Arrange
        var userManager = await GetService<UserManager<ApplicationUser>>();

        var user = new ApplicationUser
        {
            UserName = $"pwtest{Guid.NewGuid()}",
            Email = $"pwtest{Guid.NewGuid()}@example.com"
        };

        // Act
        var result = await userManager.CreateAsync(user, password);

        // Assert
        result.Succeeded.Should().Be(shouldSucceed);
    }
}
```

### 21.4: MasterAdminProtectionTests

**Arquivo:** `tests/MathFlow.IntegrationTests/Identity/MasterAdminProtectionTests.cs`

```csharp
using FluentAssertions;
using Microsoft.AspNetCore.Identity;
using MathFlow.Application.Services.Identity;
using MathFlow.Infrastructure.IdentityServer.Models;

namespace MathFlow.IntegrationTests.Identity;

public class MasterAdminProtectionTests : IntegrationTestBase
{
    [Fact]
    public async Task MasterAdmin_ShouldNotHave2FAEnabled()
    {
        // Arrange
        var userManager = await GetService<UserManager<ApplicationUser>>();

        // Act
        var masterAdmin = await userManager.FindByEmailAsync("admin@mathflow.local");

        // Assert
        masterAdmin.Should().NotBeNull();
        masterAdmin!.TwoFactorEnabled.Should().BeFalse();
    }

    [Fact]
    public async Task AssignRole_ShouldNotRemoveMasterAdminRole()
    {
        // Arrange
        var userManager = await GetService<UserManager<ApplicationUser>>();
        var roleService = await GetService<RoleService>();

        var masterAdmin = await userManager.FindByEmailAsync("admin@mathflow.local");

        // Act
        var result = await roleService.AssignRoleAsync(masterAdmin!.Id, "admin");

        // Assert
        result.Succeeded.Should().BeTrue();
        var roles = await userManager.GetRolesAsync(masterAdmin);
        roles.Should().Contain("masterAdmin");
        roles.Should().Contain("admin");
    }
}
```

### 21.5: Validar Métricas de Sucesso (PRD)

**Checklist manual:**
- [ ] Tempo de registro completo (com 2FA) < 2 minutos
- [ ] Tempo de login (com 2FA) < 30 segundos
- [ ] Taxa de sucesso de autenticação > 99%
- [ ] Zero vulnerabilidades críticas
- [ ] 100% cobertura em fluxos críticos

## Sequenciamento

- **Bloqueado por:** 20.0 (Testes de Integração)
- **Desbloqueia:** 22.0 (Documentação)
- **Paralelizável com:** Nenhum (validação final)

## Critérios de Aceitação

- [ ] 8+ testes de segurança implementados
- [ ] Todos os testes passando
- [ ] Nenhuma vulnerabilidade encontrada
- [ ] Métricas do PRD validadas
- [ ] Relatório de segurança gerado

## Estimativa

**Tempo estimado:** 1 dia (8 horas)
